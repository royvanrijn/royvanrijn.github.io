<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>royvanrijn  | Java, algorithms, math, science and more!</title>
  <meta name="description" content="Java, algorithms, math, science and more!">
  
  <meta name="keywords" content="royvanrijn, programming, java, blog, devoxx, conference, speaker, technology, science, math, azspcs, tips, tricks" />
  
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://royvanrijn.com/page/8/">
  <link rel="alternate" type="application/rss+xml" title="royvanrijn" href="http://royvanrijn.com/feed/" />


<script>
  <!-- Google Analytics -->
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3219266-1', 'auto');
  ga('send', 'pageview');

  <!-- Disqus Comment Count -->
  var disqus_shortname = 'royvanrijn';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

	<a class="site-title" href="/">
	  <img src="/images/header_royvanrijn.jpg" alt="royvanrijn" />
    </a>

    <nav class="site-nav">

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

  <hr/>
  <!-- This loops through the paginated posts -->
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/06/creating-shazam-in-java/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jun 1, 2010 01:43:08
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/creating-shazam-in-java/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/06/creating-shazam-in-java/">Creating Shazam in Java</a></h1>


        <p>A couple of days ago I encountered this article: <a href="http://laplacian.wordpress.com/2009/01/10/how-shazam-works/">How Shazam Works</a></p>

<p>This got me interested in how a program like Shazam works… And more importantly, how hard is it to program something similar in Java?</p>

<h1 id="about-shazam">About Shazam</h1>

<p>Shazam is an application which you can use to analyse/match music. When you install it on your phone, and hold the microphone to some music for about 20 to 30 seconds, it will tell you which song it is.</p>

<p>When I first used it it gave me a magical feeling. “How did it do that!?”. And even today, after using it a lot, it still has a bit of magical feel to it.<br />
Wouldn’t it be great if we can program something of our own that gives that same feeling? That was my goal for the past weekend.</p>

<h1 id="listen-up">Listen up..!</h1>

<p>First things first, get the music sample to analyse we first need to listen to the microphone in our Java application…! This is something I hadn’t done yet in Java, so I had no idea how hard this was going to be.</p>

<p>But it turned out it was very easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">AudioFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="n">getFormat</span><span class="o">();</span> <span class="c1">//Fill AudioFormat with the wanted settings</span>
<span class="n">DataLine</span><span class="o">.</span><span class="na">Info</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataLine</span><span class="o">.</span><span class="na">Info</span><span class="o">(</span><span class="n">TargetDataLine</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">format</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">TargetDataLine</span> <span class="n">line</span> <span class="o">=</span> <span class="o">(</span><span class="n">TargetDataLine</span><span class="o">)</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="na">getLine</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
<span class="n">line</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">format</span><span class="o">);</span>
<span class="n">line</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre></figure>

<p>Now we can read the data from the TargetDataLine just like a normal InputStream:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// In another thread I start:</span>

<span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
<span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;I/O problems: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Using this method it is easy to open the microphone and record all the sounds! The AudioFormat I’m currently using is:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">AudioFormat</span> <span class="nf">getFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">float</span> <span class="n">sampleRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">sampleSizeInBits</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">//mono</span>
    <span class="kt">boolean</span> <span class="n">signed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">bigEndian</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">AudioFormat</span><span class="o">(</span><span class="n">sampleRate</span><span class="o">,</span> <span class="n">sampleSizeInBits</span><span class="o">,</span> <span class="n">channels</span><span class="o">,</span> <span class="n">signed</span><span class="o">,</span> <span class="n">bigEndian</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>So, now we have the recorded data in a ByteArrayOutputStream, great! Step 1 complete.</p>

<h1 id="microphone-data">Microphone data</h1>

<p>The next challenge is analyzing the data, when I outputted the data I received in my byte array I got a long list of numbers, like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0
0
1
2
4
7
6
3
-1
-2
-4
-2
-5
-7
-8
(etc)</code></pre></figure>

<p>Erhm… yes? This is sound?</p>

<p>To see if the data could be visualized I took the output and placed it in Open Office to generate a line graph:</p>

<p><a href="/images/graph.png"><img src="/images/graph-300x248.png" alt="graph" /></a></p>

<p>Ah yes! This kind of looks like ‘sound’. It looks like what you see when using for example Windows Sound Recorder.</p>

<p>This data is actually known as <a href="http://en.wikipedia.org/wiki/Time_domain">time domain</a>. But these numbers are currently basically useless to us… if you read the above article on how Shazam works you’ll read that they use a <a href="http://en.wikipedia.org/wiki/Spectrum_analyzer">spectrum analysis</a> instead of direct time domain data.<br />
So the next big question is: How do we transform the current data into a spectrum analysis?</p>

<h1 id="discrete-fourier-transform">Discrete Fourier transform</h1>

<p>To turn our data into usable data we need to apply the so called <a href="http://en.wikipedia.org/wiki/Discrete_Fourier_transform">Discrete Fourier Transformation</a>. This turns the data from time domain into frequency domain.<br />
There is just one problem, if you transform the data into the frequency domain you loose every bit of information regarding time. So you’ll know what the magnitude of all the frequencies are, but you have no idea when they appear.</p>

<p>To solve this we need a sliding window. We take chunks of data (in my case 4096 bytes of data) and transform just this bit of information. Then we know the magnitude of all frequencies that occur during just these 4096 bytes.</p>

<h1 id="implementing-this">Implementing this</h1>

<p>Instead of worrying about the Fourier Transformation I googled a bit and found code for the so called FFT (Fast Fourier Transformation). I’m calling this code with the chunks:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">byte</span> <span class="n">audio</span><span class="o">[]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>

<span class="kd">final</span> <span class="kt">int</span> <span class="n">totalSize</span> <span class="o">=</span> <span class="n">audio</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">amountPossible</span> <span class="o">=</span> <span class="n">totalSize</span><span class="o">/</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">;</span>

<span class="c1">//When turning into frequency domain we&#39;ll need complex numbers:</span>
<span class="n">Complex</span><span class="o">[][]</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Complex</span><span class="o">[</span><span class="n">amountPossible</span><span class="o">][];</span>

<span class="c1">//For all the chunks:</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">amountPossible</span><span class="o">;</span> <span class="n">times</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">Complex</span><span class="o">[]</span> <span class="n">complex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Complex</span><span class="o">[</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">];</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">//Put the time domain data into a complex number with imaginary part as 0:</span>
        <span class="n">complex</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Complex</span><span class="o">(</span><span class="n">audio</span><span class="o">[(</span><span class="n">times</span><span class="o">*</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">)+</span><span class="n">i</span><span class="o">],</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//Perform FFT analysis on the chunk:</span>
    <span class="n">results</span><span class="o">[</span><span class="n">times</span><span class="o">]</span> <span class="o">=</span> <span class="n">FFT</span><span class="o">.</span><span class="na">fft</span><span class="o">(</span><span class="n">complex</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//Done!</span></code></pre></figure>

<p>Now we have a double array containing all chunks as Complex[]. This array contains data about all frequencies. To visualize this data I decided to implement a full spectrum analyzer (just to make sure I got the math right).<br />
To show the data I hacked this together:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">results</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">line</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">// To get the magnitude of the sound at a given frequency slice</span>
        <span class="c1">// get the abs() from the complex number.</span>
        <span class="c1">// In this case I use Math.log to get a more managable number (used for color)</span>
        <span class="kt">double</span> <span class="n">magnitude</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">freq</span><span class="o">].</span><span class="na">abs</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>

        <span class="c1">// The more blue in the color the more intensity for a given frequency point:</span>
        <span class="n">g2d</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="k">new</span> <span class="nf">Color</span><span class="o">(</span><span class="mi">0</span><span class="o">,(</span><span class="kt">int</span><span class="o">)</span><span class="n">magnitude</span><span class="o">*</span><span class="mi">10</span><span class="o">,(</span><span class="kt">int</span><span class="o">)</span><span class="n">magnitude</span><span class="o">*</span><span class="mi">20</span><span class="o">));</span>
        <span class="c1">// Fill:</span>
        <span class="n">g2d</span><span class="o">.</span><span class="na">fillRect</span><span class="o">(</span><span class="n">i</span><span class="o">*</span><span class="n">blockSizeX</span><span class="o">,</span> <span class="o">(</span><span class="n">size</span><span class="o">-</span><span class="n">line</span><span class="o">)*</span><span class="n">blockSizeY</span><span class="o">,</span><span class="n">blockSizeX</span><span class="o">,</span><span class="n">blockSizeY</span><span class="o">);</span>
		
        <span class="c1">// I used a improviced logarithmic scale and normal scale:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logModeEnabled</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">)</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">freq</span> <span class="o">+=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">)</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">freq</span><span class="o">++;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h1 id="introducing-aphex-twin">Introducing, Aphex Twin</h1>

<p>This seems a bit of OT (off-topic), but I’d like to tell you about a electronic musician called Aphex Twin (Richard David James). He makes crazy electronic music… but some songs have an interesting feature. His biggest hit for example, <a href="http://en.wikipedia.org/wiki/Windowlicker">Windowlicker</a> has a spectrogram image in it.<br />
If you look at the song as spectral image it shows a nice spiral. Another song, called ‘Mathematical Equation’ shows the face of Twin! More information can be found here: <a href="http://www.bastwood.com/aphex.php">Bastwood - Aphex Twin’s face</a>.</p>

<p>When running this song against my spectral analyzer I get the following result:</p>

<p><a href="/images/face.png"><img src="/images/face-299x300.png" alt="face" /></a></p>

<p>Not perfect, but it seems to be Twin’s face!</p>

<h1 id="determining-the-key-music-points">Determining the key music points</h1>

<p>The next step in Shazam’s algorithm is to determine some key points in the song, save those points as a hash and then try to match on them against their database of over 8 million songs. This is done for speed, the lookup of a hash is O(1) speed. That explains a lot of the awesome performance of Shazam!</p>

<p>Because I wanted to have everything working in one weekend (this is my maximum attention span sadly enough, then I need a new project to work on) I kept my algorithm as simple as possible. And to my surprise it worked.</p>

<p>For each line the in spectrum analysis I take the points with the highest magnitude from certain ranges. In my case: 40-80, 80-120, 120-180, 180-300.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//For every line of data:</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">LOWER_LIMIT</span><span class="o">;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">UPPER_LIMIT</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">freq</span><span class="o">++)</span> <span class="o">{</span>
    <span class="c1">//Get the magnitude:</span>
    <span class="kt">double</span> <span class="n">mag</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">freq</span><span class="o">].</span><span class="na">abs</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>

    <span class="c1">//Find out which range we are in:</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">getIndex</span><span class="o">(</span><span class="n">freq</span><span class="o">);</span>

    <span class="c1">//Save the highest magnitude and corresponding frequency:</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mag</span> <span class="o">&gt;</span> <span class="n">highscores</span><span class="o">[</span><span class="n">index</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">highscores</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">mag</span><span class="o">;</span>
        <span class="n">recordPoints</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">freq</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//Write the points to a file:</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AMOUNT_OF_POINTS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">fw</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">recordPoints</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;\t&quot;</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">fw</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>

<span class="c1">// ... snip ...</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">RANGE</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="o">{</span><span class="mi">40</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">120</span><span class="o">,</span><span class="mi">180</span><span class="o">,</span> <span class="n">UPPER_LIMIT</span><span class="o">+</span><span class="mi">1</span><span class="o">};</span>

<span class="c1">//Find out in which range</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">freq</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span><span class="o">(</span><span class="n">RANGE</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">)</span> <span class="n">i</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>When we record a song now, we get a list of numbers such as:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">33	56	99	121	195	
30	41	84	146	199	
33	51	99	133	183	
33	47	94	137	193	
32	41	106	161	191	
33	76	95	123	185	
40	68	110	134	232	
30	62	88	125	194	
34	57	83	121	182	
34	42	89	123	182	
33	56	99	121	195	
30	41	84	146	199	
33	51	99	133	183	
33	47	94	137	193	
32	41	106	161	191	
33	76	95	123	185</code></pre></figure>

<p>If I record a song and look at it visually it looks like this:</p>

<p><a href="/images/points.png"><img src="/images/points-228x300.png" alt="points" /></a><br />
(all the red dots are ‘important points’)</p>

<h1 id="indexing-my-own-music">Indexing my own music</h1>

<p>With this algorithm in place I decided to index all my 3000 songs. Instead of using the microphone you can just open mp3 files, convert them to the correct format, and read them the same way we did with the microphone, using an AudioInputStream. Converting stereo music into mono-channel audio was a bit trickier then I hoped. Examples can be found online (requires a bit too much code to paste here) have to change the sampling a bit.</p>

<h1 id="matching">Matching!</h1>

<p>The most important part of the program is the matching process. Reading Shazams paper they use hashing to get matches and the decide which song was the best match.</p>

<p>Instead of using difficult point-groupings in time I decided to use a line of our data (for example “33, 47, 94, 137”) as one hash: 1370944733<br />
(in my tests using 3 or 4 points works best, but tweaking is difficult, I need to re-index my mp3 every time!)</p>

<p>Example hash-code using 4 points per line:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Using a little bit of error-correction, damping</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FUZ_FACTOR</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

<span class="kd">private</span> <span class="kt">long</span> <span class="nf">hash</span><span class="o">(</span><span class="n">String</span> <span class="n">line</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">p</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\t&quot;</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
    <span class="k">return</span>  <span class="o">(</span><span class="n">p4</span><span class="o">-(</span><span class="n">p4</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100000000</span> <span class="o">+</span> <span class="o">(</span><span class="n">p3</span><span class="o">-(</span><span class="n">p3</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100000</span> <span class="o">+</span> <span class="o">(</span><span class="n">p2</span><span class="o">-(</span><span class="n">p2</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="o">(</span><span class="n">p1</span><span class="o">-(</span><span class="n">p1</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">));</span>
<span class="o">}</span></code></pre></figure>

<p>Now I create two data sets:</p>

<p>- A list of songs, List<string> (List index is Song-ID, String is songname)  
\- Database of hashes: Map&lt;Long, List<datapoint>&gt;</datapoint></string></p>

<p>The long in the database of hashes represents the hash itself, and it has a bucket of DataPoints.</p>

<p>A DataPoint looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">DataPoint</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">time</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">songId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DataPoint</span><span class="o">(</span><span class="kt">int</span> <span class="n">songId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">songId</span> <span class="o">=</span> <span class="n">songId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
    <span class="o">}</span>
	
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSongId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">songId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now we already have everything in place to do a lookup. First I read all the songs and generate hashes for each point of data. This is put into the hash-database.<br />
The second step is reading the data of the song we need to match. These hashes are retrieved and we look at the matching datapoints.</p>

<p>There is just one problem, for each hash there are some hits, but how do we determine which song is the correct song..? Looking at the amount of matches? No, this doesn’t work…<br />
The most important thing is timing. We must overlap the timing…! But how can we do this if we don’t know where we are in the song? After all, we could just as easily have recorded the final chords of the song.</p>

<p>By looking at the data I discovered something interesting, because we have the following data:</p>

<p>- A hash of the recording<br />
- A matching hash of the possible match<br />
- A song ID of the possible match<br />
- The current time in our own recording<br />
- The time of the hash in the possible match</p>

<p>Now we can substract the current time in our recording (for example, line 34) with the time of the hash-match (for example, line 1352). This difference is stored together with the song ID. Because this offset, this difference, tells us where we possibly could be in the song.<br />
When we have gone through all the hashes from our recording we are left with a lot of song id’s and offsets. The cool thing is, if you have a lot of hashes with matching offsets, you’ve found your song.</p>

<h1 id="the-results">The results</h1>

<p>For example, when listening to The Kooks - Match Box for just 20 seconds, this is the output of my program:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Done loading: 2921 songs

Start matching song...

Top 20 matches:

01: 08_the_kooks_-_match_box.mp3 with 16 matches.
02: 04 Racoon - Smoothly.mp3 with 8 matches.
03: 05 Röyksopp - Poor Leno.mp3 with 7 matches.
04: 07_athlete_-_yesterday_threw_everyting_a_me.mp3 with 7 matches.
05: Flogging Molly - WMH - Dont Let Me Dia Still Wonderin.mp3 with 7 matches.
06: coldplay - 04 - sparks.mp3 with 7 matches.
07: Coldplay - Help Is Round The Corner (yellow b-side).mp3 with 7 matches.
08: the arcade fire - 09 - rebellion (lies).mp3 with 7 matches.
09: 01-coldplay-_clocks.mp3 with 6 matches.
10: 02 Scared Tonight.mp3 with 6 matches.
11: 02-radiohead-pyramid_song-ksi.mp3 with 6 matches.
12: 03 Shadows Fall.mp3 with 6 matches.
13: 04 Röyksopp - In Space.mp3 with 6 matches.
14: 04 Track04.mp3 with 6 matches.
15: 05 - Dress Up In You.mp3 with 6 matches.
16: 05 Supergrass - Can&#39;t Get Up.mp3 with 6 matches.
17: 05 Track05.mp3 with 6 matches.
18: 05The Fox In The Snow.mp3 with 6 matches.
19: 05_athlete_-_wires.mp3 with 6 matches.
20: 06 Racoon - Feel Like Flying.mp3 with 6 matches.

Matching took: 259 ms

Final prediction: 08_the_kooks_-_match_box.mp3.song with 16 matches.</code></pre></figure>

<p>It works!!</p>

<p>Listening for 20 seconds it can match almost all the songs I have. And even this <a href="http://www.youtube.com/watch?v=sLR9d4sMcq4">live recording of the Editors</a> could be matched to the correct song after listening 40 seconds!</p>

<p>Again it feels like magic! :-)</p>

<p>Currently, the code isn’t in a releasable state and it doesn’t work perfectly. It has been a pure weekend-hack, more like a proof-of-concept / algorithm exploration.</p>

<p>Maybe, if enough people ask about it, I’ll clean it up and release it somewhere.</p>

<h1 id="update">Update:</h1>

<p>The Shazam patent holders lawyers are sending me emails to stop me from releasing the code and removing this blogpost, read the story <a href="/blog/2010/07/patent-infringement/">here</a>.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/creating-shazam-in-java/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/04/playing-around-with-html-5/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Apr 14, 2010 12:45:43
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/playing-around-with-html-5/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/04/playing-around-with-html-5/">Playing around with HTML 5</a></h1>


        <p>Yesterday, while browsing DZone, I encountered a couple of HTML 5 blogs. So I decided to try and code some HTML5 - Canvas myself.</p>

<p>This is the result of one hour trail-and-error:  </p>

<p><strong>Sorry, no <canvas></canvas> support, please upgrade your browser!</strong>  </p>

<p>Maybe I’ll do a write-up soon, but for now, just check the sources. (Yes they are wrong/hack-ish, I know…).</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/playing-around-with-html-5/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/04/some-of-my-software-development-rules/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Apr 12, 2010 07:54:31
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/some-of-my-software-development-rules/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/04/some-of-my-software-development-rules/">Some of my software development rules</a></h1>


        <p>Here are (in my opinion) five of the most important ‘rules’ in software development.</p>

<h1 id="changes-happen">Changes happen</h1>

<p>The reason why waterfall doesn’t work and agile works a lot better. Changes happen. People will always change their mind, over time technology changes and situations change. So during software development you will have to be flexible with the requirements.</p>

<h1 id="create-software-that-the-client-wants-not-what-he-says-he-wants">Create software that the client wants, not what he says he wants.</h1>

<p>What the clients tells you he wants might not (entirely) be what he/she actually wants or the organisation needs. It is vital to ask questions and release early. When you have something visible, let the client judge it.<br />
Some people say there is one major drawback of showing designs and the application early on, the client probably gets new ideas and wants to change the design. But that actually is a good thing, you still have much time left to plan these changes! If you do a waterfall-method and release on delivery date.. the client still wants his/her changes (!).</p>

<h1 id="always-write-down-decisions">Always write down decisions.</h1>

<p>During a project, especially during the startup, there are a lot of choices to be made. Is it going to be a web application, or standalone? What frameworks are we going to use?<br />
All these decisions are made with arguments, pro’s and con’s, write those down! A project-wiki would be a perfect place. If some members leave the team and new members join the team this information is vital. When the new members join the team their first reaction will be “Why are they doing it this way and not …?”. Reading the argumentation will help them understand the situation and get them up to speed. Also, during projects there are always moments when you reflect on choices made in the past: “Why did we do … wouldn’t we have done better if we did/used …”. You can now always review the past arguments to see if the current situation has changed so much that a reconsideration would be in order or not.</p>

<h1 id="the-team-owns-the-code">The team owns the code.</h1>

<p>If you write a piece of code, it is not your code. The code belongs to the collective, the team. If somebody changes your code, embrace it, it was probably needed. If you see an ugly piece of code you didn’t write, you are also responsible, refactor it.</p>

<h1 id="commit-driven-development">Commit driven development.</h1>

<p>Test driven development is a great idea. First write a unit-test, check to see if it fails, now write your code until the test succeeds. This way you know two important things, the final code is easy to test (it was written with testing in mind) and the code does what the test expects. But there is one major drawback, most people (not all) simply can’t work this way. For some people it works great, but some developers want to write their tests afterwards. And that is ok, there is just one important rule: Never check your code in (the trunk) if it isn’t tested and doesn’t have proper documentation (e.g. JavaDoc). So: It is no problem if you write code and then tests, or tests then the code, as long as you write them before commiting to your SCM repository.</p>

<p>There are situations when you need to write a lot of new code, in that case you still want to be able to check your code in, even if you aren’t done yet. For these situations you create a feature-branch. On this branch you develop all the new funtionality and once it is done, documented and tested, merge it with the trunk.</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/some-of-my-software-development-rules/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/02/compression-by-prediction/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Feb 17, 2010 10:39:23
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/02/compression-by-prediction/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/02/compression-by-prediction/">Compression by prediction</a></h1>


        <p>The last couple of weeks I have been playing around with compression/decompression algorithms. This is a field that has always intrigued me. It gives me a magical feeling, like a magician you wave some algorithm around and suddenly the files shrink and bytes dissapear. With the same motion you can undo all your actions and re-generate the original files from thin air!</p>

<h1 id="arithmetic-coding">Arithmetic Coding</h1>

<p>Arithmetic coding is a different method to encode bytes. On itself it doesn’t compress, but it is the backbone of a whole family of compression algorithms. To explain how it works we need some example text we want to compress: “ABACB”</p>

<p>First we assign a probability to each symbol:</p>

<ul>
  <li>A: 45%</li>
  <li>B: 40%</li>
  <li>C: 15%</li>
</ul>

<p>Lets change these probabilities into ranges from 0.0 to 1.0:</p>

<ul>
  <li>A: 0.00 to 0.45</li>
  <li>B: 0.45 to 0.85</li>
  <li>C: 0.85 to 1.00</li>
</ul>

<p>Now we start reading our input (ABACB). The first character we find is ‘A’. First we do a lookup in the table, what range does ‘A’ have: 0.00 to 0.45. Lets remember these values as ‘low’ and ‘high’.</p>

<p>Time to encode the second character ‘B’. The first thing we need to do is reset our ranges to be between low and high:</p>

<ul>
  <li>A: 0.0000 to 0.2025</li>
  <li>B: 0.2025 to 0.3805</li>
  <li>C: 0.3805 to 0.4500</li>
</ul>

<p>We want to encode ‘B’, so we’ll end up with low=0.2025 and high=0.3805. Time to update the table again:</p>

<ul>
  <li>A: 0.2025 to 0.2826</li>
  <li>B: 0.2826 to 0.3538</li>
  <li>C: 0.3538 to 0.3805</li>
</ul>

<p>Encode ‘A’, we get low=0.2025 and high=0.2826. And adjust the table again:</p>

<ul>
  <li>A: 0.202500 to 0.238545</li>
  <li>B: 0.238545 to 0.270585</li>
  <li>C: 0.270585 to 0.282600</li>
</ul>

<p>Encode ‘C’, we get low=0.270585 and high=0.282600. Adjust the table one last time:</p>

<ul>
  <li>A: 0.27058500 to 0.27599175</li>
  <li>B: 0.27599175 to 0.28079775</li>
  <li>C: 0.28079775 to 0.28260000</li>
</ul>

<p>So, lets encode the final symbol ‘B’ and stop right here. Now we save/output a value betwee low (0.27599175) and high (0.28079775) which takes the least amount of bytes, for example 0.28!</p>

<p>Now I we want to decode our message “0.28” we start by building the ranges again, these are the same as the first table above. Now we look at which range our 0.28 fall in. The result is ‘A’ (between 0.0 and 0.45). So we output this symbol. Next we have to update the table, because we outputted ‘A’ we know our encoder encoded ‘A’, so we can follow the same steps as the encoder did and update the ranges in the same way, so we’ll end up with the second table (with values between 0.0 and 0.45). If we look at 0.28 it now falls into range ‘B’, so we output ‘B’ and adjust again.</p>

<p>As you can see this number “0.28” describes our whole message “ABACB”! So we encoded a whole message in one small number. There are a lot of improvements possible to implement this algorithm efficiently, for example look at <a href="http://en.wikipedia.org/wiki/Range_encoding">range encoding</a>. Another website that helped me a lot is this <a href="http://www.arturocampos.com/ac_arithmetic.html">basic arithmetic coding</a> by Arturo Campos.</p>

<h1 id="prediction">Prediction</h1>

<p>The previous example works great, but there is a problem… if we assign equal probabilities to each possible symbol (each byte) we won’t compress anything! The example above works because I took bigger probabilities for A and B then for C… So for it to work we need to guess the correct probabilities, and the better we do this, the smaller our file gets! Luckely there are a couple of methods to assign/guess these probabilities.</p>

<h2 id="read-and-save-table">Read and save table</h2>

<p>One thing you can do is to first read the whole file and save the amount you see each character. Then you can scale these amounts into probabilities between 0.0 and 1.0 and save these probabilities to a file. Next we can use these probabilities to encode (and decode) our message! This will take quite a bit of overhead because you have to save the table..</p>

<h2 id="runtime-adjustment">Runtime adjustment</h2>

<p>Another thing we can do is to just start with equal probabilities for each symbol and adjust the probabilities during the encoding. If we use the same method in encoding and decoding our probability table will remain the same.</p>

<h2 id="prediction-by-partial-matching-ppm">Prediction by Partial Matching (PPM)</h2>

<p>So, we can adjust the probabilities at runtime and for example count all the symbols we have seen. But why stop there? For example in a piece of English text, the letter ‘E’ will probably have the highest count/probabilty. But if we encouter the symbols: “COMPRESSI” we know the next character will likely be an “O”, not an “E”! So what if we can enlarge our context? This is what PPM does, looking at the bigger picture. Not only count single symbols, but also combinations. The longer the combinations the more specific our predictions get (but also more memory is needed).</p>

<h2 id="context-mixing-cm">Context Mixing (CM)</h2>

<p>With PPM you have one model which predicts the probability of the next symbol by looking at its past statistics. But why stop there? With Context Mixing (CM) you can have multiple models predicting the next symbol work together. When you do this right you and predict the next symbol even better and thus get better compression ratios! This is how the best current compression algorithms work.</p>

<h1 id="other-methods">Other methods</h1>

<p>This is just one family of compression algorithms, there are a lot more which I won’t describe here (yet?). Instead of processing/guessing the next symbol you could also replace long series of symbols with shorter unique symbols. This is known as <a href="http://en.wikipedia.org/wiki/Dictionary_coder">dictionary coding</a>, an entire other family of compressors (including <a href="http://en.wikipedia.org/wiki/LZ77_and_LZ78">LZ, zip, gz</a>).</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/02/compression-by-prediction/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/02/handling-null-in-java/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Feb 1, 2010 11:46:13
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/02/handling-null-in-java/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/02/handling-null-in-java/">Handling null in Java</a></h1>


        <p>Its a problem I encouter in most JEE projects I’ve worked on so far. Handling null-values. But why is this a problem? And what strategies can we follow to reduce the problem? That is what I’m trying to find out in this post.</p>

<p>Lets start with a piece of business logic, in a world where we don’t have null-values:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBalance</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">();</span>
    <span class="n">BigDecimal</span> <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">Account</span> <span class="nl">account:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">totalBalance</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">totalBalance</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>This looks good and understandable! But this isn’t what I see in most projects. Usually I see code like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBalance</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">();</span>
	    <span class="k">if</span><span class="o">(</span><span class="n">accounts</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    	<span class="n">BigDecimal</span> <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
	    	<span class="k">for</span><span class="o">(</span><span class="n">Account</span> <span class="nl">account:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
	    		<span class="k">if</span><span class="o">(</span><span class="n">account</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    			<span class="n">totalBalance</span> <span class="o">=</span> <span class="n">totalBalance</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">());</span>
	    		<span class="o">}</span>
	    	<span class="o">}</span>
	    <span class="o">}</span>
	    <span class="k">return</span> <span class="n">totalBalance</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Wow, that is not a pretty sight, not at all! What can we do about it and how did it happen?</p>

<h1 id="inversion-of-logic">Inversion of logic</h1>

<p>The first strategy we can follow is based on <a href="/blog/2009/12/inversion_of_logic/">inversion of logic</a> which I’ve blogged about before. The idea is that we exit early, this will improve the readability of our method. Lets see that happens to our method is we follow this pattern:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBalance</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">Set</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">();</span>
   	<span class="n">BigDecimal</span> <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
   	<span class="k">for</span><span class="o">(</span><span class="n">Account</span> <span class="nl">account:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
   		<span class="k">if</span><span class="o">(</span><span class="n">account</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
   			<span class="n">totalBalance</span> <span class="o">=</span> <span class="n">totalBalance</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">());</span>
   		<span class="o">}</span>
   	<span class="o">}</span>
	<span class="k">return</span> <span class="n">totalBalance</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>This is somewhat better, a bit shorter, but we still have all the ‘!= null’ and ‘== null’ checks we don’t want.</p>

<h1 id="code-by-contract">Code by contract</h1>

<p>The best way to get rid of null-checks is to get rid of nulls in your applicaties. Just don’t return a null in all of the methods…! This sounds very easy and straight forward, but it is a bit harder then it sounds because it has become such a habbit.</p>

<p>The good thing is that current IDE’s are implementing the @NotNull and @Nullable annotations. With these annotations you can tell other programmers, your IDE and static code analysis tools what your idea was when creating a method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="n">Person</span> <span class="nf">getPerson</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">something</span><span class="o">.</span><span class="na">retrievePerson</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
    

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">printPersonName</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">getPerson</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
	<span class="c1">//Causes warning: getPerson is Nullable, thus this is a possible NPE! </span>
<span class="o">}</span></code></pre></figure>

<p>It also helps you to clearly state your assumed preconditions:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">printPersonName</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
	<span class="c1">//Very good, we know we won&#39;t get a NPE here! </span>
<span class="o">}</span>
    
    
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeThis</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="n">printPersonName</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
	<span class="c1">//Causes warning: person might be null, thus can cause a NPE!</span>
	<span class="c1">//Code analysis tools and/or IDE will warn you about this.</span>
<span class="o">}</span></code></pre></figure>

<p>It will also help you correct possible coding errors:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@NotNull</span>
<span class="kd">public</span> <span class="n">Person</span> <span class="nf">getPersonFromDatabase</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">//Use JPQL</span>
	<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">&quot;SELECT p FROM Person p WHERE p.id = :value&quot;</span><span class="o">);</span>
	<span class="n">q</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
	<span class="c1">//The IDE will complain about this. </span>
	<span class="c1">//The database might return null, we don&#39;t allow returning null in this method.</span>
<span class="o">}</span></code></pre></figure>

<p>Using this method you have some more certainties. But it isn’t a silver-bullet on its own. We have to stop and think, where do the null-values come from?</p>

<p>Actually, when you stop returning null (which is entirely up to you and your team) there are still situations which are ‘unchecked’. Namely external API’s, frameworks, the ORM-mapper you are using. So everywhere where you execute methods that you haven’t written, you still have to do manual checks. But make sure you do this right away. Then further on in the code, you don’t have to check anything because of your @NotNull-contracts.<br />
If you do this to the Person object above, and all its fields, you will end up with the beautiful clean code of the first example. No checks, its just always filled by contract. The only thing you want to add is information about the parameters:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@NotNull</span>
<span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBalance</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">();</span>
    <span class="n">BigDecimal</span> <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">Account</span> <span class="nl">account:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">totalBalance</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">totalBalance</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>In my experience this works very well, I’ve done this a couple of times, even before the @NotNull and @Nullable existed. Before this we would just add the information in our Javadoc. But with the IDE checking for it this has become a lot easier to use.</p>

<h1 id="null-object-pattern">Null object pattern</h1>

<p>A whole different approach then coding-by-contract is the use of a null-object. The idea behind this pattern is that you don’t return null, but instead you return a real object. In our example we would do the following:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Person</span> <span class="o">{</span>

	<span class="n">String</span> <span class="nf">getName</span><span class="o">();</span>
	<span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>

	<span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">();</span>
	
	<span class="c1">//..etc..</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NullPerson</span> <span class="kd">implements</span> <span class="n">Person</span> <span class="o">{</span>
	
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{}</span>

	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The huge advantage is that you can always safely call “person.getName()” and “person.getAccounts()” because even if you have a NullPerson the object still exists. This Null-Object is obviously usually a <a href="http://en.wikipedia.org/wiki/Singleton_pattern">singleton</a>.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBalance</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">();</span>
                <span class="c1">//NullPerson returns empty list, no more NPE!</span>
    <span class="n">BigDecimal</span> <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">Account</span> <span class="nl">account:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">totalBalance</span> <span class="o">=</span> <span class="n">totalBalance</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">totalBalance</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>A more elaborate but general version of this pattern is the <a href="http://martinfowler.com/eaaCatalog/specialCase.html">special case pattern</a>, named by Martin Fowler. Instead of just having a Null-special case you could also develop:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnknownPerson</span> <span class="kd">implements</span> <span class="n">Person</span> <span class="o">{</span>
	
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{}</span>

	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
	<span class="o">}</span>

<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InvalidatedPerson</span> <span class="kd">implements</span> <span class="n">Person</span> <span class="o">{</span>
	
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{}</span>

	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now you can return much more information then just a meaningless “null”!</p>

<p>There is just one problem with this pattern. It also doesn’t just solve your problems. Why do we want to calculate the total balance of a NullPerson? The moment you retrieve a person and it is an instance of NullPerson, catch it and handle the situation appropiatly, don’t just continue.</p>

<h1 id="safe-null-operator">Safe null operator</h1>

<p>For a time there was speculation that the Safe-null-operator would make its way into Java 7 through Project Coin. If you’ve programmed in Groovy you might have seen it before:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="nf">getFirstLetterOfName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">person</span><span class="o">?.</span><span class="na">getName</span><span class="o">()?.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>The idea is that you use “?.” instead of “.”. The questionmark means: “If the variable we’re calling is null, the result is null, else, call the next method”.</p>

<p>So in this case:</p>

<ul>
  <li>If person is null: return null, else:</li>
  <li>If getName() is null: return null, else:</li>
  <li>Return result of substring(0, 1)</li>
</ul>

<p>If you would now write this code it would be:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="nf">getFirstLetterOfName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">if</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>You could also give a default value:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">printName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">?.</span><span class="na">getName</span><span class="o">()</span> <span class="o">?:</span> <span class="s">&quot;Anonymous&quot;</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>If person or getName() produce a null the “?:” operator will return the default String.</p>

<p>Sounds pretty good eh? The only problem is that this new operator didn’t make the final list of changes for Java 7.</p>

<p>Fun fact: Do you know why the “?:”-operator is called the “Elvis”-operator? When viewed from the side, as smiley , it looks like Elvis. Including the big curl in his hair.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/02/handling-null-in-java/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/placement-of-circle-over-points/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 27, 2010 15:02:57
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/placement-of-circle-over-points/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/placement-of-circle-over-points/">Placement of circle over points</a></h1>


        <p>For the Queue ICPC programming game <a href="http://queue.acm.org/icpc/index.cfm">Capture</a> I ran into a geometrical problem.<br />
While programming my little robot I wanted to have an algorithm calculate this for me:</p>

<ol>
  <li>I have a field with 122 points</li>
  <li>I have a circle of fixed size</li>
</ol>

<p>How do I calculate where to put the circle so it encapsulates the most points?</p>

<p>This is what I came up with, three algorithms:  </p>

<h1 id="algorithm-1-centerpoint">Algorithm #1: Centerpoint</h1>

<p>The first algorithm was created as a test. It doesn’t find the perfect solution, but gives a decent solution.<br />
First I loop over all the points, and I check if there are points located at <strong>CIRCLE_RADIUS</strong> length from our point. This returns a score. The best point has a lot of other points nearby.</p>

<p>This algorithm is very quick, but it has a huge disadvantage, the circle will always have one of our points as center.</p>

<p>It will never yield the perfect solution… In the following picture this algorithm produces the green circle:</p>

<p><a href="/images/clusterCalculations.png"><img src="/images/clusterCalculations.png" alt="Picture of points and three calculated circles" /></a></p>

<h1 id="algorithm-2-heatmap">Algorithm #2: Heatmap</h1>

<p>The next idea I got was based on a heatmap. It is very computer heavy, but it will generate the best solution.</p>

<p>It works like this (psuedocode):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">FIELD_SIZE</span> <span class="o">)</span>
	<span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">FIELD_SIZE</span> <span class="o">)</span>
		<span class="n">Point</span> <span class="n">pixel</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Point</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">);</span>
		<span class="n">pixelScore</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span><span class="o">(</span> <span class="n">Point</span> <span class="nl">point:</span> <span class="n">points</span> <span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span><span class="o">(</span> <span class="n">point</span><span class="o">.</span><span class="na">distance</span><span class="o">(</span><span class="n">pixel</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">CIRCLE_RADIUS</span><span class="o">*</span><span class="mi">2</span> <span class="o">)</span> <span class="o">{</span>
				<span class="n">pixelScore</span><span class="o">++;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The pixel with the best score is used in most circles. Thus, this would need to be the center of our circle!</p>

<p>In the image above you can see the resulting heatmap, and the cyan circle is placed on the best possible pixel.</p>

<p>(In most cases, there are more then one ‘best pixels’, which one you choose doesn’t matter)</p>

<h1 id="algorithm-3-bron-kerbosch-myself">Algorithm #3: Bron-Kerbosch-myself</h1>

<p>The heatmap algorithm, mentioned above, takes a LOT of processing time and is far from the most efficient algorithm. For the Queue ICPC contest there is a time limit for each calculation, and I need it to speed up!</p>

<p>So I started to wonder:</p>

<p>- What do all the points in the perfect circle have in common?</p>

<p>Well, they all have a maximum distance to each other of <strong>CIRCLE_RADIUS * 2</strong>.</p>

<p>So I started to play with graph algorithms.</p>

<p>The lines you see in the image above are all the points that can be connected with a maximum length of <strong>CIRCLE_RADIUS * 2</strong>. All the lines show points that could possibly be in the same circle together.<br />
Then I googled a bit and found the term ‘<a href="http://en.wikipedia.org/wiki/Clique_%28graph_theory%29">clique</a>’. A clique is a group of points that all point to each other, just what we want with the graph shown in the picture!</p>

<p>When I searched a little further I came across the <a href="http://en.wikipedia.org/wiki/Bron%E2%80%93Kerbosch_algorithm">Bron-Kerbosch algorithm</a>. It finds the perfect maximum clique for a given undirected graph! Again, just what we want!</p>

<p>Here is the pseudocode (from Wikipedia):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">BronKerbosch1</span><span class="o">(</span><span class="n">R</span><span class="o">,</span><span class="n">P</span><span class="o">,</span><span class="n">X</span><span class="o">):</span>
    <span class="k">if</span> <span class="n">P</span> <span class="n">and</span> <span class="n">X</span> <span class="n">are</span> <span class="n">both</span> <span class="nl">empty:</span>
        <span class="n">report</span> <span class="n">R</span> <span class="n">as</span> <span class="n">a</span> <span class="n">maximal</span> <span class="n">clique</span>
    <span class="k">for</span> <span class="n">each</span> <span class="n">vertex</span> <span class="n">v</span> <span class="n">in</span> <span class="nl">P:</span>
        <span class="n">BronKerbosch1</span><span class="o">(</span><span class="n">R</span> <span class="err">⋃</span> <span class="o">{</span><span class="n">v</span><span class="o">},</span> <span class="n">P</span> <span class="err">⋂</span> <span class="n">N</span><span class="o">(</span><span class="n">v</span><span class="o">),</span> <span class="n">X</span> <span class="err">⋂</span> <span class="n">N</span><span class="o">(</span><span class="n">v</span><span class="o">))</span>
        <span class="n">P</span> <span class="o">:=</span> <span class="n">P</span> <span class="err">\</span> <span class="o">{</span><span class="n">v</span><span class="o">}</span>
        <span class="n">X</span> <span class="o">:=</span> <span class="n">X</span> <span class="err">⋃</span> <span class="o">{</span><span class="n">v</span><span class="o">}</span></code></pre></figure>

<p>But I ran into a little problem, I’d made a false assumption… If you have a triangle of three points, with all legs size N, and then draw a circle from the center… none of the points fall into the circle.</p>

<p><img src="/images/triangleFailure.png" alt="Picture of a circle inside a triangle, where the legs of the triangle are the circle's diameter. This causes all the corners to fall outside the circle." /></p>

<p>Now I tried two ways to solve this, the first one is to use a smaller distance in the graph. If you only select points that are located <strong>(cosine(30) * CIRCLE_RADIUS * 2)</strong> every point will eventually fall into our circle. But this could eliminate the perfect circle obviously if two points in the perfect solution are further apart then <strong>(cosine(30) * CIRCLE_RADIUS * 2)</strong>.</p>

<p>Then I desected the Bron-Kerbosch algorithm, and decided to change it a bit. This is what I ended up with:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">BronKerboschVanRijn</span><span class="o">(</span><span class="n">R</span><span class="o">,</span><span class="n">P</span><span class="o">,</span><span class="n">X</span><span class="o">):</span>
    <span class="k">if</span> <span class="n">P</span> <span class="n">and</span> <span class="n">X</span> <span class="n">are</span> <span class="n">both</span> <span class="nl">empty:</span>
        <span class="n">report</span> <span class="n">R</span> <span class="n">as</span> <span class="n">a</span> <span class="n">maximal</span> <span class="n">clique</span>
    <span class="k">for</span> <span class="n">each</span> <span class="n">vertex</span> <span class="n">v</span> <span class="n">in</span> <span class="nl">P:</span>
        <span class="n">BronKerbosch1</span><span class="o">(</span><span class="n">R</span> <span class="err">⋃</span> <span class="o">{</span><span class="n">v</span><span class="o">},</span> <span class="n">InCircle</span><span class="o">({</span><span class="n">R</span><span class="o">,</span><span class="n">v</span><span class="o">},</span> <span class="n">P</span><span class="o">),</span> <span class="n">InCircle</span><span class="o">({</span><span class="n">R</span><span class="o">,</span><span class="n">v</span><span class="o">},</span> <span class="n">X</span><span class="o">))</span>
        <span class="n">P</span> <span class="o">:=</span> <span class="n">P</span> <span class="err">\</span> <span class="o">{</span><span class="n">v</span><span class="o">}</span>
        <span class="n">X</span> <span class="o">:=</span> <span class="n">X</span> <span class="err">⋃</span> <span class="o">{</span><span class="n">v</span><span class="o">}</span>
        
<span class="n">InCircle</span><span class="o">(</span><span class="n">A</span><span class="o">,</span> <span class="n">B</span><span class="o">):</span>
    <span class="n">calculate</span> <span class="n">minimal</span> <span class="n">enclosing</span> <span class="n">circle</span> <span class="k">for</span> <span class="n">points</span> <span class="n">A</span>
    <span class="k">return</span> <span class="n">all</span> <span class="n">B</span> <span class="n">that</span> <span class="nf">are</span> <span class="o">(</span><span class="n">euclidean</span> <span class="n">distance</span><span class="o">)</span> <span class="n">inside</span> <span class="n">A</span></code></pre></figure>

<p>This returns all the maximal cliques that fall into our circle, and we are always sure they fall into our circle..! I think this will always generate the perfect solution, just as the heat map. In this the above picture, this algorithm produces the red circle.</p>

<p>It already is light years faster then the heat map algorithm, but I still need a bit more speed. I’m still struggling to improve my implementation, like trying to use a pivot as bronKerbosch2 (see wikipedia again) does.</p>

<h1 id="algorithm-4-">Algorithm #4: ???</h1>

<p>For some reason I still fail to believe I’m the first person in the world to tackle this problem. But I haven’t been able to find an algorithm for this. Some people recommended using a <a href="http://en.wikipedia.org/wiki/Sweep_line_algorithm">sweeping algorithm</a> but I don’t understand how this is used to find the circle’s location. Others pointed me to Voronoi maps…</p>

<p>So if you have any suggestions, or know the algorithm I’m looking for, please add a comment :-)</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/placement-of-circle-over-points/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/i-hate-printers/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 27, 2010 12:54:58
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/i-hate-printers/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/i-hate-printers/">I hate printers</a></h1>


        <ol>
  <li>Why, when one color has run out of ink, you can’t print anything!?</li>
  <li>Why does a pencil cost $0,50 and does an ink-cartridge cost $30,-?</li>
  <li>Why does a pencil still work after 5 years and is an ink-cartridge completely dried up?</li>
  <li>Why is a new printer (including ink cartridge) sometimes cheaper then a seperate ink-cartridge (crazy!)</li>
  <li>Why do printers eat paper for lunch?</li>
  <li>Why is printer-software so invasive? What happened to a simple ‘driver’</li>
  <li>Why does most hardware run perfectly under Linux, except printers?</li>
</ol>

<p>Screw this, I’ll just mail my report instead of printing it…</p>

<p>Printer-bashing comic: <a href="http://theoatmeal.com/comics/printers">Why I believe printers were sent from Hell</a></p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/i-hate-printers/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/guess-the-algorithm/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 23, 2010 21:54:24
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/guess-the-algorithm/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/guess-the-algorithm/">Guess the algorithm</a></h1>


        <p>Yesterday I found and programmed a nice little algorithm. I’m not going to tell you (yet) what it does and how its called, but I’ll just show the code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">int</span> <span class="nf">function</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">while</span><span class="o">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">((</span><span class="n">x</span><span class="o">&amp;</span><span class="mi">1</span><span class="o">)==</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">r</span><span class="o">+=</span><span class="n">y</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">x</span><span class="o">&gt;&gt;&gt;=</span><span class="mi">1</span><span class="o">;</span>
		<span class="n">y</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>So tell me, what does this do, and what is the algorithm called?</p>

<p><strong>Edit:</strong></p>

<p>And indeed (it was a simple one) the correct solution is multiplication, and to be specific, Ethiopian or <a href="http://mathworld.wolfram.com/RussianMultiplication.html">Russian Multiplication</a>.</p>

<p>I’ll probably do more, harder ones, in the future..!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/guess-the-algorithm/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/dependency-injection-dissection/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 18, 2010 17:43:08
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/dependency-injection-dissection/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/dependency-injection-dissection/">Learn to use Dependency Injection</a></h1>


        <p>Recently I placed a comment on <a href="http://blog.objectmentor.com/articles/2010/01/17/dependency-injection-inversion">this</a> interesting blog from Uncle Bob Martin (Robert C. Martin). It contains a brief description on how I teach people how to use the Spring Framework.</p>

<p>Now, by popular demand (one person requested it over Twitter), I’ll guide you through the method and examples I use in this blogpost. It explains why people should use frameworks like Spring and/or Google Guice, and how.</p>

<h1 id="ordering-milk">Ordering Milk</h1>

<p>Lets take a look at the application we have. We have a service:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MilkRequestService</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Process a new order.</span>
<span class="cm">	 * @param customer</span>
<span class="cm">	 * @param amountOfBottles</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">);</span>

<span class="o">}</span></code></pre></figure>

<p>And we have a DAO (data access object) which will take care of persisting our order:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MilkDAO</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Save a new order.</span>
<span class="cm">	 * @param customer</span>
<span class="cm">	 * @param amountOfBottles</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>The implementation of this DAO isn’t really interesting, lets just pretent it goes to the database:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkDAODatabaseImpl</span> <span class="kd">implements</span> <span class="n">MilkDAO</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//Puts order in database</span>
	<span class="o">}</span>
	
<span class="o">}</span></code></pre></figure>

<p>And finally we have our service implementation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkRequestServiceImpl</span> <span class="kd">implements</span> <span class="n">MilkRequestService</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MilkDAO</span> <span class="n">milkDAO</span><span class="o">;</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Create a new service:</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">milkDAO</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkDAODatabaseImpl</span><span class="o">(</span>
				<span class="c1">//With SQLConnection or something</span>
				<span class="o">);</span>
	<span class="o">}</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Place a new order for milk.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//Log the order:</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;LOG: Customer &quot;</span> <span class="o">+</span> <span class="n">customer</span> <span class="o">+</span> <span class="s">&quot; wants &quot;</span>
				<span class="o">+</span> <span class="n">amountOfBottles</span> <span class="o">+</span> <span class="s">&quot; bottle&quot;</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">amountOfBottles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">));</span>
		<span class="c1">//Save the order:</span>
		<span class="n">milkDAO</span><span class="o">.</span><span class="na">saveOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Lets pretent that we are good obeying programmers, although we didn’t write our unit test up front, we are going to do it right away.</p>

<p>So… we want to test the service, how are we going to do this? Well, lets just create the service, call it, and then check if it does what we want it to do!</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkRequestServiceTest</span> <span class="o">{</span>

	<span class="n">MilkRequestService</span> <span class="n">milkRequestService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">();</span>
	
	<span class="nd">@Test</span>
	<span class="cm">/**</span>
<span class="cm">	 * Test our milk request service.</span>
<span class="cm">	 * Pre:</span>
<span class="cm">	 * - We have a customer that wants to order 5 bottles of milk</span>
<span class="cm">	 * Post:</span>
<span class="cm">	 * - The milk DAO got a request to save 5 bottles of milk</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProcessOrder</span><span class="o">()</span> <span class="o">{</span>
		
		<span class="kd">final</span> <span class="n">String</span> <span class="n">customer</span> <span class="o">=</span> <span class="s">&quot;testUser&quot;</span><span class="o">;</span>
		<span class="kd">final</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
		
		<span class="n">milkRequestService</span><span class="o">.</span><span class="na">processOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
		
		<span class="c1">//Eeehh.... how do we check the call to the DAO?</span>
		
		<span class="c1">//HELP!!</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We run into a problem rather quickly. Now this code makes a connection to the database and it might or might not save our order. But how do we check this? We could go to the database and check…</p>

<p>NO! Never go to the database in a unit test. We only want to test a single unit of work, and the database ain’t one of them.</p>

<p>We need to refactor our code…!</p>

<h1 id="the-factory">The Factory</h1>

<p>One possible solution to this problem is using a factory method. A factory creates objects so you don’t have to. Its best shown using an example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkFactory</span> <span class="o">{</span> <span class="c1">//no pun intended</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Here we save the mapping:</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapping</span><span class="o">;</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Create the mapping</span>
<span class="cm">	 */</span>
	<span class="kd">static</span> <span class="o">{</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">MilkDAO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nf">MilkDAODatabaseImpl</span><span class="o">());</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">MilkRequestService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nf">MilkDAODatabaseImpl</span><span class="o">());</span>
	<span class="o">}</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Set a mapping by hand.</span>
<span class="cm">	 * Should only be used when unit testing.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param &lt;T&gt;</span>
<span class="cm">	 * @param clazz</span>
<span class="cm">	 * @param impl</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">replaceMapping</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">T</span> <span class="n">impl</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">impl</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Not threadsafe ugly code-monkey code.</span>
<span class="cm">	 * @param &lt;T&gt;</span>
<span class="cm">	 * @param requestedClass</span>
<span class="cm">	 * @return</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">requestedClass</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">requestedClass</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">mapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">requestedClass</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Doesn&#39;t exist&quot;</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>So, lets dissect this.</p>

<p>The method get(class, object) will return an implementation for a given Class. It uses a Map to get the mapping. The map is created during the static initialization (yuk!) and contains the default mapping, but we can also provide our own mapping using replaceMapping(class, object).</p>

<p>Now how do we use it? Lets see our new MilkRequestServiceImpl:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkRequestServiceImpl</span> <span class="kd">implements</span> <span class="n">MilkRequestService</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Place a new order for milk.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//Log the order:</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;LOG: Customer &quot;</span> <span class="o">+</span> <span class="n">customer</span> <span class="o">+</span> <span class="s">&quot; wants &quot;</span>
				<span class="o">+</span> <span class="n">amountOfBottles</span> <span class="o">+</span> <span class="s">&quot; bottle&quot;</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">amountOfBottles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">));</span>
		
		<span class="c1">//Save the order:</span>
		<span class="n">MilkFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MilkDAO</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">saveOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>As you can see we no longer need the constructor, we get the required DAO from the factory when we need it.</p>

<p>Now we can test it using the replaceMapping method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkRequestServiceTest</span> <span class="o">{</span>

	<span class="n">MilkRequestService</span> <span class="n">milkRequestService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">();</span>
	
	<span class="c1">//@Test</span>
	<span class="cm">/**</span>
<span class="cm">	 * Test our milk request service.</span>
<span class="cm">	 * Pre:</span>
<span class="cm">	 * - We have a customer that wants to order 5 bottles of milk</span>
<span class="cm">	 * Post:</span>
<span class="cm">	 * - The milk DAO got a request to save 5 bottles of milk</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProcessOrder</span><span class="o">()</span> <span class="o">{</span>
		
		<span class="kd">final</span> <span class="n">String</span> <span class="n">customer</span> <span class="o">=</span> <span class="s">&quot;testUser&quot;</span><span class="o">;</span>
		<span class="kd">final</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
		
		<span class="c1">//Better use a mock here, for example using Mockito or EasyMock.</span>
		<span class="n">MilkFactory</span><span class="o">.</span><span class="na">replaceMapping</span><span class="o">(</span><span class="n">MilkDAO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nf">MilkDAO</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">//Check if the customer = testUser</span>
				<span class="c1">//Check if the amountOfBottles = 5;</span>
			<span class="o">}</span>
		<span class="o">});</span>
		
		<span class="n">MilkFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MilkRequestService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
			<span class="o">.</span><span class="na">processOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>As the comment says, you are probably much better of here using a mocking framework like EasyMock or Mockito. But the point is, we can test our class now without going to the database! We got our control back.</p>

<h1 id="dependency-injection">Dependency Injection</h1>

<p>Instead of writing a factory, there is a better way to do this. It is the Hollywood principle “Don’t call us, we’ll call you”.</p>

<p>All the dependencies of the objects are injected into them instead of created (initial example) or retrieved (factory example). So our service will look like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkRequestServiceImpl</span> <span class="kd">implements</span> <span class="n">MilkRequestService</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MilkDAO</span> <span class="n">milkDao</span><span class="o">;</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * The milkDao is given to us by our creator.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param milkDao</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">(</span><span class="n">MilkDAO</span> <span class="n">milkDao</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">milkDao</span> <span class="o">=</span> <span class="n">milkDao</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Place a new order for milk.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//Log the order:</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;LOG: Customer &quot;</span> <span class="o">+</span> <span class="n">customer</span> <span class="o">+</span> <span class="s">&quot; wants &quot;</span>
				<span class="o">+</span> <span class="n">amountOfBottles</span> <span class="o">+</span> <span class="s">&quot; bottle&quot;</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">amountOfBottles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">));</span>
		
		<span class="c1">//We just use the milkDao we got:</span>
		<span class="n">milkDao</span><span class="o">.</span><span class="na">saveOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now lets take a look at our test-code, it now looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProcessOrder</span><span class="o">()</span> <span class="o">{</span>
	
	<span class="kd">final</span> <span class="n">String</span> <span class="n">customer</span> <span class="o">=</span> <span class="s">&quot;testUser&quot;</span><span class="o">;</span>
	<span class="kd">final</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
	
	<span class="c1">//Better use a mock here, for example using Mockito or EasyMock.</span>
	<span class="n">MilkDAO</span> <span class="n">testMilkDao</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkDAO</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//Check if the customer = testUser</span>
			<span class="c1">//Check if the amountOfBottles = 5;</span>
		<span class="o">}</span>
	<span class="o">};</span>
	
	<span class="n">MilkRequestService</span> <span class="n">milkRequestService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">(</span><span class="n">testMilkDao</span><span class="o">);</span>
	
	<span class="n">milkRequestService</span><span class="o">.</span><span class="na">processOrder</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">amountOfBottles</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>We now have full control over the wiring. First we create our own little testMilkDao (use a mock here!) and we place it into our service. That’s all. Instead of the hidden creation in the service itself or in the factory we are in full control.</p>

<p>But if you want to use this application you’ll need “something else” to create all the objects and do the actual wiring. Lets create our own Spring or Google Guice..!!</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkApplication</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">MilkApplication</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkApplication</span><span class="o">();</span>
		<span class="n">app</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">MilkApplication</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">//-----   Provide wiring:  -----</span>
		<span class="n">MilkDAO</span> <span class="n">milkDao</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkDAODatabaseImpl</span><span class="o">();</span>
		<span class="n">milkRequestService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">(</span><span class="n">milkDao</span><span class="o">);</span>
		<span class="c1">//------------------------------</span>
	<span class="o">}</span>
	
	<span class="kd">private</span> <span class="n">MilkRequestService</span> <span class="n">milkRequestService</span><span class="o">;</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Do stuff:</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">milkRequestService</span><span class="o">.</span><span class="na">processOrder</span><span class="o">(</span><span class="s">&quot;Roy van Rijn&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h1 id="using-spring">Using Spring</h1>

<p>The wiring we do in the constructor is what Spring and Google Guice would do for us. In the case of Spring you’ll write something like this:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd&quot;</span><span class="nt">&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;milkDao&quot;</span> <span class="na">class=</span><span class="s">&quot;nl.redcode.examples.milkman.MilkDAODatabaseImpl&quot;</span> <span class="nt">/&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;milkRequestService&quot;</span> <span class="na">class=</span><span class="s">&quot;nl.redcode.examples.milkman.MilkRequestServiceImpl&quot;</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;milkDao&quot;</span> <span class="na">ref=</span><span class="s">&quot;milkDao&quot;</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre></figure>

<p>Now you’ll still need to retrieve these “beans” from Spring, this can be done using our old-friend the Factory!<br />
It’ll look something like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ClassPathXmlApplicationContext</span> <span class="n">appContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="o">(</span>
	<span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">&quot;applicationContext.xml&quot;</span><span class="o">});</span>
<span class="n">MilkRequestService</span> <span class="n">milkRequestService</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&quot;milkRequestService&quot;</span><span class="o">);</span></code></pre></figure>

<p>This instructs Spring to load the XML file and create all the objects. Then we retrieve the milkRequestService and it is fully wired and ready to use!</p>

<h1 id="using-guice">Using Guice</h1>

<p>Google Guice works exacly the same, only instead of using XML to define the mapping it only uses Java code and annotations.</p>

<p>First we tell Guice which implementations are the default implementations, for example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">milkman</span><span class="o">;</span>

<span class="nd">@ImplementedBy</span><span class="o">(</span><span class="n">MilkDAODatabaseImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MilkDAO</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Save a new order.</span>
<span class="cm">	 * @param customer</span>
<span class="cm">	 * @param amountOfBottles</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">customer</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">amountOfBottles</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>We also do this to the MilkRequestService. Next we tell Guice where to inject these implementations, in this case using ‘Constructor Injection’:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * The milkDao is injected by Guice.</span>
<span class="cm"> * </span>
<span class="cm"> * @param milkDao</span>
<span class="cm"> */</span>
<span class="nd">@Inject</span>
<span class="kd">public</span> <span class="nf">MilkRequestServiceImpl</span><span class="o">(</span><span class="n">MilkDAO</span> <span class="n">milkDao</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">milkDao</span> <span class="o">=</span> <span class="n">milkDao</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Now if we want to use it, we retrieve it from Guice like so:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilkApplication</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">MilkApplication</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MilkApplication</span><span class="o">();</span>
		<span class="n">app</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="cm">/**</span>
<span class="cm">	 * Do stuff:</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
		
	    <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">();</span>
	    <span class="n">MilkRequestService</span> <span class="n">milkRequestService</span> <span class="o">=</span> 
	        <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MilkRequestService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="n">milkRequestService</span><span class="o">.</span><span class="na">processOrder</span><span class="o">(</span><span class="s">&quot;Roy van Rijn&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Thats about it, you’ve seen:</p>

<ul>
  <li>Why you should use these patterns</li>
  <li>How you would program them yourself (ugly monkey-code-style)</li>
  <li>How using Spring (with XML)</li>
  <li>How using Google Guice!</li>
</ul>

<p>Good luck and happy programming!</p>

<p>ps. The code examples are just examples…!!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/dependency-injection-dissection/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/movies-as-porn/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 15, 2010 15:45:57
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/movies-as-porn/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/movies-as-porn/">What if your favourite movie was remade as porno</a></h1>


        <p>What if your favourite movie was remade as a porn movie? How would it be called, what would the title be?</p>

<p>My collegues and I were discussing this, and we came up with a top 10. We’ve also started a twitter <a href="http://hashtags.org/moviesasporn">hashtag</a>.</p>

<h1 id="top-10">Top 10</h1>

<ol>
  <li>Shaving Ryan’s Privates (everybodies favourite)</li>
  <li>The Curious Taste of Benjamin’s Bottom</li>
  <li>Honey, I shagged the kids</li>
  <li>Missionary Impossible III</li>
  <li>Good Will Humping</li>
  <li>Free my Willy</li>
  <li>Legally Boned</li>
  <li>I Know Who you did last Summer</li>
  <li>Schindler’s Fist</li>
  <li>Cliff Banger</li>
</ol>

<h1 id="honourable-mentions">Honourable mentions</h1>

<p>And some honourable mentions to the titles that just didn’t make the list:</p>

<ul>
  <li>When Harry ate Sally</li>
  <li>Saturday Night Beaver</li>
  <li>Spankenstein</li>
  <li>Swollow Hal</li>
  <li>Sorest Rump</li>
  <li>Bangs of New York</li>
  <li>American Bangster</li>
  <li>Thighs Wide Shut</li>
  <li>Citizen Came</li>
  <li>The Green Milf</li>
  <li>The Porn Identity</li>
  <li>Crouching Woman, Hidden Camera</li>
</ul>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/movies-as-porn/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/does-my-car-hate-me/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 12, 2010 00:04:21
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/does-my-car-hate-me/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/does-my-car-hate-me/">Does my car hate me?</a></h1>


        <p>Why does my car do this to me? It bugs me everyday. When I drive with the snow outside I have to use my windscreen washer quite a lot. When I pull the little lever behind my steering wheel it spurts a jet of antifreeze/washer fluid onto my screen and it starts to wipe for about 10 times. Then it stops… my window is clean again!</p>

<p><img src="/images/windscreen-300x186.jpg" alt="picture of dirty windscreen" /></p>

<p>But after about 15 seconds it does one final sweep… and this last sweep <strong>always</strong> leaves ugly marks!</p>

<p>Why do cars do this!!!? First it cleans my window perfectly, and then spoils it!</p>

<p><strong>Update:</strong><br />
A collegue adviced me this: If the car has just finished wiping, quickly switch on the manual and stop it. This will still cause one extra wipe, but it comes right after the others. This produces a slightly better result.</p>

<p>I tried this two times on my car (a Fiat Bravo) and it worked one time, the other time it still did the final whipe after around 10 seconds.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/does-my-car-hate-me/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/01/md5-fixed-point/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 5, 2010 16:04:53
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/md5-fixed-point/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/01/md5-fixed-point/">MD5 quine, fixed point</a></h1>


        <h1 id="md5-quines">MD5 quines</h1>

<p>Sometimes I let my mind wonder and I get crazy questions. Today was a good example, I encountered a MD5 hash and I started to wonder, would there be a hash which would (when hashed again) be the same?</p>

<p>Thus: MD5(x) = x</p>

<p>This would be a kind of MD5 quine, when fed into the algorithm you get the original value back. This is actually called an MD5 fixed point.</p>

<h1 id="information-ive-found">Information I’ve found</h1>

<p>So I started investigating, soon I discovered <a href="http://www.mscs.dal.ca/~selinger/md5collision/">this</a> website about collisions. Its well known that all hashing algorithms must have collisions, you can’t always produce a unique hash for input larger then the output of course.</p>

<p>The output of the MD5 sum is 128 bit (16 byte) long, so the input should also have the same length. But the MD5 algorithm is defined to have 512 bits as input. This isn’t really a problem because the algorithm will extend smaller input with padding. Lets assume the MD5 sum of any input is uniformly distributed over all possible sums, then the probability that a 128-bit string is a fixed point is 1/2^128. This isn’t a crazy assumption because all hashing-algorithms are designed to distribute the output as uniformly as possible to avoid collisions.</p>

<p>So, the probability that no 128-bit string is a real fixed point is (1 - 1/2^128)^(2^128). The probability that there IS a fixed point is 1 - (1 - 1/2^128)^(2^128).</p>

<p>Since the limit as N goes to infinity of (1 - 1/N)^N is 1/e, and 2^128 is most certainly a very large number, this probability is almost exactly 1 - 1/e = 63.21%.</p>

<p>But, of course, there is no randomness involved here - there either is a fixed point or there isn’t. But, we can be 63.21% confident that there is a fixed point. (Also, notice that this number does not depend on the size of the keyspace - if MD5 sums were 32 bits or 1024 bits, the answer would be the same).</p>

<h1 id="looking-for-the-fixed-point">Looking for the fixed point</h1>

<p>I’ve just implemented a small program to look for these hashes, even though I know it will take millions of years to check all the numbers. But you never know, I might get lucky ;-)</p>

<p>The first algorithm I created took a single random String as input and kept applying the algorithm to the output. Eventually it will:</p>

<ol>
  <li>Go into a loop  </li>
  <li>Find a fixed point (which is a loop of size 1)</li>
</ol>

<p>The weird thing is, if it ends up in a loop of size 1… I’ve found two things. Not only a md5 fixed point, which creates itself after applying the algorithm. But also an input-value that produces this md5 as output, a collision!</p>

<h1 id="graph">Graph</h1>

<p>Another interesting thing would be a complete graph of all md5 answers. Which loops can we find, which md5 has most collisions etc. But this would take eternity to calculate, even using all the machines in the world.</p>

<h1 id="open-questions">Open questions</h1>

<ul>
  <li>Are there loops? (It is possible there aren’t any loops at all…?)</li>
  <li>Are there loops of size 1, a.k.a. fixed points?</li>
  <li>Which/how many 128 bit combinations can’t be created with the input values?</li>
  <li>Which/how many collisions will you get with all the input values?</li>
</ul>

<p>More thoughts, errors, solutions..?</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/01/md5-fixed-point/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2009/12/splitting-up-spring-web-flow-facelets-into-jars/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Dec 15, 2009 15:25:15
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/splitting-up-spring-web-flow-facelets-into-jars/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2009/12/splitting-up-spring-web-flow-facelets-into-jars/">Splitting up Spring Web Flow & Facelets into JARs</a></h1>


        <p>In our current project we want to have multiple Spring Web Flow-flows in one WAR-file. <em>But</em> we also want the flows and pages to be inside seperate JAR files, making the application a bit more managable and modulair.</p>

<p>This sounds straightforward but it took quite a bit of code and time…</p>

<p>First I created a single WAR-project with all the basic Spring, JSF and Facelet configuration. Like any Spring Web Flow (SWF) project we have a project-servlet.xml.</p>

<p>The first thing I did was changing our flowRegistry:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- The registry of executable flow definitions --&gt;</span>
<span class="nt">&lt;webflow:flow-registry</span> <span class="na">id=</span><span class="s">&quot;flowRegistry&quot;</span> 
   <span class="na">flow-builder-services=</span><span class="s">&quot;facesFlowBuilderServices&quot;</span> 
   <span class="na">base-path=</span><span class="s">&quot;classpath*:flows&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;webflow:flow-location-pattern</span> <span class="na">value=</span><span class="s">&quot;/**/*-flow.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/webflow:flow-registry&gt;</span></code></pre></figure>

<p>The <em>classpath*:</em> allows SWF to search the whole classpath for flow-directories containing a flow definition.<br />
In our case it would be: <em>/flows/module1/module1-flow.xml</em></p>

<p>When you try to run this, and access a page we got the following exception:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Caused by: java.lang.IllegalStateException: A ContextResource is required to get relative view paths within this context; the resource was file [D:\projects\projectfromjar\module1\bin\flows\module1\page1.xhtml]
	at org.springframework.faces.webflow.FlowViewHandler.resolveResourcePath(FlowViewHandler.java:110)
	at org.springframework.faces.webflow.FlowViewHandler.restoreView(FlowViewHandler.java:74)
	at com.sun.facelets.FaceletViewHandler.restoreView(FaceletViewHandler.java:316)
	at org.springframework.faces.webflow.JsfViewFactory.getView(JsfViewFactory.java:93)
	at org.springframework.webflow.engine.ViewState.resume(ViewState.java:193)
	at org.springframework.webflow.engine.Flow.resume(Flow.java:545)
	at org.springframework.webflow.engine.impl.FlowExecutionImpl.resume(FlowExecutionImpl.java:259)
	... 38 more</code></pre></figure>

<p>For some reason Spring Web Flow doesn’t want to load the facelet. After browsing around Spring’s forums I came across some solutions. They didn’t do the trick, only when combining several methods I got it working for Spring Web Flow 2.0.7.</p>

<p>This is how I did it, we need to tell Facelets to use our custom ClassPathResourceResolver:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- To load flows and pages from JARs, use this resolver --&gt;</span>
<span class="nt">&lt;context-param&gt;</span>
      <span class="nt">&lt;param-name&gt;</span>facelets.RESOURCE_RESOLVER<span class="nt">&lt;/param-name&gt;</span>
      <span class="nt">&lt;param-value&gt;</span>nl.redcode.ClassPathResourceResolver<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span></code></pre></figure>

<p>The resolver itself is basic but does the job:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.facelets.impl.ResourceResolver</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassPathResourceResolver</span> <span class="kd">implements</span> <span class="n">ResourceResolver</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">URL</span> <span class="nf">resolveUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="nf">getClass</span><span class="o">().</span><span class="na">getResource</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>This will help Facelets to translate a given path to a java.net.URL using the current classloader.<br />
Spring Web Flow is currently giving us a FileSystemResource, and this doesn’t work because we want to load the pages with our classloader. For this we have the following wrapper:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ContextResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">CustomClassPathContextResource</span> <span class="kd">extends</span> <span class="n">ClassPathResource</span> <span class="kd">implements</span> <span class="n">ContextResource</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CustomClassPathContextResource</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPathWithinContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getPath</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Resource</span> <span class="nf">createRelative</span><span class="o">(</span><span class="n">String</span> <span class="n">relativePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">pathToUse</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">applyRelativePath</span><span class="o">(</span><span class="n">getPath</span><span class="o">(),</span> <span class="n">relativePath</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomClassPathContextResource</span><span class="o">(</span><span class="n">pathToUse</span><span class="o">,</span> <span class="n">getClassLoader</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>To force Spring to use this Resource instead of FileSystemResource we use a post processor:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">nl</span><span class="o">.</span><span class="na">redcode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanPostProcessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.GenericApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ResourceLoader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.webflow.definition.registry.FlowDefinitionRegistry</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FlowRegistryClassPathPostProcessor</span> <span class="kd">implements</span> <span class="n">BeanPostProcessor</span> <span class="o">{</span>
	
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="n">FlowDefinitionRegistry</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">alterRegistry</span><span class="o">((</span><span class="n">FlowDefinitionRegistry</span><span class="o">)</span> <span class="n">bean</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">alterRegistry</span><span class="o">(</span><span class="n">FlowDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">flowId</span> <span class="o">:</span> <span class="n">registry</span><span class="o">.</span><span class="na">getFlowDefinitionIds</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">ApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getFlowDefinition</span><span class="o">(</span><span class="n">flowId</span><span class="o">).</span><span class="na">getApplicationContext</span><span class="o">();</span>
            <span class="n">overrideResourceLoader</span><span class="o">((</span><span class="n">GenericApplicationContext</span><span class="o">)</span> <span class="n">ctx</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Override the ResourceLoader:</span>
<span class="cm">     * We know our flow is always defined as &quot;flows/module1&quot;.</span>
<span class="cm">     * From the context we can derive the name of the flow (module1)</span>
<span class="cm">     * So we build up the ClassPathResource base as:</span>
<span class="cm">     * &quot;flows/&quot;+ ctx.getResource(&quot;&quot;)+ &quot;/&quot;</span>
<span class="cm">     * </span>
<span class="cm">     * @param ctx</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">overrideResourceLoader</span><span class="o">(</span><span class="n">GenericApplicationContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    	<span class="kd">final</span> <span class="n">ClassPathResource</span> <span class="n">cpr</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ClassPathResource</span><span class="o">(</span><span class="s">&quot;flows/&quot;</span><span class="o">+</span><span class="n">ctx</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">).</span><span class="na">getFilename</span><span class="o">()+</span><span class="s">&quot;/&quot;</span><span class="o">);</span>

    	<span class="n">ctx</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">new</span> <span class="nf">ResourceLoader</span><span class="o">()</span> <span class="o">{</span>
        	
        	<span class="kd">public</span> <span class="n">ClassLoader</span> <span class="nf">getClassLoader</span><span class="o">()</span> <span class="o">{</span>
        		<span class="k">return</span> <span class="n">cpr</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        	<span class="o">}</span>

        	<span class="kd">public</span> <span class="n">Resource</span> <span class="nf">getResource</span><span class="o">(</span><span class="n">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        		<span class="k">return</span> <span class="k">new</span> <span class="nf">CustomClassPathContextResource</span><span class="o">(</span><span class="n">cpr</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span> <span class="o">+</span> <span class="n">location</span><span class="o">,</span> <span class="n">getClassLoader</span><span class="o">());</span>
        	<span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>When the FlowDefinitionRegistry is created we provide it with a new ResourceLoader. When the resources are requested by Spring Web Flow we create our own CustomClassPathContextResource. This consists of our current location plus the defined location (viewId).</p>

<p>To register this post processor add it to your project-servlet.xml:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;flowRegistryClassPathPostProcessor&quot;</span> <span class="na">class=</span><span class="s">&quot;nl.redcode.FlowRegistryClassPathPostProcessor&quot;</span> <span class="nt">/&gt;</span></code></pre></figure>

<h1 id="how-to-use-it">How to use it</h1>

<p>In our project we have the following flow(s) defined in a seperate JAR:<br />
/flows/module1/module1-flow.xml</p>

<p>And our pages are in the same directory:<br />
/flows/module1/page1.xhtml<br />
/flows/module1/page2.xhtml<br />
etc…</p>

<p>In the flow we can now use the following view-id’s:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;flow</span> 	<span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/webflow&quot;</span>
		<span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
		<span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/webflow</span>
<span class="s">							http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;view-state</span> <span class="na">id=</span><span class="s">&quot;start&quot;</span> <span class="na">view=</span><span class="s">&quot;page1.xhtml&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/flow&gt;</span></code></pre></figure>

<p>Its also possible to have pages in other places, you can define the views as relative paths. For example:<br />
<em>”../../shared_pages/page2.xhtml”</em> turns into <em>“/shared_pages/page2.xhtml”</em><br />
<em>”../pages/page3.xhtml”</em> turns into <em>“/flows/pages/page3.xhtml”</em></p>

<p>The only problem we still have using this method is the deployment with RAD/Eclipse WTP and Facelets auto-refresh. For some reason after deploying our application locks the files in the bin-directory. Eclipse then can’t delete this directory and fails to publish. Ending in one big #fail. But a simple clean, clean, republish, clean, rebuild, restart, shout, scream, cry, rebuild and republish will solve this.</p>

<p>The big advantage is the fact that the flows and pages are now defined in their own JAR files, making releases and sharing classes (like shared services/shared menu’s etc) much easier.</p>

<p>Information on <a href="http://forum.springsource.org/showthread.php?t=64252">Spring forum</a></p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/splitting-up-spring-web-flow-facelets-into-jars/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2009/12/inversion_of_logic/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Dec 11, 2009 10:14:10
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/inversion_of_logic/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2009/12/inversion_of_logic/">Cleaner code: Inversion of logic</a></h1>


        <h1 id="design-patterns">Design patterns</h1>

<p>Almost all programmers have heard about and used <a href="http://en.wikipedia.org/wiki/Design_pattern_%28computer_science%29">design patterns</a>. And there are a <em>lot</em> of them. Famous design patterns include the Singleton, Observer, Template method. These are all patterns that focus on objects and the relationship between them.</p>

<p>There are more groups of patterns, for example take <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> (or Inversion of Control). This is an architectural pattern. They tell you things about the design of the whole program. And there are specific pattern groups, like <a href="http://en.wikipedia.org/wiki/Concurrency_pattern">concurrency patterns</a>.</p>

<p>These patterns help you solve common problems in a well defined way, other programmers will recognise the patterns used and it will help produce more maintainable code.</p>

<h1 id="inversion-of-logic">Inversion of logic</h1>

<p>The patterns described above all say something about classes/methods and architecture. But I think another class of design patterns exist, which have a smaller granularity. These patterns say something about the code inside a single method. A good example is Inversion of logic.</p>

<p>Let me give an example, lets take the following code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processRequests</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RentalRequest</span><span class="o">&gt;</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
	
	<span class="k">for</span> <span class="o">(</span><span class="n">RentalRequest</span> <span class="n">rentalRequest</span> <span class="o">:</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">rentalRequest</span><span class="o">.</span><span class="na">isFormFilledCorrectly</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">Tenant</span> <span class="n">tenant</span> <span class="o">=</span> <span class="n">rentalRequest</span><span class="o">.</span><span class="na">getTenant</span><span class="o">();</span>
			<span class="k">if</span><span class="o">(</span><span class="n">tenant</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="n">checkLicenceStillValid</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">//Approve the request</span>
				<span class="c1">//Process the request in database</span>
				<span class="c1">//Send email to HQ</span>
				<span class="c1">//Etc...</span>
			<span class="o">}</span>				
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Its a basic car-rental service and is has some logic before a request is processed. To make this code more readable and maintainable we can do two things. Of course it would be better to factor out the validation-logic into another piece of code. So lets do that first:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processRequests</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RentalRequest</span><span class="o">&gt;</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
	
	<span class="k">for</span> <span class="o">(</span><span class="n">RentalRequest</span> <span class="n">rentalRequest</span> <span class="o">:</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
    
		<span class="k">if</span><span class="o">(</span><span class="n">validateRequest</span><span class="o">(</span><span class="n">rentalRequest</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">//Approve the request</span>
			<span class="c1">//Process the request in database</span>
			<span class="c1">//Send email to HQ</span>
			<span class="c1">//Etc...</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">validateRequest</span><span class="o">(</span><span class="n">RentalRequest</span> <span class="n">rentalRequest</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span><span class="o">(</span><span class="n">rentalRequest</span><span class="o">.</span><span class="na">isFormFilledCorrectly</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">Tenant</span> <span class="n">tenant</span> <span class="o">=</span> <span class="n">rentalRequest</span><span class="o">.</span><span class="na">getTenant</span><span class="o">();</span>
		<span class="k">if</span><span class="o">(</span><span class="n">tenant</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="n">checkLicenceStillValid</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Some programmers don’t like the validateRequest() method above because there are multiple exit points. This was more problematic in C code then in Java because in C you needed to do a bit more resource management (freeing mallocs etc), in Java I actually don’t mind having more then one exit-point in my code. In this case it makes it just a bit more readable. It would be easy to add a ‘requestIsValid’ boolean and fill that instead.</p>

<p>Anyway, the next step in refactoring this code is using what I call “Inversion of Logic”. The idea is that you don’t continue nesting if something is true, but instead inverse it, and bail out if something is false. The big advantage is that you’ll lose a lot of nesting, making the code more readable. I’m going to do this in two places, first in the processRequest for-loop, and second in the validateRequest method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processRequests</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RentalRequest</span><span class="o">&gt;</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
	
	<span class="k">for</span> <span class="o">(</span><span class="n">RentalRequest</span> <span class="n">rentalRequest</span> <span class="o">:</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
    
		<span class="k">if</span><span class="o">(!</span><span class="n">validateRequest</span><span class="o">(</span><span class="n">rentalRequest</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">continue</span><span class="o">;</span>
		<span class="o">}</span>
		
		<span class="c1">//Approve the request</span>
		<span class="c1">//Process the request in database</span>
		<span class="c1">//Send email to HQ</span>
		<span class="c1">//Etc...</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">validateRequest</span><span class="o">(</span><span class="n">RentalRequest</span> <span class="n">rentalRequest</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span><span class="o">(!</span><span class="n">rentalRequest</span><span class="o">.</span><span class="na">isFormFilledCorrectly</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">Tenant</span> <span class="n">tenant</span> <span class="o">=</span> <span class="n">rentalRequest</span><span class="o">.</span><span class="na">getTenant</span><span class="o">();</span>
	<span class="k">if</span><span class="o">(</span><span class="n">tenant</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">25</span> <span class="o">||</span> <span class="o">!</span><span class="n">tenant</span><span class="o">.</span><span class="na">checkLicenceStillValid</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>As you can see in the for-loop all the business logic is moved one indent back, this will make your code easier to scan for business rules. And if you look at the validateRequest method the code reads more fluent. Instead of stacking up and remembering the valid cases:</p>

<p><em>IF form is correct<br />
AND tenant age correct<br />
AND tenant licence is valid<br />
THEN proceed</em></p>

<p>We now eliminate the bad cases first:</p>

<p><em>IF form is incorrect: deny rental<br />
IF tenant’s age or licence is invalid: deny rental<br />
ELSE proceed</em></p>

<p>I’m trying to do this everywhere I can, it realy helps the readability.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/inversion_of_logic/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2009/12/java-ee-6-released-including-servlet-3-0/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Dec 10, 2009 22:43:13
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/java-ee-6-released-including-servlet-3-0/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2009/12/java-ee-6-released-including-servlet-3-0/">Java EE 6 released, including Servlet 3.0</a></h1>


        <p>Today marks the release of Java EE 6. The reference implementation (Glassfish V3) has been released and the specifications are going into their final state very soon.</p>

<p>About two years ago, while I was attending the JavaOne conference, I first heard about the Servlet 3.0 ideas. As a web developer I’ve worked a lot with these Servlets so I was curious about the ideas. But what I saw wasn’t what I hoped for. On the contrary, what I saw was a huge mistake in my opinion!  </p>

<p>So I decided to contact the guys behind this JSR, to ask for some more information and share my views. Some time passed but I never got a reply… My next move was just to write about it, first on my own blog, then on <a href="http://java.dzone.com/articles/reviewing-early-draft-servlet-">DZone</a> (05/30/2008) and on <a href="http://www.theserverside.com/tt/articles/article.tss?l=PonderingAboutJSR135">The Server Side</a> a half year later, december 2008.</p>

<p>The only ‘reply’ I got from the people of the JSR was in the days following my (re-)post on The Server Side. Glassfish has a short re-cap on what happened <a href="http://swik.net/GlassFish/The+Aquarium/Servlet+3.0+...+Almost+at+PDR/cmaui">here</a>.</p>

<p>Now that the release is final I’m actually glad with the result. All the issues I raised from the early draft have been fixed. This is what a simple servlet would have looked like in the early draft:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Servlet</span><span class="o">(</span><span class="n">urlMappings</span><span class="o">={</span><span class="s">&quot;/foo&quot;</span><span class="o">,</span> <span class="s">&quot;/bar&quot;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServlet</span> <span class="o">{</span>
     <span class="nd">@GET</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//Handle the GET</span>
     <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>And this was my suggestion on how to improve it (see second article/link):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@ServletMapping</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;myServlet&quot;</span><span class="o">,</span> <span class="n">mapping</span><span class="o">={</span><span class="s">&quot;/foo&quot;</span><span class="o">,</span> <span class="s">&quot;/bar&quot;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

     <span class="nd">@Override</span> <span class="c1">//keep strong typing!</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
          <span class="o">...</span>
     <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>And this is from the final release:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;myServlet&quot;</span><span class="o">,</span> <span class="n">urlPatterns</span><span class="o">={</span><span class="s">&quot;/foo&quot;</span><span class="o">,</span><span class="s">&quot;/bar&quot;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

     <span class="nd">@Override</span> <span class="c1">//keep strong typing!</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
          <span class="o">...</span>
     <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>That’s very similair, maybe a little too similair..? But anyway, I’m pleased about the result. It’ll be a lot easier in the future to write Servlets and Filters and a lot of cool new features have been added too.</p>

<p>I love the spec, despite the lack of feedback and replies from the expert group, ignoring all positive feedback and constructive advice. If I now look at the way the annotations turned out its almost identical to my first sketch after their JavaOne presentation in March 2008.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2009/12/java-ee-6-released-including-servlet-3-0/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  

  <!-- Pagination -->
  
  <div class="pagination">
    <div class="pagination-center">
    
      <div class="pagination-item"><a href="/page/7">&laquo; Prev</a></div>
    

    
      
        <div class="pagination-item"><a href="/index.html">1</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/2">2</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/3">3</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/4">4</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/5">5</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/6">6</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/7">7</a></div>
      
    
      
        <div class="pagination-item"><b>8</b></div>
      
    
      
        <div class="pagination-item"><a href="/page/9">9</a></div>
      
    

    
      <div class="pagination-item"><a href="/page/9">Next &raquo;</a></div>
    
    </div>
  </div>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-wrapper">
      
      <div class="footer-wrapper-content">
      
        <a href="https://www.linkedin.com/profile/view?id=10356027">
          <i class="svg-icon linkedin"></i>
        </a>
      
        <a href="http://stackoverflow.com/users/442274/roy-van-rijn">
          <i class="svg-icon stackoverflow"></i>
        </a>

        <a href="https://github.com/royvanrijn">
          <i class="svg-icon github"></i>
        </a>

        <a href="https://twitter.com/royvanrijn">
          <i class="svg-icon twitter"></i>
        </a>
          
        <a href="/feed/index.xml">
          <i class="svg-icon rss"></i>
        </a>
	  </div>
    
    </div>

  </div>

</footer>


  </body>

</html>
