<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>royvanrijn  | Java, algorithms, math, science and more!</title>
  <meta name="description" content="Java, algorithms, math, science and more!">
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://royvanrijn.com/page/7/">
  <link rel="alternate" type="application/rss+xml" title="royvanrijn" href="http://royvanrijn.com/feed/" />


<script>
  <!-- Google Analytics -->
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3219266-1', 'auto');
  ga('send', 'pageview');

  <!-- Disqus Comment Count -->
  var disqus_shortname = 'royvanrijn';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

	<a class="site-title" href="/">
	  <img src="/images/header_royvanrijn.jpg" alt="royvanrijn" />
    </a>

    <nav class="site-nav">

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

  <hr/>
  <!-- This loops through the paginated posts -->
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/01/exception-mailing/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 6, 2011 00:36:51
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2011/01/exception-mailing/">Exception mailing</a></h1>


        <p>A couple of weeks ago our Scrum team was thinking about exception handling. We don’t use checked exceptions, since they are the embodiment of evil. So everything is translated into runtime exceptions whenever possible. But this is where the problems start: What do you do with the uncatched runtime exceptions?</p>

<h1 id="taking-it-one-step-further">Taking it one step further</h1>

<p>Most projects will decide to just write the exceptions to the console, maybe to a log file. In some cases there is specialized software which will analyze log files, detect stacktraces and act on them. We decided to create a fast specialized solution. We want to have a mailbox where all the runtime exceptions end up, including stacktrace, system properties, program properties and even a screenshot.</p>

<h2 id="catching-the-uncaught-exception">Catching the uncaught exception</h2>

<p>In Java you can set a exception handlers on Threads. You can set a handler on a Thread, but it is also possible to set a default exception handler. It is very easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUncaughtExceptionHandler</span> <span class="kd">implements</span> <span class="n">UncaughtExceptionHandler</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CustomUncaughtExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uncaughtException</span><span class="o">(</span><span class="kd">final</span> <span class="n">Thread</span> <span class="n">t</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do something here!    </span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>If an exception occurs, the uncaughtException method will be called. Then you can do anything you want with the throwable. As said before, we decided it is best for us that the application phones home and sends us an email with as much information as we can get.</p>

<h1 id="what-to-send">What to send?</h1>

<p>Our application is launched by JNLP and will run on several clients. We don’t have complete contol over these clients, so we want to include as much information as possible to solve possible bugs in the application. The more information we have about the runtime, the easier it might be to find the problem. We grab all (relevant) system properties and program properties we can get. Including usernames, machine details.</p>

<h2 id="creating-a-screenshot">Creating a screenshot</h2>

<p>In Java there are actually two methods of creating a screenshot. The first method is the easiest, using the Java Robot:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Robot</span> <span class="n">robot</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Robot</span><span class="o">();</span>
 
<span class="n">BufferedImage</span> <span class="n">screenShot</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="na">createScreenCapture</span><span class="o">(</span><span class="k">new</span> <span class="nf">Rectangle</span><span class="o">(</span><span class="n">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">()));</span></code></pre></figure>

<p>Very easy, but this can contain a LOT of information about the moment the exception occurs. It may provide valuable information. But we encountered a major security problem with the above method. Java will create an actual screenshot, the size of your application. But it doesn’t know if your application is currently the active window..! When we did tests we saw screenshots with Skype messages in screen and browsers being active… We can’t invade the lives of our users and send this information over the mail!</p>

<p>So I decided to search for something less invasive. The main frame of our application has a paint method, and most of the time this method can still be called if we have an exception. It is possible to create our own Graphics object and let the main frame paint itself into memory. So eventually I settled on the code below:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BufferedImage</span> <span class="nf">createScreenshot</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Try to repaint the main frame of our application:</span>
        <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BufferedImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">paintAll</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getGraphics</span><span class="o">());</span>
        <span class="c1">// We can&#39;t use Robot, it might capture a bit too much information</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Screen can&#39;t be captured, don&#39;t throw exception, else we&#39;ll end up in a loop :-)</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="mailing-the-exception">Mailing the exception</h2>

<p>The next step in our solution is sending an email with all the information. This is done using Java Mail, an API to send emails. More about sending emails from Java <a href="http://www.javaworld.com/jw-06-1999/jw-06-javamail.html?page=4">here</a>. In our case we create a pretty HTML email with all relevant information and three attachements:</p>

<ul>
  <li>Text file with all system properties</li>
  <li>Text file with the complete exception</li>
  <li>The image/screenshot</li>
</ul>

<p>To create the email it is easy to create MimeBodyParts which contain the text, the only part a bit more complicated it to add the screenshot inside the email, this can be done using:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">MimeBodyPart</span> <span class="nf">createImagePart</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedImage</span> <span class="n">screenshot</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
    
	<span class="k">if</span> <span class="o">(</span><span class="n">screenshot</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">MimeBodyPart</span> <span class="n">imagePart</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MimeBodyPart</span><span class="o">();</span>
	<span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">screenshot</span><span class="o">,</span> <span class="s">&quot;jpg&quot;</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioException</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Impossible to get the screenshot, return null and continue without it</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">DataSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayDataSource</span><span class="o">(</span><span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="s">&quot;image/jpeg&quot;</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setDataHandler</span><span class="o">(</span><span class="k">new</span> <span class="nf">DataHandler</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="s">&quot;screenshot.jpg&quot;</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setContentID</span><span class="o">(</span><span class="s">&quot;&lt;screenshot&gt;&quot;</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">imagePart</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>The only non-obvious line in the code above is setting the ContentID, this can be used to refer to the image-data in case of an HTML email. In the main email content I added the following line:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">Screenshot: <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;/images/cid:screenshot&quot;</span> <span class="na">alt=</span><span class="s">&quot;Screenshot of the moment the exception occured.&quot;</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>The <em>src=”cid:screenshot”</em> will cause the email to show the screenshot embedded inside the email. This makes the exception-email look very pretty.</p>

<h1 id="even-more-in-the-future">Even more in the future…?</h1>

<p>With our current implementation we’ll be able to detect exceptions instantly (on every new email). Also we’ll have more information then just a stacktrace, we have a screenshot and some parameters/system properties which can help us re-create the situation.</p>

<p>To improve this even more I’m planning on adding a simple bounded FIFO queue. This queue will contain a list of actions performed by the user. These user-actions can be added automatically by using aspect oriented programming. For example annotating all the service methods. Everytime a service method is called we can add it to the bounded queue, which has a maximum of N elements, for example 20. If an exception occurs we print our the current queue, we can read the last N actions leading up to the exception. This too can be very helpful in re-creating the situation.</p>

<p>What more information could be useful in an debug email like this? How do you guys solve exception handling?</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/01/rainbow-tables/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jan 1, 2011 17:17:25
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/rainbow-tables/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2011/01/rainbow-tables/">Rainbow tables, reverse hash lookup</a></h1>


        <p>Today I’ve been looking into rainbow tables. These are tables used to do a reverse lookup for a hash function. For example MD5, or Windows LAN Manager. Usually these tables are used to find passwords if the hash is known. Now I’m not looking for a method to crack somebodies computer, but the technology and algorithms involved are very advanced and might be usefull in other fields as well!  </p>

<h1 id="hashing">Hashing</h1>

<p>First off, lets talk about ‘hashing’, what is hashing? Well, a hash-function is a one-way function which turns some data (usually text) into a hashcode. For example… passwords:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&quot;test&quot;     -&gt; &quot;098f6bcd4621d373cade4e832627b4f6&quot;
&quot;password&quot; -&gt; &quot;5f4dcc3b5aa765d61d8327deb882cf99&quot;</code></pre></figure>

<p>Every good website which takes security seriously will only store these MD5 hashes in their databases, not the real passwords. So even if their database is compromised the attackers don’t have anything, because the hash-function is only one-way.</p>

<h1 id="attacking-a-hash">Attacking a hash</h1>

<p>Where there is security there will be crackers trying to break it. How would you go about attacking, reversing, a hash? The earliest form was just to create huge tables of:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">PLAIN_TEXT -&gt; HASH</code></pre></figure>

<p>And then check if the hash is your hash. If you have a match, you’ll get into the system!</p>

<p>The problem is that these tables take a very long time to compute and you’ll end up with so much data you won’t be able to store it. This made hashing pretty safe.</p>

<h1 id="rainbow-tables">Rainbow tables</h1>

<p>A couple of generations further down the line, crackers now use rainbow tables. It takes the best of both worlds having a small(-ish) table on disk, and doing minimal computations. So how do they work..?</p>

<h2 id="the-reduce-function">The reduce function</h2>

<p>Lets assume we start with a random piece of text. For example we want to crack all passwords of length 5 and consisting of [ABC…XYZ0123456789]. We can now calculate the hash value. Instead of storing this single pair, we do a little trick. We use something that is called a ‘reduce function’. This is a selfmade one-way function that turns a hash back into a password! But not the original password (it isn’t a reverse hash-function) but just into some other password.</p>

<p>Why would we do that? Lets continue, we take our first random password, generate a hash, and then we reduce it back to another password. This is then again hashed, reduced, hashed, reduced for lets say 1000 times. We’ll end up with:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Hash:   &quot;random&quot;                           -&gt; &quot;7ddf32e17a6ac5ce04a8ecbf782ca509&quot;
Reduce: &quot;7ddf32e17a6ac5ce04a8ecbf782ca509&quot; -&gt; &quot;ienw3&quot;
Hash:   &quot;ienw3&quot;                            -&gt; &quot;b9322e367ad002d5adf7ca60b8b61e86&quot;
        ... (1000 times) ...
Hash:   &quot;o1gti&quot;                            -&gt; &quot;27aa4cbd3653a4617e0aec76ba3af9a4&quot;</code></pre></figure>

<p>The trick is, we throw away everything except the first input “random” and the final hash “27aa4cbd3653a4617e0aec76ba3af9a4”! This is the only part we need to store.</p>

<h2 id="using-a-rainbow-table">Using a rainbow table</h2>

<p>How can we use the data above to reverse hashes you might ask? To use this table we need the input hash. For example “b9322e367ad002d5adf7ca60b8b61e86”. First we check if this hash is in the database. If it is, we are very lucky, we can just re-generate that particulair chain and we know the plain text input!</p>

<p>If we don’t find anything (which is very likely) we apply our reduce function to the input-hash and then hash that result. Now we check the hashes again, regenerate the chain and find out the answer. This can be repeated until we hit our set limit (1000) in that case, if no match has been found, we can’t reverse it.</p>

<h2 id="false-alarms">False alarms</h2>

<p>There is one problem in this algorithm. If you take a input-hash and then do a couple of reduce/hashes, and then you find a match… it might be a false alarm! The problem is that there might be input strings that result in the same hash. If this happens two chains will end up into one chain.</p>

<p>If we would have done a couple of reduce/hashes from our input and find a match for endpoint “52cafa6b5e4a6509e6ed2b8e6976d780”, the original chain might not have contained our input value. When we construct the complete chain it is possible that our input-hash isn’t in the chain…!</p>

<h2 id="the-rainbow-of-the-rainbow-table">The ‘rainbow’ of the rainbow table</h2>

<p>The reason they call it a rainbow table has something to do with reducing the amount of false alarms. Until now we’ve talked about having one reduce-function. What if we would have multiple reduce functions? Then we could create multiple small tables, which would help reduce a little bit.</p>

<p>Philippe Oechslin had a great idea. He used a different reduce algorithm for each step in the chain. So his tables are build using:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">input chain 1 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash
input chain 2 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash
input chain 3 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash</code></pre></figure>

<p>(If you color the reduce functions you’ll end up with a pretty rainbow pattern).</p>

<p>How would you reverse a hash using this method? Well, the first step is the same, check if your input-hash is present in the stored hashes.<br />
Next we apply:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">reduce1000 -&gt; hash -&gt; check
reduce999 -&gt; hash -&gt; reduce1000 -&gt; hash -&gt; check
reduce998 -&gt; hash -&gt; reduce999 -&gt; hash -&gt; reduce1000 -&gt; hash -&gt; check</code></pre></figure>

<p>(etc)</p>

<p>The big advantage is that similair hashes (collisions) will most likely use different reduce algorithms so they won’t end up in the same chain.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Using rainbow tables you greatly decrease the amount of stored values. It isn’t log(O), there is a bit of computation needed to do the lookups, but that as well is kept to a minimum. This results in a very fast method to crack passwords. But I think it can be used in other fields of computer science as well. There are a lot of situations where you’d like to have a very big hash-lookup table, and when it becomes too big, this can be used to reduce storage but maintain fairly good lookup times.</p>

<h1 id="salting">Salting</h1>

<p>Almost every article about hashing and rainbow tables end with a short alinea about salting. You can do salting in a couple of different ways, but the idea is usually the same. The easiest form of salting is having on ‘salt’ for a complete database.</p>

<h2 id="one-salt-per-database">One salt per database</h2>

<p>How does this work? Well, lets just generate a completely random piece of text: “thisisoursaltanditisverylarge”. Now every time we store a new user we do “MD5(password + salt)”. Because the password itself may be weak, we apply our large “database-salt” to it, and then we calculate the hash.</p>

<p>Now if you want to crack a hash in this system it is almost impossible. Unless you find out the salt, then you could re-create a complete rainbow table and crack all the passwords.</p>

<h2 id="using-a-user-value-as-salt">Using a user value as salt</h2>

<p>An even better solution is to use a user-value as salt, for example their username or date of birth, or maybe their registration date/time. Now if somebody cracks the database and finds all the data they’ll have to create a new rainbow table for each seperate user (!!!). This is even more secure and preferred over the database-salt.</p>

<h2 id="just-generate-a-random-sequence">Just generate a random sequence…</h2>

<p>But the single best way of salting your database is to generate a large random salt for each user. You can just store this salt in the database next to the hash of the password. This is better then, for example, the username, because there are just less collisions. For example usernames like “root” or “admin” aren’t very uncommon aren’t they? So creating a rainbow table with “root” as salt might be worth the trouble. But creating one with a large random number just for a single user? That is hard and they’ll probably quickly give up.</p>

<h1 id="other-uses-for-this-algorithm">Other uses for this algorithm</h1>

<p>I haven’t been able to come up with a good other use for this algorithm yet, but I have the feeling tons of problems could potentially benefit from it! Can you come up with one?</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/rainbow-tables/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/12/finding-performance-problems/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Dec 14, 2010 13:19:08
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/12/finding-performance-problems/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/12/finding-performance-problems/">Finding performance problems</a></h1>


        <p>Many projects I’ve worked on, especially the projects using micro-optimization, had memory leaks and surprising performance hits. Most coders who work on for example Al Zimmermann’s programming contests use C/C++ and maybe even CUDA to get the most out of their system.</p>

<p>I’m usually using Java, just because I’m most at home in this language. It allows me to quickly get some working code and test some algorithms. But when I reach the final phase of the project it is time to micro-optimize everything.</p>

<p>The first tool I’ve tried it <a href="http://download.oracle.com/javase/6/docs/technotes/guides/visualvm/index.html">Java Visual VM</a>. This tool is available in all the new Sun Oracle JVM’s. Just go to the bin-directory and type <em>jvisualvm</em>. This program will attach to your running code and tries to extract all the information. The good part of this tool is the price, it is free!</p>

<p>But if you really need to know what it going on inside your project, you should try YourKit. YourKit is kindly supporting open source projects with its full-featured Java Profiler. YourKit, LLC is the creator of innovative and intelligent tools for profiling Java and .NET applications. Take a look at YourKit’s leading software products: <a href="http://www.yourkit.com/java/profiler/index.jsp">YourKit Java Profiler</a> and <a href="http://www.yourkit.com/.net/profiler/index.jsp">YourKit .NET Profiler</a>.</p>

<p>If you readers are interested I’ll write a blog with some simple examples on how to fix performance issues in your program, and how to detect these issues using Visual VM and YourKit.</p>

<p>Or I can do a comparison between the leading profilers (YourKit/JProfiler/Visual VM/etc)..?</p>

<p>Let me know!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/12/finding-performance-problems/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/11/xor-doubly-linked-list/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Nov 24, 2010 10:50:02
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/11/xor-doubly-linked-list/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/11/xor-doubly-linked-list/">XOR doubly linked list</a></h1>


        <p>Since a couple of days I’ve been working hard on the new Al Zimmermann’s Programming Contest: <a href="http://azspcs.net/Contest/Cards">Cards</a> (also called Topswops).</p>

<h1 id="the-challenge">The challenge</h1>

<p>The idea is very easy, you take a series of numbers, from 1 to N. You shuffle the numbers around, for example:</p>

<ul>
  <li>5,3,1,2,4</li>
</ul>

<p>Now we reverse the amount of numbers as stated by the first entry in the list. So in this case we reverse 5, and we get:</p>

<ul>
  <li>4,2,1,3,5</li>
</ul>

<p>We keep doing this, now reversing 4:</p>

<ul>
  <li>3,1,2,4,5</li>
  <li>2,1,3,4,5</li>
  <li>1,2,3,4,5</li>
</ul>

<p>At this point, 1 is in front, we are done! No more reversals are possible.</p>

<h1 id="the-problems">The problems</h1>

<p>When implementing this the first thing I did was to create an array and reverse parts of the array by swapping the items around. The problem is that the amount of swaps is pretty big!</p>

<p>So I started thinking about other ways to save the numbers in this challenge.. how about a linked list? This won’t work because when updating the linked list you’ll have to reverse all the pointers in the part you are reversing.</p>

<p>So how about using a doubly linked list? This won’t work because we have to swap the next/previous pointers for all the nodes we reverse.</p>

<h1 id="xor-doubly-linked-list">XOR doubly linked list</h1>

<p>Then I learned about the XOR doubly linked list. Let me explain how it works. The idea is that you don’t have next and previous pointers, but you just have one pointer. This pointer is both the next AND the previous pointer! How is this possible you might ask?</p>

<p>Well, this is where the XOR comes into play. Lets do a tiny bit of math:<br />
A ^ B = C<br />
Now:<br />
C ^ A = B<br />
C ^ B = A</p>

<p>A property of the XOR is, if we have one value, we can calculate what the other value is!</p>

<p>When we create the list we XOR the next and previous together, and we save the pointer to the first element in a seperate pointer. Lets say A = previous, B = next, C = stored value:</p>

<ul>
  <li>previous ^ next = stored value</li>
  <li>stored value ^ previous = next</li>
  <li>stored value ^ next = previous</li>
</ul>

<p>If we traverse our XOR doubly linked list we know the current element and the one before that (previous), so we can always calculate the pointer to the next element!</p>

<h1 id="the-advantages">The advantages</h1>

<p>So why would we do this? It involves a bit more processing power and will obviously save you half of the pointer-memory compared to a normal doubly linked list. We now keep one XOR-ed value instead of two pointers.</p>

<p>But there is another great advantage which might be usefull in the competition I mentioned above, reversability! As stated above using a doubly linked list wasn’t helpfull because when we reverse a part all the previous and next pointers have to be swapped. But we don’t have these pointers anymore, they are XOR-ed into one value! That means that we don’t have to change anything!</p>

<p>Lets assume we have a list of 80 items, and we want to reverse the first 40, what do we need to do now?</p>

<ol>
  <li>Traverse to the 40th element</li>
  <li>Adjust the value of the 40th pointer, now the first element:<br />
TERMINATOR ^ (PTR TO 39)</li>
  <li>Adjust the value of the 1st pointer, it must have<br />
(PTR TO 2) ^ (PTR TO 41)</li>
  <li>Adjust the value of the 41th pointer, it must have<br />
(PTR TO 1) ^ (PTR TO 42)</li>
  <li>Pointer to the first element is now 40 (this has become our first element)</li>
</ol>

<p>Done! We have adjusted three pointers and nothing in the middle. B.t.w. TERMINATOR is a value which indicates the boundaries of the first and last elements, I’ve used -1 for this. When traversing we use this to check if we are done.</p>

<p>Lets traverse the above reversed list, first we go to the first element (40) and perform the following XOR:</p>

<ul>
  <li>stored_value (40) ^ TERMINATOR = next (39)</li>
</ul>

<p>This will result in 39, now we continue:</p>

<ul>
  <li>stored_value (39) ^ previous (40) = next (38)</li>
  <li>stored_value (38) ^ previous (39) = next (37)</li>
  <li>…</li>
  <li>stored_value (2) ^ previous (3) = next (1)</li>
  <li>stored_value (1) ^ previous (2) = next (41) !!</li>
  <li>stored_value (41) ^ previous (1) = next (42) !!</li>
  <li>stored_value (42) ^ previous (41) = next (43) etc etc</li>
</ul>

<p>It works!</p>

<h1 id="a-bit-of-dissapointment">A bit of dissapointment</h1>

<p>After implementing this it doesn’t seem to be faster then using swaps to reverse everything in the whole array. This is probably due to a couple of things:</p>

<ul>
  <li>The locality of a normal array is faster in memory</li>
  <li>You’ll have to traverse N-nodes to reach the target to reverse</li>
  <li>The competition has max 97 elements, this might be too small to see the advantage</li>
</ul>

<p>My algorithm until now only used a single pointer to keep track of the first element, but it might be usefull to also keep a pointer to the last element. For example if we need to reverse everything up to N-1, I need to traverse from 1 to N-1. But if you have a last-element pointer, using the doubly in the XOR doubly linked list, we can just go backwards from N.</p>

<p>Ah well, it might not have been usefull (yet?) but it is a beautiful algorithm!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/11/xor-doubly-linked-list/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/11/patent-infrigement-part-2/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Nov 24, 2010 09:56:46
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/11/patent-infrigement-part-2/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/11/patent-infrigement-part-2/">Patent infringement (part 2)</a></h1>


        <p>After a lot of comments on my blog asking about the code I decided to try getting it released one more time. Thus I mailed Digital Landmark Services again, telling them this is just a hobby project, and will (in its current form) never be a replacement for Shazam. Also, I explained a lot of people hated Shazam and deleted the application after reading this blog… the only thing they got out of it is bad marketing.</p>

<p>So I asked them for a peaceful solution, I’ll release the code, tell everybody Landmark Digital Services is a good company after all, and that’s it, both will benefit.</p>

<p>This is the reply I got:</p>

<blockquote>
  <p>Dear Mr. Van Rijn,</p>

  <p>I am an attorney for Landmark Digital Services. Thank you for your response and attention to this important matter. As we have stated in detail in previous communications, we would like you to refrain from releasing the code and to remove the blogpost explaining the algorithm. While we appreciate your thoughtful comments and questions, we have already made our position clear and hope you will respect our interest in our IP.</p>

  <p>Sincerely,<br />
XXX<br />
Attorney<br />
Woodcock Washburn</p>
</blockquote>

<p>WHAT!? They tell me again to remove the blogpost, this is crazy! A blogpost describing an algorithm can never be infrigement of intellectual property. The whole idea of a patent is to preserve an idea, to write down what it does and how it works for future generations. A patent has to be publicly available for this sole reason. This isn’t protecting their intellectual property, this is plain censorship.</p>

<p>My reply to the email was short an concise:</p>

<blockquote>
  <p>I’m sorry, but I can’t comply.</p>

  <p>Good luck.</p>
</blockquote>

<p>This was a week ago, lets see what they come up with this time…</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/11/patent-infrigement-part-2/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/09/handling-frame-switching/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Sep 23, 2010 12:37:02
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/handling-frame-switching/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/09/handling-frame-switching/">Handling 'Frame switching'</a></h1>


        <p>A couple of days ago I noticed this tweet:  </p>

<p><strong><a href="http://twitter.com/berenguel/status/25061642637">berenguel</a>: What is your view on ‘frame switching’?How do you manage (forced) interruptions of your workflow?How do you get the interruptor to give up?</strong>  </p>

<p>This is something I’m currently not experiencing, but I have been fighting this in the past. And I’ve come up with a quite effective way to eliminate this.  </p>

<p><img src="/images/post-it-300x199.jpg" alt="Post-it" class="alignright" /></p>

<h1 id="priority-todo-list">Priority todo-list</h1>

<p>I’m just a regular guy, and just like all men I can only focus on a single thing. Context swithing/frame of reference switching is hard. If I’m working on a programming problem and people interrupt me, ask other technical questions, I lose my train of thought.</p>

<p>So, how do you counter this? Well, first I made a list of things to do. This is always good to have, it directs your focus. My list is priorized. For example:</p>

<ul>
  <li>Implement “General overview” page</li>
  <li>Fix bug with disappearing “Solve” button</li>
  <li>Refactor OfflineAvailableController</li>
  <li>Fix table layout bug</li>
</ul>

<p>Yay!</p>

<h1 id="coffee-time">Coffee time!</h1>

<p>The top post-it is the one I’m working on, that one has my complete focus. When the project lead comes and asks me questions, I ask him to prioritize it. He can add post-its to the list and/or shuffle the list. But there is one catch: Every time he changes or I finish the top priority I need a coffee break. This is my frame-switching moment, to clear my head.</p>

<p>If you do this, and keep doing this (no exceptions!) the project lead will start putting his ‘requests’ (interruptions) beneath your current piece of work, without distracting you. Because else you go for a cup of coffee first…. This is what we want. When we finish what we are currently doing we get a little coffee break. When we’ve fully cleared our head we look at the next item in the todo-queue.</p>

<p>Don’t worry, it may sound a bit rude, they’ll understand it if you explain the problem with frame-switching…! This just makes it visible.</p>

<p>p.s. Berengual will probably write a blog post about his own experiences with frame-switching, I’ll post a link when he does!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/handling-frame-switching/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/09/bug-fix-day/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Sep 22, 2010 16:25:36
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/bug-fix-day/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/09/bug-fix-day/">Bug Fix Day!</a></h1>


        <p>After a couple of iterations our software started to show some wear and tear. With all fat-GUI clients you always have some behaviour that isn’t exacly what you want, there are always glitches. More and more (Scrum) iterations followed and more and more glitches started accumulating in the application. These glitches are sometimes hard to fix and/or hard to reproduce, and they never made their way to our backlog.<br />
<img src="/images/computer-bug-300x199.jpg" alt="computer-bug" class="alignright" /></p>

<p>How do you solve this?</p>

<h2 id="bug-fix-day-concept">“Bug Fix Day” concept</h2>

<p>To improve the quirkiness and general impression of our application, as well as the teamspirit, I decided to hold a competition! This is how we did it:</p>

<h3 id="the-teams">The teams</h3>

<ol>
  <li>Take everybody, testers, project managers and of course the developers. Mix and create small groups of three (maybe four) people with a mixed skillset.  </li>
  <li>Create a jury, in our case the two product-owners and a GUI-expert.  </li>
  <li>One day the teams compete against eachother.</li>
</ol>

<h3 id="the-boards">The boards:</h3>

<p>You’ll also need two board:</p>

<ol>
  <li>Create a <strong>BugBoard</strong> with (on Post-its) all known existing glitches and bugs which need fixing.  </li>
  <li>Create a <strong>TeamsBoard</strong> with a list of all the teamnames (make them come up with cool names!)</li>
</ol>

<h3 id="jury">Jury:</h3>

<p>The jury (product owners) must assign points to all the known bugs on the BugBoard, ranging from 1 point to 10 points.</p>

<ul>
  <li>1 point: minor importance</li>
  <li>…</li>
  <li>…</li>
  <li>10 points: important! fix asap</li>
</ul>

<h2 id="scoring-points">Scoring points</h2>

<p>Now the teams can do two things:</p>

<h3 id="fix-a-bug">Fix a bug</h3>

<p>Take a Post-it from the BugBoard and paste it behind your teamname on the TeamsBoard. There is a maximum of <strong>1 (!!)</strong> Post-it. Your team can only claim and work on one bug at the time. While you are doing this, nobody can work on that same bug.</p>

<p>When you have implemented a fix for the bug, commit it, let the jury check the result. Once the jury has verified the fix, you’ll get the assigned points!</p>

<h3 id="find-a-bug">Find a bug</h3>

<p>If you want you can also scan the application for new glitches and bugs. If you have found a (<strong>repeatable</strong>) bug, document it on a Post-it and give it to the jury. If they can reproduce the glitch/bug, they’ll assign points to the bug. For finding the bug you’ll receive half the bug’s points.</p>

<h2 id="extra-rules">Extra rules</h2>

<p>There are a couple of extra rules:<br />
1. The teams can only work on <strong>one</strong> workstation. You’ll have to pair up and work together. This will enforce the teams to look at each others code and learn.</p>

<ol>
  <li>
    <p>If you break the (continuous) build, you’ll lose points. For every minute the build is not green, a point is deducted from your team’s score.</p>
  </li>
  <li>
    <p>At the end of the day all the teams have to present their fixes.<br />
This will show everybody a couple of things:</p>
  </li>
</ol>

<ul>
  <li>How was the bug fixed?</li>
  <li>What was wrong?</li>
  <li>How could it have been prevented?</li>
</ul>

<ol>
  <li>Bonus points! To make it even more exiting we’ve introduced bonus points. Try to come up with original ideas! This is our list:</li>
</ol>

<ul>
  <li>Most impressive presentation: 2 points</li>
  <li>Hardest bug to fix: 2 points</li>
  <li>Best team name: 1 point</li>
  <li>Most original found bug: 1 point</li>
</ul>

<h1 id="possible-problems">Possible problems</h1>

<p>Of course there are possible problems you want to avoid:<br />
- People saving up bug-fixes<br />
- People introducing bugs, solve on bug fix day.<br />
- People not telling about glitches, report them on bug fix day.</p>

<p>We haven’t seen this behaviour yet, but you’ll have to trust the developers. Our team has enough professionalism to not have this problem (yet?).</p>

<h1 id="results">Results</h1>

<p>When I suggested this idea to our product owners they were very enthusiastic. About a week later we had our first Bug Fix Day and the results are very impressive.</p>

<ol>
  <li>All of the 10-point (most important) bugs had been solved  </li>
  <li>Most other bugs/glitches had been resolved  </li>
  <li>Despite people actively abusing the system, not a lot of new glitches could be found (in contrary to our impression).  </li>
  <li>Developers loved it, teamspirit was very high. It was fun to see the competitive instinct during that day.  </li>
  <li>Our team won, and got a very good lunch as surprise first prize (yay!).</li>
</ol>

<p>Other idea’s this concept could work for:<br />
- Performance Fix Day (improve performance)<br />
- Funny Features Day (build new features into the application)<br />
- Other ideas…?</p>

<p>If you decide to hold a Bug Fix Day at your company, I’d love to hear about the results!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/bug-fix-day/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/09/annotated-field-injection-vs-constructor-injection/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Sep 21, 2010 11:35:41
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/annotated-field-injection-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/09/annotated-field-injection-vs-constructor-injection/">(Annotated) Field injection vs Constructor injection</a></h1>


        <p>A couple of people replied to my last article about constructor vs setter injection that they prefer a third option, field injection. This is a slight variant of setter injection in which we magically let the setter dissapear.</p>

<p>So, another blogpost here!</p>

<p>Let me first show what field injection looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Apple</span> <span class="o">{</span>  
    <span class="nd">@Inject</span>  
    <span class="kd">private</span> <span class="n">Orange</span> <span class="n">orange</span><span class="o">;</span>  
<span class="o">}</span></code></pre></figure>

<p>This is an example from the PicoContainer website, but Spring and Google Guice can do this too. So, you ask, what is wrong with this?</p>

<h1 id="testability">Testability</h1>

<p>I want the classes I write to be testable. Every class needs a test, and every class needs to be tested without the help of any other dependency. For every dependency in my class I want to be able to use a stub/mock implementation.</p>

<p>With constructor injection this is easy, just do new SomeClass(…). But this just can’t be done with field injection..! How do you test these classes? You have no way to construct the objects without bytecode-magic. You cannot create an instance of the above Apple class with its dependencies without using the DI-framework. And the last thing I want is the DI-framework in my unit tests. It makes the test slow, and as we all know, tests need to run as fast as possible to be effective.</p>

<h1 id="final-is-still-tricky">Final is still tricky</h1>

<p>When using field injection your fields can be made private, but you can’t make them final (!!). This is a common mistake, but look at the Google Guice wiki: <a href="http://code.google.com/p/google-guice/wiki/Injections">http://code.google.com/p/google-guice/wiki/Injections</a>.</p>

<p>Note the <strong>warning</strong>: “Avoid using field injection with final fields, which has weak semantics.”</p>

<h1 id="code-smell-is-wanted">Code smell is wanted</h1>

<p>And the final thing I don’t like about field injection… it looks good. This is a bad thing! I tried to explain this in the previous blogpost, but failed I guess. When using constructor injection you’ll notice when it gets ugly, you’ll see that long ugly constructor… and you’ll refactor the class. When using field injection this warning is forgotten.</p>

<p>Large constructor equals bad design. Don’t fix this by changing to setter or field injection, fix the underlying problem and improve your class granularity. The fact that is looks bad with more then 2 or 3 arguments is actually a big <strong>plus</strong>!</p>

<h1 id="annotations">Annotations</h1>

<p>Yes, annotations bind you to the framework, and they are evil. But so is XML. I have to agree on one thing, annotations (javax.inject) are a good thing. But still use constructor injection with these annotations please!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/annotated-field-injection-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/09/setter-vs-constructor-injection/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Sep 20, 2010 22:59:44
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/setter-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/09/setter-vs-constructor-injection/">Setter vs Constructor injection</a></h1>


        <p>Recently I’ve had a discussion with a collegue about Setter vs Constructor injection. For those who don’t know what I’m talking about a quick example:</p>

<p>Setter injection:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeClass</span> <span class="o">{</span>
	
	<span class="kd">private</span> <span class="n">SomeDependency</span> <span class="n">someDependency</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="nf">SomeClass</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">//Empty constructor</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSomeDependency</span><span class="o">(</span><span class="n">SomeDependency</span> <span class="n">someDependency</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">someDependency</span> <span class="o">=</span> <span class="n">someDependency</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Constructor injection:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeClass</span> <span class="o">{</span>
	
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">SomeDependency</span> <span class="n">someDependency</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="nf">SomeClass</span><span class="o">(</span><span class="kd">final</span> <span class="n">SomeDependency</span> <span class="n">someDependency</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">someDependency</span> <span class="o">=</span> <span class="n">someDependency</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Ever since I’ve used constructor injection, I’ve never wanted to go back. For a good reason I might add. Constructor injection is just better, no discussion. Please allow me to explain.</p>

<h1 id="safe-construction">Safe construction</h1>

<p>First of all there is safety. In the case of setter injection it is perfectly possible to create the object without calling the setter(s). This would leave SomeClass in an uninitialized state. With constructor injection this could never happen, you just can’t create the object without at least deliberately ignoring (null-ing) the arguments.</p>

<p>Also, if you add a new dependency and forget to add the dependency in the XML… you’ll end up with weird behaviour and NPE’s while running your code. If you use constructor injection is would fail on startup because the correct constructor couldn’t be found. Failing early.</p>

<h1 id="finalization">Finalization</h1>

<p>In the case of constructor injection you can make the dependencies final, this is something you just can’t do with setter injection. This will further ensure the atomicity of SomeClass, it just can’t exist without its dependency. And there are many many more reasons using ‘final’ is a good idea (google it).</p>

<h1 id="but-isnt-constructor-injection-less-readable">But… isn’t constructor injection less readable?</h1>

<p>The only argument I’ve heard made against constructor injection is the fact that it becomes unreadable if you have too much incoming dependencies. But that argument is completely invalid!</p>

<p>The problem isn’t the constructor injection, it is a code smell. If your class has too much incoming dependencies you should reconsider this class. There is a good chance it is doing too much or having too much responsibilities.</p>

<p>So, it is actualy a good thing that constructor injection becomes aweful with too much dependencies, it is a code-smell! If the list of incoming dependencies grows too large you need to refactor, not blame constructor injection.</p>

<p>With setter injection it wouldn’t be almost invisible, a bad thing.</p>

<h1 id="conclusion">Conclusion…</h1>

<p>In every single way constructor injection beats setter injection, so please only use constructor injection from now, k? bye!</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/setter-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/09/dinosaur-in-your-street/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Sep 14, 2010 15:40:16
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/dinosaur-in-your-street/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/09/dinosaur-in-your-street/">Dinosaurize your street</a></h1>


        <p>After looking at <a href="http://www.thewildernessdowntown.com/">The Wilderness Downtown</a>, a fantastic Chrome Experiment, I felt like I had to do something similair! Three hours later (first time experimenting with Google Maps and Street View) the result is below.</p>

<p>It is nothing like The Wilderness Downtown, but still I’d like to share it ;-)</p>

<p>Enter streetname, town and country:  </p>

<p><img src="/images/" alt="Image 1" /><br />
<img src="/images/" alt="Image 1" /><br />
<img src="/images/" alt="Image 1" /></p>

<p><img src="/images/walking.gif" alt="walking" /></p>

<p>Yes, there are a LOT of bugs… And no, I’m not going to fix them, so there is no need to notify me.<br />
Some known bugs:</p>

<ul>
  <li>Sometimes the dinosaur moonwalks (images go backwards)</li>
  <li>Locations aren’t always found, it depends on Google Street View</li>
  <li>It can only walk from the startingpoint to the next junction, no complete routes.</li>
</ul>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/09/dinosaur-in-your-street/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/07/patent-publicity/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jul 9, 2010 21:29:27
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/07/patent-publicity/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/07/patent-publicity/">Patent, publicity</a></h1>


        <p>Wow, just wow…</p>

<p>Thanks a lot for all your support people, it’s great to see and read I’m not the only one to think this situation isn’t normal.</p>

<h1 id="social-networking">Social networking:</h1>

<p>First it became huge on social network sites:<br />
- #1 on yCombinator Hacker News: <a href="http://news.ycombinator.com/item?id=1496683">here</a><br />
- #1 on Reddit: <a href="http://www.reddit.com/r/programming/comments/cn79s/apparently_describing_a_patented_algorithm_is/">here</a><br />
- Frontpage on Slashdot: <a href="http://yro.slashdot.org/story/10/07/08/2311225/Open-Source-Music-Fingerprinter-Gets-Patent-Nastygram">here</a><br />
- DZone Top Link: <a href="http://www.dzone.com/links/after_creating_shazam_in_java_patent_infringement.html">here</a><br />
- Digg: <a href="http://digg.com/programming/When_amateur_programming_meets_patent_infringement">here</a></p>

<h1 id="blogs-and-news-sites">Blogs and news sites:</h1>

<p>And it was featured on some major blogs/news sites:</p>

<p>- BoingBoing: <a href="http://www.boingboing.net/2010/07/08/patent-holders-legal.html">here</a><br />
- OpenDotDotDot: <a href="http://opendotdotdot.blogspot.com/2010/07/patent-bullying-over-algorithms.html">here</a><br />
- Webwereld (Dutch): <a href="https://secure.webwereld.nl/nieuws/66518/open-source-shazam-kopie-stopt-onder-patentdruk.html">here</a><br />
- TechDirt: <a href="http://delta.techdirt.com/articles/20100708/04230710128.shtml">here</a><br />
- The Command Line: <a href="http://thecommandline.net/2010/07/08/patent-threat-for-posting-partial-sources-to-a-weekend-project/">here</a><br />
(and many more)</p>

<h1 id="twitter">Twitter</h1>

<p>Also, it is a hit on Twitter too, with hunderds of retweets and people taking aim at Shazam:</p>

<p>(which might be a bit unfair since Landmark Digital Services LLC is the complaining patent holder, not Shazam, but I’m not sure how they relate)</p>

<p>``</p>

<p>``</p>

<p><code>springify: RT @StefanRoock: RT @mittie RT @merbist: wow the Shazam guys are real jerks: http://sites.google.com/site/redcodenl/ #wtf   asgerhallas: RT @tomasekeli: Hey #shazam, you suck :) Software patents, seriously uncool. Being a dick, even more so. #shazamfail http://bit.ly/cm4Y5f (via @blakefate)   gerharbo: Patent issues ivm Shazam. Een developer uit nl heeft code in java, shazam niet blij http://sites.google.com/site/redcodenl/   unimatrixZxero: RT @ralph: Now that I've found SoundHound, I can safely delete the app from the jerks that made Shazam: http://sites.google.com/site/redcodenl/   LuisBenavides: RT @stilkov: Software patents just suck RT @merbist: wow the Shazam guys are real jerks: http://sites.google.com/site/redcodenl/</code></p>

<p><code>...etc etc etc...  </code></p>

<h1 id="thanks-again">Thanks again!</h1>

<p>So thanks again for the support and the emails en tweets and blogs… I’m going to wait and see now what the next reply from Landmark Digital Services LLC will be. In the mean time, with the article available you should be able to create something similair for yourself.</p>

<p>Or just take the describing scientific paper and/or the patent itself, that should be sufficient (and it isn’t too mathematical, nor hard).</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/07/patent-publicity/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/07/patent-infringement/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jul 7, 2010 22:15:34
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/07/patent-infringement/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/07/patent-infringement/">Patent infringement</a></h1>


        <p>Some time ago I received the following email about <a href="/blog/2010/06/creating-shazam-in-java/">this</a> project.  </p>

<blockquote>

  <p>-–<br />
Mr. van Rijn,</p>

  <p>I am Darren Briggs, the Chief Technical Officer of Landmark Digital Services, LLC. Landmark Digital Services owns the patents that cover the algorithm used as the basis for your recently posted “<a href="/blog/2010/06/creating-shazam-in-java/">Creating Shazam In Java</a>”. While it is not Landmark’s intention to alienate those in the Open Source and Music Information Retrieval community, Landmark must request that you do not ship, deploy or post the code presented in your post. Landmark also requests that in the future you do not ship, deploy or post any portions or versions of this code in its current state or in any modified state.</p>

  <p>We hope you understand our position and that we would be legally remiss not to make this request. We appreciate your immediate attention and response.</p>

  <p>Best regards,</p>

  <p>Darren P. Briggs<br />
Vice President &amp;<br />
Chief Technical Officer<br />
Landmark Digital Services, LLC<br />
-–  </p>

</blockquote>

<p>This scared me a bit, why are they emailing me? I’ve written some code (100% my own) and implemented my own methods for matching music. There are some key differences with the algorithm Shazam uses.</p>

<p>The code isn’t published yet, but I was planning on releasing it under Apache License to the open source community soon.</p>

<p>It was never my intention to release this commercially, I’m just a programmer who likes to work on technical, mathematical algorithms in his spare time. And if enough people ask for the source code, I’d be happy to give it to them. Who would have thought that creating something at home in a weekend could result in a possible patent infringement!?</p>

<p>Just to be sure I asked them confirmation that the email was indeed sent from their company. And second, I’d like to know which patents are in play. Because I just couldn’t think that something this easy (music-fingerprint is a hash, and we do a lookup) can be patented.. Maybe in the States, but in Europe?</p>

<p>I got the following reply from Landmark Digital Services LLC:  </p>

<blockquote>

  <p>-–<br />
Mr. van Rijn,</p>

  <p>I can confirm that the email you received came from me on behalf of Landmark Digital Services, LLC. If you require a more formal notification, the Landmark legal department can provide you with a legal notification. Please let me know if that would be preferable.</p>

  <p>The Landmark patents have been granted around the world, including the US, the EU, individual EU-member countries.</p>

  <p>Examples of some of the Landmark patents include:<br />
- System and Methods for Recognizing Sound and Music Signals in High Noise and Distortion<br />
- Robust and Invariant Audio Pattern Matching</p>

  <p>We appreciate your compliance with our request.</p>

  <p>Best regards,</p>

  <p>Darren P. Briggs<br />
Vice President &amp;<br />
Chief Technical Officer<br />
Landmark Digital Services, LLC<br />
-–  </p>

</blockquote>

<p>They are really serious about this. But there is a problem, I still don’t have patent numbers of European patents, so there is no way for me to check the validity of their claims. Once again I asked them for specific patent numbers. And got the following reply:</p>

<blockquote>

  <p>-–<br />
Mr. van Rijn,</p>

  <p>The US patent numbers for the two examples I provided you are 6,990,453 and 7,627,477. Note that there are additional issued patents and pending patent applications in the US and Eu that cover these concepts as well.</p>

  <p>Best regards,</p>

  <p>Darren<br />
P. Briggs<br />
Vice President &amp;<br />
Chief Technical Officer<br />
Landmark Digital Services, LLC<br />
-–  </p>

</blockquote>

<p>Sigh, again two U.S. patent numbers. But well, lets take a step back. Why does Landmark Digital Services think they hold a patent for the concepts used in my code? Even if my code works pretty different from the Shazam code (from which the patents came).</p>

<p>What they describe in the patent is a system which:<br />
1. Make a series of fingerprints of a media file and/or media sample<br />
     (such as audio, but could also be text, video, multimedia, etc)<br />
2. Have a database/hashtable of fingerprints as lookup<br />
3. Compare the set of hashtable hits using their moment in time it happened</p>

<p>This is very vague, basically the only innovative idea is matching the found fingerprints linearly in time. Because the first two steps describe how a hashtable works and creating a hash works. These concepts are not new nor innovative.</p>

<p>But, with a bit of imagination one could (possibly) argue that my code (again, written completely by myself in a weekend with some spare time) does the same thing as the patent describes.</p>

<p>Just to be sure I asked around for advice, including help from the <a href="http://fsf.org/">FSF</a> (Free Software Foundation) and the <a href="http://www.eff.org/">EFF</a> (Electronic Frontier Foundation). They forwarded my questions to<a href="http://www.bof.nl/"> Bits of Freedom</a> a Dutch organisation for digital rights.</p>

<p>After a good conversation with Ot van Daalen (from Bits Of Freedom) he suggested I contact <a href="http://www.arnoud.engelfriet.net/">Arnoud Engelfriet</a>, a Dutch ICT lawyer and patent attorney with a lot of knowledge about software patents.</p>

<p>In the last couple of days I’ve had quite a few conversations with Arnoud, and he helped me with a lot of my questions.</p>

<p>Here are some of the conclusions:</p>

<ul>
  <li>Software companies can make your life very miserable if you don’t comply;</li>
  <li>Using the Java-Music Match code commercially will likely result in a lawsuit for patent infringement;</li>
  <li>Releasing the code under an Open Source license on a non-profit website (no ads) is a grey area;</li>
  <li>Writing/using this code privately can’t be patent infringement in the Netherlands;</li>
</ul>

<p>And even the Arnoud even mailed me:  </p>

<blockquote>

  <p>-–<br />
Als je de software laat staan, loop je de kans dat Landmark Digital Services je een proces aandoet. En zoals gezegd kan dat een fiks bedrag worden.</p>

  <p>Translation:<br />
If you leave the software on your website, you run the risk that Landmark Digital Services files a patent infringement lawsuit. And like I told you, this could result in a substantial amount of money.<br />
-–  </p>

</blockquote>

<p>Since I don’t want to end up like <a href="http://en.wikipedia.org/wiki/Dmitry_Sklyarov">Dmitry Sklyarov</a>, with the possibility of a lawsuit, I’m not going to publish the code anymore… Grey area’s with lawsuits roaming around are better to be avoided. Especially if you think about the average cost of a patent lawsuit being 1 to 3 million dollars.</p>

<p>In the latest email I received from Landmark Digital Services they are even asking for more:  </p>

<blockquote>

  <p>-–<br />
Mr. Van Rijn,</p>

  <p>The two example patent numbers that I sent you are U.S. patents, but each of these patents has also been filed as patent applications in the Netherlands. Also, as I’m sure you are aware, your blogpost may be viewed internationally. As a result, you may contribute to someone infringing our patents in any part of the world.</p>

  <p>While we trust your good intentions, yes, we would like you to refrain from releasing the code at all and to remove the blogpost explaining the algorithm.</p>

  <p>Thank you for your understanding.</p>

  <p>Best regards,</p>

  <p>Darren<br />
P. Briggs<br />
Vice President &amp;<br />
Chief Technical Officer<br />
Landmark Digital Services, LLC<br />
-–  </p>

</blockquote>

<p>They are still unable to direct me to the correct Dutch patent numbers. But more shocking, they are now telling me that my blogpost may contribute internationally to patent infringement. But… doesn’t the patent itself describe their algorithm in much more detail? The idea of patents are that the world knows about technology and how it can be used, but they can’t legally commercially exploit it? Now next to asking me not to release the code, they are also asking me to remove the previous blogpost!</p>

<p>This seems like a very unjust threat to me, and for now I’m going to ignore that request. If they decide to file a formal legal complaint I might reconsider taking down the blogpost. The only action I’ll take right now is not releasing the source code.</p>

<h1 id="other-implementations">Other implementations</h1>

<p>I’ve also had contact with other people who have implemented this kind of algorithms. Most notible is Dan Ellis. His implementation can be found here: <a href="http://labrosa.ee.columbia.edu/~dpwe/resources/matlab/fingerprint/">http://labrosa.ee.columbia.edu/~dpwe/resources/matlab/fingerprint/</a></p>

<p>He hasn’t been contacted (yet?), but he isn’t planning on taking his MatLab implementation down anyway and has agreed for me to place the link here. This raises another interesting question, why are they targetting me, somebody who hasn’t even published the code yet, and not the already published implementation of Dan?!</p>

<p>And if they think its illegal to explain the algorithm, why aren’t they going after this guy? <a href="http://laplacian.wordpress.com/2009/01/10/how-shazam-works/">http://laplacian.wordpress.com/2009/01/10/how-shazam-works/</a></p>

<p>This is where I got the idea to implement the algorithm and it is mentioned in my own first post about the Java Shazam.</p>

<h1 id="any-advice">Any advice?</h1>

<p>So, has anybody else had these kind of experiences? What would you do in this situation?</p>

<p>Maybe I’m going to need it, maybe I’ll just buy a beer, every penny is welcome:<br />
<a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=85FHHH25ZUMMN"><img src="/images/btn_donateCC_LG.gif" alt="btn_donateCC_LG.gif" /></a></p>

<h1 id="next">Next:</h1>

<p>The patent infrigement story <a href="/blog/2010/11/patent-infrigement-part-2/">continues here…</a></p>

<p>ps. I’m sorry John Metcalf: You can stop printing “Free Roy van Rijn” t-shirts…</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/07/patent-infringement/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/06/music-matching-part-deux/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jun 6, 2010 19:37:15
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/music-matching-part-deux/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/06/music-matching-part-deux/">Music Matching (part deux)</a></h1>


        <p>After a comment on my previous blog entry (about creating a shazam clone) I started tinkering again.</p>

<p>Somebody asked: Could this be used to detect duplicate songs in my mp3 collection!?</p>

<p>That is exacly what I just tried!  </p>

<h1 id="the-results">The results</h1>

<p>Here are some examples:  </p>

<p><strong>Duplicate found: 01 - everything in its right place.mp3.song matches with D:\data\v2\01-radiohead-everything_in_it’s_wrong_place-h8me.mp3.song and score: 134</strong><br />
(note: This is a remix of the original, with some rap mixed in)</p>

<p><strong>Duplicate found: 01 - Joy Division - Exercise One.mp3.song matches with D:\data\v2\114 - Joy Division - Exercise One (From Still).mp3.song and score: 255</strong><br />
(note: Yes, duplicate!)</p>

<p><strong>Duplicate found: 01 The District Sleeps Alone Tonight.mp3.song matches with D:\data\v2\The Postal Service - The District Sleeps Alone Tonight.mp3.song and score: 636</strong><br />
(note: Yes, duplicate!)</p>

<p><strong>Duplicate found: 01-AudioTrack 01.mp3.song matches with D:\data\v2\06.Richard cheese -Id like a virgin- Butterfly.mp3.song and score: 144</strong><br />
(note: Yes, duplicate, the second was a radio snippet with jingle in the song)</p>

<p><strong>Duplicate found: 01-editors-papillon_edit.mp3.song matches with D:\data\v2\02-editors-papillon_instrumental_edit.mp3.song and score: 382</strong><br />
(note: Almost a duplicate, the second is an instrumental version of the first)</p>

<p><strong>Duplicate found: 01-the_strokes-you_only_live_once-ser.mp3.song matches with D:\data\v2\01-the_strokes-you_only_live_once.mp3.song and score: 450</strong><br />
(note: Yes, duplicate!)</p>

<p><strong>Duplicate found: 01-the_wombats-backfire_at_the_disco.mp3.song matches with D:\data\v2\Backfire @ The Disco [Promo Version].mp3.song and score: 493</strong><br />
(note: Yes, almost duplicate, the second is a radio-promo announcement with jingle in it)</p>

<h1 id="conclusion">Conclusion</h1>

<p>With a bit of tinkering this algorithm could be used to make a tool to detect duplicate songs, even if the mp3’s aren’t similair. Even live versions and instrumental versions are detected if you lower the threshold.</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/music-matching-part-deux/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/06/creating-shazam-in-java/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Jun 1, 2010 01:43:08
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/creating-shazam-in-java/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/06/creating-shazam-in-java/">Creating Shazam in Java</a></h1>


        <p>A couple of days ago I encountered this article: <a href="http://laplacian.wordpress.com/2009/01/10/how-shazam-works/">How Shazam Works</a></p>

<p>This got me interested in how a program like Shazam works… And more importantly, how hard is it to program something similar in Java?</p>

<h1 id="about-shazam">About Shazam</h1>

<p>Shazam is an application which you can use to analyse/match music. When you install it on your phone, and hold the microphone to some music for about 20 to 30 seconds, it will tell you which song it is.</p>

<p>When I first used it it gave me a magical feeling. “How did it do that!?”. And even today, after using it a lot, it still has a bit of magical feel to it.<br />
Wouldn’t it be great if we can program something of our own that gives that same feeling? That was my goal for the past weekend.</p>

<h1 id="listen-up">Listen up..!</h1>

<p>First things first, get the music sample to analyse we first need to listen to the microphone in our Java application…! This is something I hadn’t done yet in Java, so I had no idea how hard this was going to be.</p>

<p>But it turned out it was very easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">AudioFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="n">getFormat</span><span class="o">();</span> <span class="c1">//Fill AudioFormat with the wanted settings</span>
<span class="n">DataLine</span><span class="o">.</span><span class="na">Info</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataLine</span><span class="o">.</span><span class="na">Info</span><span class="o">(</span><span class="n">TargetDataLine</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">format</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">TargetDataLine</span> <span class="n">line</span> <span class="o">=</span> <span class="o">(</span><span class="n">TargetDataLine</span><span class="o">)</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="na">getLine</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
<span class="n">line</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">format</span><span class="o">);</span>
<span class="n">line</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre></figure>

<p>Now we can read the data from the TargetDataLine just like a normal InputStream:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// In another thread I start:</span>

<span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
<span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;I/O problems: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Using this method it is easy to open the microphone and record all the sounds! The AudioFormat I’m currently using is:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">AudioFormat</span> <span class="nf">getFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">float</span> <span class="n">sampleRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">sampleSizeInBits</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">//mono</span>
    <span class="kt">boolean</span> <span class="n">signed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">bigEndian</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">AudioFormat</span><span class="o">(</span><span class="n">sampleRate</span><span class="o">,</span> <span class="n">sampleSizeInBits</span><span class="o">,</span> <span class="n">channels</span><span class="o">,</span> <span class="n">signed</span><span class="o">,</span> <span class="n">bigEndian</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>So, now we have the recorded data in a ByteArrayOutputStream, great! Step 1 complete.</p>

<h1 id="microphone-data">Microphone data</h1>

<p>The next challenge is analyzing the data, when I outputted the data I received in my byte array I got a long list of numbers, like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0
0
1
2
4
7
6
3
-1
-2
-4
-2
-5
-7
-8
(etc)</code></pre></figure>

<p>Erhm… yes? This is sound?</p>

<p>To see if the data could be visualized I took the output and placed it in Open Office to generate a line graph:</p>

<p><a href="/images/graph.png"><img src="/images/graph-300x248.png" alt="graph" /></a></p>

<p>Ah yes! This kind of looks like ‘sound’. It looks like what you see when using for example Windows Sound Recorder.</p>

<p>This data is actually known as <a href="http://en.wikipedia.org/wiki/Time_domain">time domain</a>. But these numbers are currently basically useless to us… if you read the above article on how Shazam works you’ll read that they use a <a href="http://en.wikipedia.org/wiki/Spectrum_analyzer">spectrum analysis</a> instead of direct time domain data.<br />
So the next big question is: How do we transform the current data into a spectrum analysis?</p>

<h1 id="discrete-fourier-transform">Discrete Fourier transform</h1>

<p>To turn our data into usable data we need to apply the so called <a href="http://en.wikipedia.org/wiki/Discrete_Fourier_transform">Discrete Fourier Transformation</a>. This turns the data from time domain into frequency domain.<br />
There is just one problem, if you transform the data into the frequency domain you loose every bit of information regarding time. So you’ll know what the magnitude of all the frequencies are, but you have no idea when they appear.</p>

<p>To solve this we need a sliding window. We take chunks of data (in my case 4096 bytes of data) and transform just this bit of information. Then we know the magnitude of all frequencies that occur during just these 4096 bytes.</p>

<h1 id="implementing-this">Implementing this</h1>

<p>Instead of worrying about the Fourier Transformation I googled a bit and found code for the so called FFT (Fast Fourier Transformation). I’m calling this code with the chunks:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">byte</span> <span class="n">audio</span><span class="o">[]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>

<span class="kd">final</span> <span class="kt">int</span> <span class="n">totalSize</span> <span class="o">=</span> <span class="n">audio</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">amountPossible</span> <span class="o">=</span> <span class="n">totalSize</span><span class="o">/</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">;</span>

<span class="c1">//When turning into frequency domain we&#39;ll need complex numbers:</span>
<span class="n">Complex</span><span class="o">[][]</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Complex</span><span class="o">[</span><span class="n">amountPossible</span><span class="o">][];</span>

<span class="c1">//For all the chunks:</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">amountPossible</span><span class="o">;</span> <span class="n">times</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">Complex</span><span class="o">[]</span> <span class="n">complex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Complex</span><span class="o">[</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">];</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">//Put the time domain data into a complex number with imaginary part as 0:</span>
        <span class="n">complex</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Complex</span><span class="o">(</span><span class="n">audio</span><span class="o">[(</span><span class="n">times</span><span class="o">*</span><span class="n">Harvester</span><span class="o">.</span><span class="na">CHUNK_SIZE</span><span class="o">)+</span><span class="n">i</span><span class="o">],</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//Perform FFT analysis on the chunk:</span>
    <span class="n">results</span><span class="o">[</span><span class="n">times</span><span class="o">]</span> <span class="o">=</span> <span class="n">FFT</span><span class="o">.</span><span class="na">fft</span><span class="o">(</span><span class="n">complex</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//Done!</span></code></pre></figure>

<p>Now we have a double array containing all chunks as Complex[]. This array contains data about all frequencies. To visualize this data I decided to implement a full spectrum analyzer (just to make sure I got the math right).<br />
To show the data I hacked this together:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">results</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">line</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">// To get the magnitude of the sound at a given frequency slice</span>
        <span class="c1">// get the abs() from the complex number.</span>
        <span class="c1">// In this case I use Math.log to get a more managable number (used for color)</span>
        <span class="kt">double</span> <span class="n">magnitude</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">freq</span><span class="o">].</span><span class="na">abs</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>

        <span class="c1">// The more blue in the color the more intensity for a given frequency point:</span>
        <span class="n">g2d</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="k">new</span> <span class="nf">Color</span><span class="o">(</span><span class="mi">0</span><span class="o">,(</span><span class="kt">int</span><span class="o">)</span><span class="n">magnitude</span><span class="o">*</span><span class="mi">10</span><span class="o">,(</span><span class="kt">int</span><span class="o">)</span><span class="n">magnitude</span><span class="o">*</span><span class="mi">20</span><span class="o">));</span>
        <span class="c1">// Fill:</span>
        <span class="n">g2d</span><span class="o">.</span><span class="na">fillRect</span><span class="o">(</span><span class="n">i</span><span class="o">*</span><span class="n">blockSizeX</span><span class="o">,</span> <span class="o">(</span><span class="n">size</span><span class="o">-</span><span class="n">line</span><span class="o">)*</span><span class="n">blockSizeY</span><span class="o">,</span><span class="n">blockSizeX</span><span class="o">,</span><span class="n">blockSizeY</span><span class="o">);</span>
		
        <span class="c1">// I used a improviced logarithmic scale and normal scale:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logModeEnabled</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">)</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">freq</span> <span class="o">+=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">)</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="n">line</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">freq</span><span class="o">++;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h1 id="introducing-aphex-twin">Introducing, Aphex Twin</h1>

<p>This seems a bit of OT (off-topic), but I’d like to tell you about a electronic musician called Aphex Twin (Richard David James). He makes crazy electronic music… but some songs have an interesting feature. His biggest hit for example, <a href="http://en.wikipedia.org/wiki/Windowlicker">Windowlicker</a> has a spectrogram image in it.<br />
If you look at the song as spectral image it shows a nice spiral. Another song, called ‘Mathematical Equation’ shows the face of Twin! More information can be found here: <a href="http://www.bastwood.com/aphex.php">Bastwood - Aphex Twin’s face</a>.</p>

<p>When running this song against my spectral analyzer I get the following result:</p>

<p><a href="/images/face.png"><img src="/images/face-299x300.png" alt="face" /></a></p>

<p>Not perfect, but it seems to be Twin’s face!</p>

<h1 id="determining-the-key-music-points">Determining the key music points</h1>

<p>The next step in Shazam’s algorithm is to determine some key points in the song, save those points as a hash and then try to match on them against their database of over 8 million songs. This is done for speed, the lookup of a hash is O(1) speed. That explains a lot of the awesome performance of Shazam!</p>

<p>Because I wanted to have everything working in one weekend (this is my maximum attention span sadly enough, then I need a new project to work on) I kept my algorithm as simple as possible. And to my surprise it worked.</p>

<p>For each line the in spectrum analysis I take the points with the highest magnitude from certain ranges. In my case: 40-80, 80-120, 120-180, 180-300.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//For every line of data:</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">LOWER_LIMIT</span><span class="o">;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">UPPER_LIMIT</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">freq</span><span class="o">++)</span> <span class="o">{</span>
    <span class="c1">//Get the magnitude:</span>
    <span class="kt">double</span> <span class="n">mag</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">freq</span><span class="o">].</span><span class="na">abs</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>

    <span class="c1">//Find out which range we are in:</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">getIndex</span><span class="o">(</span><span class="n">freq</span><span class="o">);</span>

    <span class="c1">//Save the highest magnitude and corresponding frequency:</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mag</span> <span class="o">&gt;</span> <span class="n">highscores</span><span class="o">[</span><span class="n">index</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">highscores</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">mag</span><span class="o">;</span>
        <span class="n">recordPoints</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">freq</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//Write the points to a file:</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AMOUNT_OF_POINTS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">fw</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">recordPoints</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;\t&quot;</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">fw</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>

<span class="c1">// ... snip ...</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">RANGE</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="o">{</span><span class="mi">40</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">120</span><span class="o">,</span><span class="mi">180</span><span class="o">,</span> <span class="n">UPPER_LIMIT</span><span class="o">+</span><span class="mi">1</span><span class="o">};</span>

<span class="c1">//Find out in which range</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">freq</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span><span class="o">(</span><span class="n">RANGE</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">)</span> <span class="n">i</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>When we record a song now, we get a list of numbers such as:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">33	56	99	121	195	
30	41	84	146	199	
33	51	99	133	183	
33	47	94	137	193	
32	41	106	161	191	
33	76	95	123	185	
40	68	110	134	232	
30	62	88	125	194	
34	57	83	121	182	
34	42	89	123	182	
33	56	99	121	195	
30	41	84	146	199	
33	51	99	133	183	
33	47	94	137	193	
32	41	106	161	191	
33	76	95	123	185</code></pre></figure>

<p>If I record a song and look at it visually it looks like this:</p>

<p><a href="/images/points.png"><img src="/images/points-228x300.png" alt="points" /></a><br />
(all the red dots are ‘important points’)</p>

<h1 id="indexing-my-own-music">Indexing my own music</h1>

<p>With this algorithm in place I decided to index all my 3000 songs. Instead of using the microphone you can just open mp3 files, convert them to the correct format, and read them the same way we did with the microphone, using an AudioInputStream. Converting stereo music into mono-channel audio was a bit trickier then I hoped. Examples can be found online (requires a bit too much code to paste here) have to change the sampling a bit.</p>

<h1 id="matching">Matching!</h1>

<p>The most important part of the program is the matching process. Reading Shazams paper they use hashing to get matches and the decide which song was the best match.</p>

<p>Instead of using difficult point-groupings in time I decided to use a line of our data (for example “33, 47, 94, 137”) as one hash: 1370944733<br />
(in my tests using 3 or 4 points works best, but tweaking is difficult, I need to re-index my mp3 every time!)</p>

<p>Example hash-code using 4 points per line:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Using a little bit of error-correction, damping</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FUZ_FACTOR</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

<span class="kd">private</span> <span class="kt">long</span> <span class="nf">hash</span><span class="o">(</span><span class="n">String</span> <span class="n">line</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">p</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\t&quot;</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
    <span class="kt">long</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">p</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
    <span class="k">return</span>  <span class="o">(</span><span class="n">p4</span><span class="o">-(</span><span class="n">p4</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100000000</span> <span class="o">+</span> <span class="o">(</span><span class="n">p3</span><span class="o">-(</span><span class="n">p3</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100000</span> <span class="o">+</span> <span class="o">(</span><span class="n">p2</span><span class="o">-(</span><span class="n">p2</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="o">(</span><span class="n">p1</span><span class="o">-(</span><span class="n">p1</span><span class="o">%</span><span class="n">FUZ_FACTOR</span><span class="o">));</span>
<span class="o">}</span></code></pre></figure>

<p>Now I create two data sets:</p>

<p>- A list of songs, List<string> (List index is Song-ID, String is songname)  
\- Database of hashes: Map&lt;Long, List<datapoint>&gt;</datapoint></string></p>

<p>The long in the database of hashes represents the hash itself, and it has a bucket of DataPoints.</p>

<p>A DataPoint looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">DataPoint</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">time</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">songId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DataPoint</span><span class="o">(</span><span class="kt">int</span> <span class="n">songId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">songId</span> <span class="o">=</span> <span class="n">songId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
    <span class="o">}</span>
	
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSongId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">songId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now we already have everything in place to do a lookup. First I read all the songs and generate hashes for each point of data. This is put into the hash-database.<br />
The second step is reading the data of the song we need to match. These hashes are retrieved and we look at the matching datapoints.</p>

<p>There is just one problem, for each hash there are some hits, but how do we determine which song is the correct song..? Looking at the amount of matches? No, this doesn’t work…<br />
The most important thing is timing. We must overlap the timing…! But how can we do this if we don’t know where we are in the song? After all, we could just as easily have recorded the final chords of the song.</p>

<p>By looking at the data I discovered something interesting, because we have the following data:</p>

<p>- A hash of the recording<br />
- A matching hash of the possible match<br />
- A song ID of the possible match<br />
- The current time in our own recording<br />
- The time of the hash in the possible match</p>

<p>Now we can substract the current time in our recording (for example, line 34) with the time of the hash-match (for example, line 1352). This difference is stored together with the song ID. Because this offset, this difference, tells us where we possibly could be in the song.<br />
When we have gone through all the hashes from our recording we are left with a lot of song id’s and offsets. The cool thing is, if you have a lot of hashes with matching offsets, you’ve found your song.</p>

<h1 id="the-results">The results</h1>

<p>For example, when listening to The Kooks - Match Box for just 20 seconds, this is the output of my program:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Done loading: 2921 songs

Start matching song...

Top 20 matches:

01: 08_the_kooks_-_match_box.mp3 with 16 matches.
02: 04 Racoon - Smoothly.mp3 with 8 matches.
03: 05 Röyksopp - Poor Leno.mp3 with 7 matches.
04: 07_athlete_-_yesterday_threw_everyting_a_me.mp3 with 7 matches.
05: Flogging Molly - WMH - Dont Let Me Dia Still Wonderin.mp3 with 7 matches.
06: coldplay - 04 - sparks.mp3 with 7 matches.
07: Coldplay - Help Is Round The Corner (yellow b-side).mp3 with 7 matches.
08: the arcade fire - 09 - rebellion (lies).mp3 with 7 matches.
09: 01-coldplay-_clocks.mp3 with 6 matches.
10: 02 Scared Tonight.mp3 with 6 matches.
11: 02-radiohead-pyramid_song-ksi.mp3 with 6 matches.
12: 03 Shadows Fall.mp3 with 6 matches.
13: 04 Röyksopp - In Space.mp3 with 6 matches.
14: 04 Track04.mp3 with 6 matches.
15: 05 - Dress Up In You.mp3 with 6 matches.
16: 05 Supergrass - Can&#39;t Get Up.mp3 with 6 matches.
17: 05 Track05.mp3 with 6 matches.
18: 05The Fox In The Snow.mp3 with 6 matches.
19: 05_athlete_-_wires.mp3 with 6 matches.
20: 06 Racoon - Feel Like Flying.mp3 with 6 matches.

Matching took: 259 ms

Final prediction: 08_the_kooks_-_match_box.mp3.song with 16 matches.</code></pre></figure>

<p>It works!!</p>

<p>Listening for 20 seconds it can match almost all the songs I have. And even this <a href="http://www.youtube.com/watch?v=sLR9d4sMcq4">live recording of the Editors</a> could be matched to the correct song after listening 40 seconds!</p>

<p>Again it feels like magic! :-)</p>

<p>Currently, the code isn’t in a releasable state and it doesn’t work perfectly. It has been a pure weekend-hack, more like a proof-of-concept / algorithm exploration.</p>

<p>Maybe, if enough people ask about it, I’ll clean it up and release it somewhere.</p>

<h1 id="update">Update:</h1>

<p>The Shazam patent holders lawyers are sending me emails to stop me from releasing the code and removing this blogpost, read the story <a href="/blog/2010/07/patent-infringement/">here</a>.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/06/creating-shazam-in-java/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2010/04/playing-around-with-html-5/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by Roy van Rijn on 
          <span class="date">
            Apr 14, 2010 12:45:43
          </span>
          : <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/playing-around-with-html-5/#disqus_thread">0 comments</a>
        </p>
        <h1><a class="title-link" href="/blog/2010/04/playing-around-with-html-5/">Playing around with HTML 5</a></h1>


        <p>Yesterday, while browsing DZone, I encountered a couple of HTML 5 blogs. So I decided to try and code some HTML5 - Canvas myself.</p>

<p>This is the result of one hour trail-and-error:  </p>

<p><strong>Sorry, no <canvas></canvas> support, please upgrade your browser!</strong>  </p>

<p>Maybe I’ll do a write-up soon, but for now, just check the sources. (Yes they are wrong/hack-ish, I know…).</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2010/04/playing-around-with-html-5/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  

  <!-- Pagination -->
  
  <div class="pagination">
    <div class="pagination-center">
    
      <div class="pagination-item"><a href="/page/6">&laquo; Prev</a></div>
    

    
      
        <div class="pagination-item"><a href="/index.html">1</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/2">2</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/3">3</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/4">4</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/5">5</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/6">6</a></div>
      
    
      
        <div class="pagination-item"><b>7</b></div>
      
    
      
        <div class="pagination-item"><a href="/page/8">8</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/9">9</a></div>
      
    

    
      <div class="pagination-item"><a href="/page/8">Next &raquo;</a></div>
    
    </div>
  </div>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-wrapper">
      
      <div class="footer-wrapper-content">
      
        <a href="https://www.linkedin.com/profile/view?id=10356027">
          <i class="svg-icon linkedin"></i>
        </a>
      
        <a href="http://stackoverflow.com/users/442274/roy-van-rijn">
          <i class="svg-icon stackoverflow"></i>
        </a>

        <a href="https://github.com/royvanrijn">
          <i class="svg-icon github"></i>
        </a>

        <a href="https://twitter.com/royvanrijn">
          <i class="svg-icon twitter"></i>
        </a>
          
        <a href="/feed/index.xml">
          <i class="svg-icon rss"></i>
        </a>
	  </div>
    
    </div>

  </div>

</footer>


  </body>

</html>
