<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>royvanrijn  | Java, algorithms, math, science and more!</title>
  <meta name="description" content="Java, algorithms, math, science and more!">
  
  <meta name="keywords" content="royvanrijn,programming,java,blog,devoxx,conference,speaker,technology,science,math,azspcs,tips,tricks" />
  
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://royvanrijn.com/page/9/">
  <link rel="alternate" type="application/rss+xml" title="royvanrijn" href="https://royvanrijn.com/feed/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@royvanrijn" />
  <meta name="twitter:title" content="royvanrijn" />
  <meta name="twitter:description" content="Java, algorithms, math, science and more!" />
  
  <meta name="twitter:image" content="http://www.royvanrijn.com/thumbnails/default.jpg"/>
  

<script>
  <!-- Google Analytics -->
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3219266-1', 'auto');
  ga('send', 'pageview');

  <!-- Disqus Comment Count -->
  var disqus_shortname = 'royvanrijn';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

	<a class="site-title" href="/">
	  <img src="/images/header_royvanrijn.jpg" alt="royvanrijn" width="990" height="307"/>
    </a>

    <nav class="site-nav">

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

  <hr/>
  <!-- This loops through the paginated posts -->
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/04/iphone-locations-on-google-maps-with-javascript/" title="iPhone locations on Google Maps with Javascript">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="iPhone locations on Google Maps with Javascript" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-04-26T14:34:27+02:00" class="date" />
          <span itemprop="datePublished" content="2011-04-26T14:34:27+02:00" class="date">
            Apr 26, 2011 14:34:27
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/iphone-locations-on-google-maps-with-javascript/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/04/iphone-locations-on-google-maps-with-javascript/">iPhone locations on Google Maps with Javascript</a></h1>

        <span itemprop="articleBody">
          <p>Wow, great news!</p>

<p>After my <a href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/">previous</a> blogpost a lot of people mailed me about the usability of my ‘iPhone location data to Google Earth’ tool. It was a command-line tool, and you needed to have Java 6 installed. The main goal was to show how it is done in Java, for other developers.</p>

<p>When chatting to <a href="https://github.com/williame">Will</a> about this he suggested using Javascript instead. Soon he had the code working that could parse the iPhone backup files. He then contacted <a href="https://github.com/markolson">Mark Olson</a>, who helped him with the SQLLite format in Javascript. Together they finished it up so the resulting GPS data is shown in Google Maps.</p>

<p>The result of their effort: <a href="http://markolson.github.com/js-sqlite-map-thing/">http://markolson.github.com/js-sqlite-map-thing/</a></p>

<p>To use it, drag the backup files into the upper part of the website. It will parse the files, locate the data and display the track on Google Maps!<br />
The source code can be found here: <a href="https://github.com/markolson/js-sqlite-map-thing">https://github.com/markolson/js-sqlite-map-thing</a></p>

<p>Kudos to Will and Mark for this great application. Who knew Javascript could be this powerfull!?</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/iphone-locations-on-google-maps-with-javascript/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/" title="Reading iPhone GPS data from backup (with Java)">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Reading iPhone GPS data from backup (with Java)" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-04-21T01:06:24+02:00" class="date" />
          <span itemprop="datePublished" content="2011-04-21T01:06:24+02:00" class="date">
            Apr 21, 2011 01:06:24
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/">Reading iPhone GPS data from backup (with Java)</a></h1>

        <span itemprop="articleBody">
          <p>Today I noticed the following post on Slashdot: <a href="http://apple.slashdot.org/story/11/04/20/1357248/Apple-Logging-Locations-of-All-iPhone-Users">Apple Logging Locations of All iPhone Users</a></p>

<p>And the article they are referring to can be found <a href="http://petewarden.github.com/iPhoneTracker/">here</a></p>

<p>First I was amazed, how can Apple do this? But on second thought, they aren’t sending it yet to anybody, it is just something on the phone (and also on the phone’s backup). My next reaction was: I want to see my own map! But to my disappointment it only works on Apple Mac’s, not Windows/Linux.</p>

<h1 id="re-building-it-in-java">(Re-)building it in Java</h1>

<p>Because their code is open source and well explained on the website I decided to make my own version, in Java (cross platform!). Now, just a couple of hours since I read the article, I’ve got it working and it can be used as a base for extention. So I’d like to share the code!</p>

<h1 id="step-1-getting-the-correct-file">Step 1: Getting the correct file</h1>

<p>This step was the hardest part, technically. The backup Apple makes doesn’t just have all the files as they are on your iPhone. Instead they all have names like: “b4d1c79c2f5fc1da044c18d1066b80b39b575590”. They do however store the information in two files: Manifest.mbdb and Manifest.mbdx.</p>

<p>The MBDB file only contains information about the original files, and the MBDX file contains pointers into the MBDB file with the Hex-filenames used in the backup. So we need to parse both files to be able to connect the original filename to the Hex-filename.</p>

<p>Luckely somebody already did this in Python and posted it on <a href="http://stackoverflow.com/questions/3085153/how-to-parse-the-manifest-mbdb-file-in-an-ios-4-0-itunes-backup">stackoverflow</a>. I took their idea and translated it into Java code.</p>

<p>When this was fully translated it could resolve all the filenames. This meant I could map the target file “Library/Caches/locationd/consolidated.db” to the hex-filename “4096c9ec676f2847dc283405900e284a7c815836”.</p>

<h1 id="step-2-reading-the-sqllite-file">Step 2: Reading the SQLLite file</h1>

<p>The contents of “4096c9ec676f2847dc283405900e284a7c815836” is just a SQLLite file. For this I decided to use SQLJet, a framework that can read(/and write) SQLLite files. Using just a couple of lines of code I had all the data I need: timestamp, latitude, longitude (and more! speed, course, confidence, altitude etc).</p>

<h1 id="step-3-what-to-do-with-the-geo-data">Step 3: What to do with the geo data?</h1>

<p>The implementation created by <a href="http://petewarden.github.com/iPhoneTracker/">Pete Warden</a> has a nice map and timeline. But at this time I wanted to have results as fast as possible. That is why chose to just output a <a href="http://nl.wikipedia.org/wiki/Keyhole_Markup_Language">KML</a> file. KML is a file format used by Google Earth and other applications.</p>

<p>The results are far from nice (just plain ugly) but fun: <a href="https://sites.google.com/site/redcodenl/home/281096076.jpg">click here for a screenshot</a></p>

<h1 id="running-the-code">Running the code</h1>

<p>The above code is mainly created for developers, the resulting JAR can’t be executed. But I’m aware people will want to just have the KML file, and not go through the code. That is why I’ve uploaded an executable JAR. You can get it here: <a href="https://sites.google.com/site/redcodenl/runnableiPhoneJTrack.zip">runnableiPhoneJTrack.zip</a> (813 KB)</p>

<p>To run the program, extract the three JAR-files and type:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Usage:
java -jar iPhoneJTrack.jar "&lt;location of backup directory&gt;"

For example:
java -jar iPhoneTracker.jar "C:\Users\roy\AppData\Roaming\Apple Computer\MobileSync\Backup\b4d1c79c2f5fc1da044c18d1066b80b39b575590"</code></pre></figure>

<p>This outputs a file named iPhoneData.kml, which can be loaded for example in Google Earth.</p>

<h1 id="playing-with-the-code">Playing with the code</h1>

<p>I’ve pushed my code onto GitHub: <a href="https://github.com/royvanrijn/iPhoneJTrack">https://github.com/royvanrijn/iPhoneJTrack</a></p>

<p>Feel free to add features and send me pull requests!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/04/static-state-evil-as-well/" title="Static state: Evil as well">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Static state: Evil as well" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-04-19T19:23:26+02:00" class="date" />
          <span itemprop="datePublished" content="2011-04-19T19:23:26+02:00" class="date">
            Apr 19, 2011 19:23:26
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/static-state-evil-as-well/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/04/static-state-evil-as-well/">Static state: Evil as well</a></h1>

        <span itemprop="articleBody">
          <p>Today in our project we suddenly had 10 failing unit-tests on our integration server (Hudson). Opening Hudson and looking at the first failed build I was in for a surprise. The only code changed that commit was mine!</p>

<h1 id="the-scare">The scare</h1>

<p>Quickly I looked around and went into overdrive mode:<br />
<em>I need to fix this bug before somebody sees it!<br />
I’m always yelling at people who break the build, and now it has happend to me…!</em></p>

<p>Looking at the SVN comment it only said: “cleaned up some code” (or something)<br />
That isn’t very helpfull of myself…</p>

<h1 id="the-second-scare">The second scare</h1>

<p>Then I noticed I changed only one file. The change should be contained and easy to fix. But then I had a moment of relief and scare at the same time:</p>

<ul>
  <li>Phew, it isn’t my fault… removing empty lines should not break builds…</li>
  <li>But… why the heck does removing an empty line break the build!?</li>
</ul>

<h1 id="the-culprit">The culprit</h1>

<p>After looking around in the code, and the failing tests a collegue and me found the culprit: statefull static.</p>

<p>In our application we’ve introduced a static class called GlobalContext. In this class we keep session information, things like the MapState (we have a map, which has dimensions, view extents, etc). And throughout the code we read this information and mutate it. To unit-test the code we added setters to inject mock MapState’s into the GlobalContext.</p>

<p>Running all the unit tests in Eclipse always runs them synchronously, and everything is fine. But this goes horribly wrong when running Maven and/or the Hudson build. Surefire takes all test classes and runs them parallel! So when one test is busy reading the state of our static class, another test is setting different information in the same static class! This causes NPE’s and other weird values. Until now we have been lucky the tests all ran correctly, but after my commit, the execution-order appearantly changed.</p>

<h1 id="the-fix">The fix</h1>

<p>The only way to fix this is removing the static-ness of the GlobalContext. Since we are also using Spring we can just put an instance of the MapState in Spring and inject that into the classes that use it. That way, when doing tests you can inject the mock-instance into the instances you are testing! This solves everything…</p>

<p>Even better, get rid of the GlobalContext at all. It contained a couple of instances that could easily be injected into the other objects. This makes it much clearer to see which objects depend on which other objects and makes the code a heck of a lot easier to test.</p>

<h1 id="lessons-learned">Lessons learned…</h1>

<p>This got me thinking, in which cases should you use static? Obviously “public static final”-fields are useful. And maybe static functions in Utility classes, which have no state and only mutate data. But are there cases when you really need static state? I’ve been thinking about this for a day now, but I can’t come up with any good usecase. Do you know any? Mail me, comment below!</p>

<p>So for now, my new rule: Don’t use static unless you have a very good reason, and never ever have static (mutable) state!</p>

<p>p.s. And people, stop using SimpleDateFormat as fields, they are not threadsafe and cause weird exceptions and weird dates! I was lucky to catch one in our code today before weird errors occured.</p>

        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/static-state-evil-as-well/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/04/checked-exceptions-evil/" title="Checked Exceptions: Evil">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Checked Exceptions: Evil" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-04-19T18:13:55+02:00" class="date" />
          <span itemprop="datePublished" content="2011-04-19T18:13:55+02:00" class="date">
            Apr 19, 2011 18:13:55
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/checked-exceptions-evil/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/04/checked-exceptions-evil/">Checked Exceptions: Evil</a></h1>

        <span itemprop="articleBody">
          <p>Today somebody posted a comment:</p>

<blockquote>
  <p>‘Could you write a post giving more details on why you think<br />
checked exceptions are “the embodiment of evil”?’</p>
</blockquote>

<p>So here it is.</p>

<p>As you can see I haven’t written a post in a long time (sorry). This post is also not going to be very comprehensive. Of course I could explain everything, but I’d rather link to another site which sums it up very nicely:<br />
<a href="http://c2.com/cgi/wiki?TheProblemWithCheckedExceptions">http://c2.com/cgi/wiki?TheProblemWithCheckedExceptions</a></p>

<p>Basically, I don’t want to be forced to handle exceptions. Also, having to catch checked exceptions makes code unreadable, complex and harder to change/refactor.</p>

<p>Of course I’m also aware that with runtime exceptions you are likely to forget to catch some exceptions, which is also very bad. That is why our application(s) catch and log all runtime exceptions and mail them to the developers. Execptions are always something very bad and should not be functional, exceptions should be… exceptions. Once they happen, all hell should break out and it should be fixed.</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/04/checked-exceptions-evil/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/" title="De Bruijn sequence in constant amortized time">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="De Bruijn sequence in constant amortized time" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-02-24T22:29:29+01:00" class="date" />
          <span itemprop="datePublished" content="2011-02-24T22:29:29+01:00" class="date">
            Feb 24, 2011 22:29:29
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/">De Bruijn sequence in constant amortized time</a></h1>

        <span itemprop="articleBody">
          <p>Follow up on the previous blogpost.</p>

<p>Yesterday I wrote an algorithm in Java to generate de Bruijn sequences. But I had a breakthrough after reading:</p>

<p><em>K. Cattell, F. Ruskey, J. Sawada, M. Serra, C.R. Miers, Fast algorithms to generate necklaces, unlabeled necklaces, and irreducible polynomials over GF(2)</em></p>

<p>It has an algorithm which generates Lyndon words in CAT. CAT stands for Constant Amortized Time. This means that it isn’t really constant time, but approaches it very much. Calculating the worst-case scenario isn’t worth it. For example using an ArrayList in Java. The time to do insertions is said to be O(1), and this is true…. until the array underneath needs to be resized. During this resize it’ll take some more time. So the algorithm isn’t really constant time, but constant amortized time.</p>

<p>This is the program I ended up with. It is very very small. One of my most beautiful pieces of code. And it even supports non-binary alphabets (use the k-parameter).</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="nf">generateDeBruijnSequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">StringBuilder</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
	<span class="n">generateLyndonWords</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">],</span> <span class="n">sequence</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">sequence</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">generateLyndonWords</span><span class="o">(</span><span class="kt">int</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">a</span><span class="o">,</span> <span class="n">StringBuilder</span> <span class="n">sequence</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">)%</span><span class="n">p</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">sequence</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="o">];</span> 
		<span class="n">generateLyndonWords</span><span class="o">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">p</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">sequence</span><span class="o">);</span>
		<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="o">]+</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span> 
			<span class="n">generateLyndonWords</span><span class="o">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">t</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">sequence</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><strong>Update June 7th 2012:</strong><br />
I just stumbled across this interesting read: <a href="http://www.learner.org/courses/mathilluminated/units/2/textbook/07.php">http://www.learner.org/courses/mathilluminated/units/2/textbook/07.php</a></p>

<p>The keypad example from that link can be easily calculated with the code above:<br />
generateDeBruijnSequence(9, 5).length() = 59049 :-)</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/" title="Generating de Bruijn sequences and Lyndon words">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Generating de Bruijn sequences and Lyndon words" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-02-24T10:32:52+01:00" class="date" />
          <span itemprop="datePublished" content="2011-02-24T10:32:52+01:00" class="date">
            Feb 24, 2011 10:32:52
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/">Generating de Bruijn sequences and Lyndon words</a></h1>

        <span itemprop="articleBody">
          <p>Not so long ago I encountered something called the <a href="http://en.wikipedia.org/wiki/De_Bruijn_sequence">de Bruijn sequence</a>. For now I’ll only use this for an alphabet of (0,1), binary. But everything said here could also be applied to other alphabets. In this post I’ll describe what this sequence is, and how you can generate them, using <a href="http://en.wikipedia.org/wiki/Lyndon_word">Lyndon words</a>.</p>

<h1 id="what-is-a-de-bruijn-sequence">What is a de Bruijn sequence?</h1>

<p>Well, it is a sequence (again, in this case binary) which contains all combinations/permutations of a specific length. And it does this only once.<br />
For example: B(2,4)</p>

<ul>
  <li>000100110101111 (000)</li>
</ul>

<p>This sequence contains all possible permutations you can make in binary of length 4. The last part (000) is optional, and needed it you do not want the sequence looped. As you can see, the length of this sequence is 16. All sequences will have length 2^N.</p>

<h1 id="how-do-you-construct-these-sequences">How do you construct these sequences?</h1>

<p>The next thing I wanted to know is how to construct these sequences. The first hit I got was from the <a href="http://mathworld.wolfram.com/deBruijnSequence.html">MathWorld</a> website. It states:<br />
<em>Surprisingly, it turns out that the lexicographic sequence of Lyndon words of lengths divisible by N gives the lexicographically smallest de Bruijn sequence (Ruskey).</em></p>

<h1 id="lyndon-word">Lyndon word..?</h1>

<p>It seems that the next step is generating Lyndon words. Lyndon words are the lexographically smallest rotation of a word. I haven’t yet found a proper way to do this (I know there are) so here is what I do:</p>

<p>Pseudo:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">lastLyndon = -1
for all possible N's {
    currentSmallestLyndon = smallestLyndonRotation(N)
    if( currentSmallestLyndon &gt; lastLyndon ) {
        lastLyndon = currentSmallestLyndon
        print currentSmallestLyndon
    }
}</code></pre></figure>

<p>And here is what I used to generate the smallestLyndonRotation (Java):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BigInteger</span> <span class="nf">smallestLyndonRotation</span><span class="o">(</span><span class="n">BigInteger</span> <span class="n">input</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">BigInteger</span> <span class="n">lowestForm</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span>
	<span class="n">BigInteger</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BigInteger</span><span class="o">.</span><span class="na">ONE</span><span class="o">;</span>
	<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">BigInteger</span> <span class="n">possibleLowerForm</span> <span class="o">=</span> <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">mask</span><span class="o">).</span><span class="na">shiftLeft</span><span class="o">(</span><span class="n">size</span><span class="o">-</span><span class="n">i</span><span class="o">)).</span><span class="na">or</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">mask</span><span class="o">.</span><span class="na">negate</span><span class="o">()).</span><span class="na">shiftRight</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">mask</span><span class="o">.</span><span class="na">shiftLeft</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
		<span class="k">if</span><span class="o">(</span><span class="n">possibleLowerForm</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">lowestForm</span><span class="o">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">lowestForm</span> <span class="o">=</span> <span class="n">possibleLowerForm</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">lowestForm</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>How does it work? Well, for example the input is: 0010.<br />
It loops over all rotations (using some bit-masking):</p>

<ul>
  <li>0010</li>
  <li>0100</li>
  <li>1000</li>
  <li>0001</li>
</ul>

<p>And finds the smallest lexographically (0001) and returns this.</p>

<p>The above pseudo code will spit out the following numbers:</p>

<ul>
  <li>0000</li>
  <li>0001</li>
  <li>0011</li>
  <li>0101</li>
  <li>0111</li>
  <li>1111</li>
</ul>

<p>These are all the Lyndon words for N=4.</p>

<h1 id="splitting-reducing-the-lyndon-words">Splitting, reducing the Lyndon words</h1>

<p>Now if we put the Lyndon words together we get:</p>

<ul>
  <li>000000010011010101111111 (our sequence)</li>
  <li>0000100110101111 (de Bruijn sequence)</li>
</ul>

<p>We aren’t quite there yet… but there is some resemblance. There is one more step left, we have to reduce/split the Lyndon words into its smallest unique part.</p>

<p>Lets take the Lyndon words again:</p>

<ul>
  <li>0000 -&gt; 0 (4x)</li>
  <li>0001 -&gt; 0001</li>
  <li>0011 -&gt; 0011</li>
  <li>0101 -&gt; 01 (2x)</li>
  <li>0111 -&gt; 0111</li>
  <li>1111 -&gt; 1 (4x)</li>
</ul>

<p>Results in: 0000100110101111, the sequence!</p>

<p>And that is it! If we’ve created the smallest possible de Bruijn sequence for B(2,4).</p>

<p>Here are some more sequences:</p>

<ol>
  <li>01</li>
  <li>0011</li>
  <li>00010111</li>
  <li>0000100110101111</li>
  <li>00000100011001010011101011011111</li>
  <li>0000001000011000101000111001001011001101001111010101110110111111</li>
  <li>00000001000001100001010000111000100100010110001101000111100100110010101001011100110110011101001111101010110101111011011101111111</li>
  <li>00000000100000011000001010000011100001001000010110000110100001111000100010011000101010001011100011001000110110001110100011111001<br />
00101001001110010101100101101001011110011001101010011011100111011001111010011111101010101110101101101011111011011110111011111111</li>
  <li>00000000010000000110000001010000001110000010010000010110000011010000011110000100010000100110000101010000101110000110010000110110<br />
00011101000011111000100011000100101000100111000101001000101011000101101000101111000110011000110101000110111000111001000111011000111<br />
10100011111100100100101100100110100100111100101001100101010100101011100101101100101110100101111100110011100110101100110110100110111<br />
10011101010011101110011110110011111010011111110101010110101011110101101110101110110101111110110110111110111011110111111111</li>
</ol>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/02/unit-testing-a-chess-engine/" title="Testing a chess engine">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Testing a chess engine" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-02-07T10:02:46+01:00" class="date" />
          <span itemprop="datePublished" content="2011-02-07T10:02:46+01:00" class="date">
            Feb 7, 2011 10:02:46
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/unit-testing-a-chess-engine/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/02/unit-testing-a-chess-engine/">Testing a chess engine</a></h1>

        <span itemprop="articleBody">
          <p>About a week ago I decided to try and write a chess engine. I’ve encountered <a href="http://en.wikipedia.org/wiki/Bitboard">bitboards</a> before, and I really liked working with them. Most references I found had to do with chess engines, so I decided to have a go.</p>

<p>The single most important and time consuming aspect of building a chess engine is legal <a href="http://chessprogramming.wikispaces.com/Move+Generation">move generation</a>. In all situations, be able to generate all legal moves that can be made on the board. At first this seems pretty straight forward, all pieces can move and attack in certain ways. But when you get to specific rules like castling and en-passant things get really tricky.</p>

<p>But how do you know for sure your engine works and gets the right results? The many chess engine developers around the world found a great solution for this problem. Something I can only describe as universal integration-tests! They call it “perft” (from performance test). The first thing they do it create a particulair situation on the chess board. This can be described like in <a href="http://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">FEN notation</a>.<br />
For example:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1
    (initial chess starting position)</code></pre></figure>

<p>All chess engines use this small language and understand how to set up their internal board. The next step is to generate all possible moves. From the example FEN above all possible moves are just 20 moves. But why stop here? From these 20 moves calculate all legal moves the opponent can make (also 20) which results in 400 moves. Continue doing this and you’ll end up with a table like this:</p>

<table> 
 <tbody>
  <tr> 
   <td style="text-align: right;"><strong>Depth</strong><br /> </td> 
   <td style="text-align: right;"><strong>Nodes</strong><br /> </td> 
   <td style="text-align: right;"><strong>Captures</strong><br /> </td> 
   <td style="text-align: right;"><strong>E.p.</strong><br /> </td> 
   <td style="text-align: right;"><strong>Castles</strong><br /> </td> 
   <td style="text-align: right;"><strong>Promotions</strong><br /> </td> 
   <td style="text-align: right;"><strong>Checks</strong><br /> </td> 
   <td style="text-align: right;"><strong>Checkmates</strong><br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">1<br /> </td> 
   <td style="text-align: right;">20<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">2<br /> </td> 
   <td style="text-align: right;">400<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">3<br /> </td> 
   <td style="text-align: right;">8902<br /> </td> 
   <td style="text-align: right;">34<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">12<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">4<br /> </td> 
   <td style="text-align: right;">197281<br /> </td> 
   <td style="text-align: right;">1576<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">469<br /> </td> 
   <td style="text-align: right;">8<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">5<br /> </td> 
   <td style="text-align: right;">4865609<br /> </td> 
   <td style="text-align: right;">82719<br /> </td> 
   <td style="text-align: right;">258<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">27351<br /> </td> 
   <td style="text-align: right;">347<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">6<br /> </td> 
   <td style="text-align: right;">119060324<br /> </td> 
   <td style="text-align: right;">2812008<br /> </td> 
   <td style="text-align: right;">5248<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">809099<br /> </td> 
   <td style="text-align: right;">10828<br /> </td> 
  </tr> 
 </tbody>
</table>

<p>As you can see, the numbers in these tables quickly become huge. This will ensure that a lot of situations are tested. Using these tables you can check if your program outputs the same values, and thus complies to all the rules. There are a lot of these tables online, using a FEN for starting position, and a table with all nodes that can be generated.</p>

<p>The next problem is, when your numbers don’t add up, how do you find the move 6 levels deep that goes wrong? Well, some engines can help you with that. Personally I used <a href="http://www.rocechess.ch/rocee.html">ROCE</a> (Roman’s Own Chess Engine). His engine has a “divide” function. First you set the board in a certain position using the FEN, and then you call the divide function, for example “divide 6”. Now it shows a table like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">move : nodes
    e2e4 1249
    e2e3 2356
    f2f3 5356
    f2f4 6436
    (etc)</code></pre></figure>

<p>This lists each node at level 1, and after that each number of nodes it results in at depth 6. If you also have this function in your own chess engine you can compare the numbers. Now you can pinpoint which of the first nodes contains the error. Do this move and try divide 5. This will guide you all the way to the specific move that is (or isn’t) created! This was a huge help, and I love the way chess engine developers devised a way to have a kind of universal integration-tests which will point out the most commonly made bugs. You can take these tables, load them in a automatic test and keep running them every nights to see if things are still working like it should.</p>

<p>How did my engine end up? Well, it worked perfect in the sense that it could generate all the good legal moves. Then I added a simple evaluation function and it could play chess. After that I implemented a simple search algorithm (<a href="http://en.wikipedia.org/wiki/Alpha-beta_pruning">alpha-beta</a> using <a href="http://en.wikipedia.org/wiki/Negamax">negamax</a>) and it could beat two simple other chess engines and myself. And of course, after a week, I lost interest again and writing a blogpost about it is usually the nail to the coffin of most of my projects.</p>

<p>So, what should I tackle next? I’m looking forward to having a new <a href="http://azspcs.net/">AZsPCs</a> competition, but I think this might take a while…</p>

<p><strong>Update:</strong> A couple of readers have pointed out that these tests are obviously not <em>unit tests</em>, but rather integration or acceptance tests. You are completely right. I’ve called them Unit tests because I used JUnit and they run in the automatic build. But they do test integration..!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/02/unit-testing-a-chess-engine/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/01/exception-mailing/" title="Exception mailing">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Exception mailing" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-01-06T00:36:51+01:00" class="date" />
          <span itemprop="datePublished" content="2011-01-06T00:36:51+01:00" class="date">
            Jan 6, 2011 00:36:51
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/01/exception-mailing/">Exception mailing</a></h1>

        <span itemprop="articleBody">
          <p>A couple of weeks ago our Scrum team was thinking about exception handling. We don’t use checked exceptions, since they are the embodiment of evil. So everything is translated into runtime exceptions whenever possible. But this is where the problems start: What do you do with the uncatched runtime exceptions?</p>

<h1 id="taking-it-one-step-further">Taking it one step further</h1>

<p>Most projects will decide to just write the exceptions to the console, maybe to a log file. In some cases there is specialized software which will analyze log files, detect stacktraces and act on them. We decided to create a fast specialized solution. We want to have a mailbox where all the runtime exceptions end up, including stacktrace, system properties, program properties and even a screenshot.</p>

<h2 id="catching-the-uncaught-exception">Catching the uncaught exception</h2>

<p>In Java you can set a exception handlers on Threads. You can set a handler on a Thread, but it is also possible to set a default exception handler. It is very easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUncaughtExceptionHandler</span> <span class="kd">implements</span> <span class="n">UncaughtExceptionHandler</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CustomUncaughtExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uncaughtException</span><span class="o">(</span><span class="kd">final</span> <span class="n">Thread</span> <span class="n">t</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do something here!    
</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>If an exception occurs, the uncaughtException method will be called. Then you can do anything you want with the throwable. As said before, we decided it is best for us that the application phones home and sends us an email with as much information as we can get.</p>

<h1 id="what-to-send">What to send?</h1>

<p>Our application is launched by JNLP and will run on several clients. We don’t have complete contol over these clients, so we want to include as much information as possible to solve possible bugs in the application. The more information we have about the runtime, the easier it might be to find the problem. We grab all (relevant) system properties and program properties we can get. Including usernames, machine details.</p>

<h2 id="creating-a-screenshot">Creating a screenshot</h2>

<p>In Java there are actually two methods of creating a screenshot. The first method is the easiest, using the Java Robot:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Robot</span> <span class="n">robot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Robot</span><span class="o">();</span>
 
<span class="n">BufferedImage</span> <span class="n">screenShot</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="na">createScreenCapture</span><span class="o">(</span><span class="k">new</span> <span class="n">Rectangle</span><span class="o">(</span><span class="n">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">()));</span></code></pre></figure>

<p>Very easy, but this can contain a LOT of information about the moment the exception occurs. It may provide valuable information. But we encountered a major security problem with the above method. Java will create an actual screenshot, the size of your application. But it doesn’t know if your application is currently the active window..! When we did tests we saw screenshots with Skype messages in screen and browsers being active… We can’t invade the lives of our users and send this information over the mail!</p>

<p>So I decided to search for something less invasive. The main frame of our application has a paint method, and most of the time this method can still be called if we have an exception. It is possible to create our own Graphics object and let the main frame paint itself into memory. So eventually I settled on the code below:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BufferedImage</span> <span class="nf">createScreenshot</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Try to repaint the main frame of our application:
</span>
        <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">paintAll</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getGraphics</span><span class="o">());</span>
        <span class="c1">// We can't use Robot, it might capture a bit too much information
</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Screen can't be captured, don't throw exception, else we'll end up in a loop :-)
</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="mailing-the-exception">Mailing the exception</h2>

<p>The next step in our solution is sending an email with all the information. This is done using Java Mail, an API to send emails. More about sending emails from Java <a href="http://www.javaworld.com/jw-06-1999/jw-06-javamail.html?page=4">here</a>. In our case we create a pretty HTML email with all relevant information and three attachements:</p>

<ul>
  <li>Text file with all system properties</li>
  <li>Text file with the complete exception</li>
  <li>The image/screenshot</li>
</ul>

<p>To create the email it is easy to create MimeBodyParts which contain the text, the only part a bit more complicated it to add the screenshot inside the email, this can be done using:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">MimeBodyPart</span> <span class="nf">createImagePart</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedImage</span> <span class="n">screenshot</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
    
	<span class="k">if</span> <span class="o">(</span><span class="n">screenshot</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">MimeBodyPart</span> <span class="n">imagePart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeBodyPart</span><span class="o">();</span>
	<span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">screenshot</span><span class="o">,</span> <span class="s">"jpg"</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioException</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Impossible to get the screenshot, return null and continue without it
</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">DataSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayDataSource</span><span class="o">(</span><span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="s">"image/jpeg"</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setDataHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">DataHandler</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="s">"screenshot.jpg"</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setContentID</span><span class="o">(</span><span class="s">"&lt;screenshot&gt;"</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">imagePart</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>The only non-obvious line in the code above is setting the ContentID, this can be used to refer to the image-data in case of an HTML email. In the main email content I added the following line:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">Screenshot: <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/images/cid:screenshot"</span> <span class="na">alt=</span><span class="s">"Screenshot of the moment the exception occured."</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>The <em>src=”cid:screenshot”</em> will cause the email to show the screenshot embedded inside the email. This makes the exception-email look very pretty.</p>

<h1 id="even-more-in-the-future">Even more in the future…?</h1>

<p>With our current implementation we’ll be able to detect exceptions instantly (on every new email). Also we’ll have more information then just a stacktrace, we have a screenshot and some parameters/system properties which can help us re-create the situation.</p>

<p>To improve this even more I’m planning on adding a simple bounded FIFO queue. This queue will contain a list of actions performed by the user. These user-actions can be added automatically by using aspect oriented programming. For example annotating all the service methods. Everytime a service method is called we can add it to the bounded queue, which has a maximum of N elements, for example 20. If an exception occurs we print our the current queue, we can read the last N actions leading up to the exception. This too can be very helpful in re-creating the situation.</p>

<p>What more information could be useful in an debug email like this? How do you guys solve exception handling?</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2011/01/rainbow-tables/" title="Rainbow tables, reverse hash lookup">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Rainbow tables, reverse hash lookup" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2011-01-01T17:17:25+01:00" class="date" />
          <span itemprop="datePublished" content="2011-01-01T17:17:25+01:00" class="date">
            Jan 1, 2011 17:17:25
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2011/01/rainbow-tables/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2011/01/rainbow-tables/">Rainbow tables, reverse hash lookup</a></h1>

        <span itemprop="articleBody">
          <p>Today I’ve been looking into rainbow tables. These are tables used to do a reverse lookup for a hash function. For example MD5, or Windows LAN Manager. Usually these tables are used to find passwords if the hash is known. Now I’m not looking for a method to crack somebodies computer, but the technology and algorithms involved are very advanced and might be usefull in other fields as well!</p>

<h1 id="hashing">Hashing</h1>

<p>First off, lets talk about ‘hashing’, what is hashing? Well, a hash-function is a one-way function which turns some data (usually text) into a hashcode. For example… passwords:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">"test"     -&gt; "098f6bcd4621d373cade4e832627b4f6"
"password" -&gt; "5f4dcc3b5aa765d61d8327deb882cf99"</code></pre></figure>

<p>Every good website which takes security seriously will only store these MD5 hashes in their databases, not the real passwords. So even if their database is compromised the attackers don’t have anything, because the hash-function is only one-way.</p>

<h1 id="attacking-a-hash">Attacking a hash</h1>

<p>Where there is security there will be crackers trying to break it. How would you go about attacking, reversing, a hash? The earliest form was just to create huge tables of:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">PLAIN_TEXT -&gt; HASH</code></pre></figure>

<p>And then check if the hash is your hash. If you have a match, you’ll get into the system!</p>

<p>The problem is that these tables take a very long time to compute and you’ll end up with so much data you won’t be able to store it. This made hashing pretty safe.</p>

<h1 id="rainbow-tables">Rainbow tables</h1>

<p>A couple of generations further down the line, crackers now use rainbow tables. It takes the best of both worlds having a small(-ish) table on disk, and doing minimal computations. So how do they work..?</p>

<h2 id="the-reduce-function">The reduce function</h2>

<p>Lets assume we start with a random piece of text. For example we want to crack all passwords of length 5 and consisting of [ABC…XYZ0123456789]. We can now calculate the hash value. Instead of storing this single pair, we do a little trick. We use something that is called a ‘reduce function’. This is a selfmade one-way function that turns a hash back into a password! But not the original password (it isn’t a reverse hash-function) but just into some other password.</p>

<p>Why would we do that? Lets continue, we take our first random password, generate a hash, and then we reduce it back to another password. This is then again hashed, reduced, hashed, reduced for lets say 1000 times. We’ll end up with:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Hash:   "random"                           -&gt; "7ddf32e17a6ac5ce04a8ecbf782ca509"
Reduce: "7ddf32e17a6ac5ce04a8ecbf782ca509" -&gt; "ienw3"
Hash:   "ienw3"                            -&gt; "b9322e367ad002d5adf7ca60b8b61e86"
        ... (1000 times) ...
Hash:   "o1gti"                            -&gt; "27aa4cbd3653a4617e0aec76ba3af9a4"</code></pre></figure>

<p>The trick is, we throw away everything except the first input “random” and the final hash “27aa4cbd3653a4617e0aec76ba3af9a4”! This is the only part we need to store.</p>

<h2 id="using-a-rainbow-table">Using a rainbow table</h2>

<p>How can we use the data above to reverse hashes you might ask? To use this table we need the input hash. For example “b9322e367ad002d5adf7ca60b8b61e86”. First we check if this hash is in the database. If it is, we are very lucky, we can just re-generate that particulair chain and we know the plain text input!</p>

<p>If we don’t find anything (which is very likely) we apply our reduce function to the input-hash and then hash that result. Now we check the hashes again, regenerate the chain and find out the answer. This can be repeated until we hit our set limit (1000) in that case, if no match has been found, we can’t reverse it.</p>

<h2 id="false-alarms">False alarms</h2>

<p>There is one problem in this algorithm. If you take a input-hash and then do a couple of reduce/hashes, and then you find a match… it might be a false alarm! The problem is that there might be input strings that result in the same hash. If this happens two chains will end up into one chain.</p>

<p>If we would have done a couple of reduce/hashes from our input and find a match for endpoint “52cafa6b5e4a6509e6ed2b8e6976d780”, the original chain might not have contained our input value. When we construct the complete chain it is possible that our input-hash isn’t in the chain…!</p>

<h2 id="the-rainbow-of-the-rainbow-table">The ‘rainbow’ of the rainbow table</h2>

<p>The reason they call it a rainbow table has something to do with reducing the amount of false alarms. Until now we’ve talked about having one reduce-function. What if we would have multiple reduce functions? Then we could create multiple small tables, which would help reduce a little bit.</p>

<p>Philippe Oechslin had a great idea. He used a different reduce algorithm for each step in the chain. So his tables are build using:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">input chain 1 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash
input chain 2 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash
input chain 3 -&gt; hash -&gt; reduce1 -&gt; hash -&gt; reduce2 -&gt; .... -&gt; reduceN -&gt; hash</code></pre></figure>

<p>(If you color the reduce functions you’ll end up with a pretty rainbow pattern).</p>

<p>How would you reverse a hash using this method? Well, the first step is the same, check if your input-hash is present in the stored hashes.<br />
Next we apply:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">reduce1000 -&gt; hash -&gt; check
reduce999 -&gt; hash -&gt; reduce1000 -&gt; hash -&gt; check
reduce998 -&gt; hash -&gt; reduce999 -&gt; hash -&gt; reduce1000 -&gt; hash -&gt; check</code></pre></figure>

<p>(etc)</p>

<p>The big advantage is that similair hashes (collisions) will most likely use different reduce algorithms so they won’t end up in the same chain.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Using rainbow tables you greatly decrease the amount of stored values. It isn’t log(O), there is a bit of computation needed to do the lookups, but that as well is kept to a minimum. This results in a very fast method to crack passwords. But I think it can be used in other fields of computer science as well. There are a lot of situations where you’d like to have a very big hash-lookup table, and when it becomes too big, this can be used to reduce storage but maintain fairly good lookup times.</p>

<h1 id="salting">Salting</h1>

<p>Almost every article about hashing and rainbow tables end with a short alinea about salting. You can do salting in a couple of different ways, but the idea is usually the same. The easiest form of salting is having on ‘salt’ for a complete database.</p>

<h2 id="one-salt-per-database">One salt per database</h2>

<p>How does this work? Well, lets just generate a completely random piece of text: “thisisoursaltanditisverylarge”. Now every time we store a new user we do “MD5(password + salt)”. Because the password itself may be weak, we apply our large “database-salt” to it, and then we calculate the hash.</p>

<p>Now if you want to crack a hash in this system it is almost impossible. Unless you find out the salt, then you could re-create a complete rainbow table and crack all the passwords.</p>

<h2 id="using-a-user-value-as-salt">Using a user value as salt</h2>

<p>An even better solution is to use a user-value as salt, for example their username or date of birth, or maybe their registration date/time. Now if somebody cracks the database and finds all the data they’ll have to create a new rainbow table for each seperate user (!!!). This is even more secure and preferred over the database-salt.</p>

<h2 id="just-generate-a-random-sequence">Just generate a random sequence…</h2>

<p>But the single best way of salting your database is to generate a large random salt for each user. You can just store this salt in the database next to the hash of the password. This is better then, for example, the username, because there are just less collisions. For example usernames like “root” or “admin” aren’t very uncommon aren’t they? So creating a rainbow table with “root” as salt might be worth the trouble. But creating one with a large random number just for a single user? That is hard and they’ll probably quickly give up.</p>

<h1 id="other-uses-for-this-algorithm">Other uses for this algorithm</h1>

<p>I haven’t been able to come up with a good other use for this algorithm yet, but I have the feeling tons of problems could potentially benefit from it! Can you come up with one?</p>

        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2011/01/rainbow-tables/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/12/finding-performance-problems/" title="Finding performance problems">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Finding performance problems" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-12-14T13:19:08+01:00" class="date" />
          <span itemprop="datePublished" content="2010-12-14T13:19:08+01:00" class="date">
            Dec 14, 2010 13:19:08
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/12/finding-performance-problems/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/12/finding-performance-problems/">Finding performance problems</a></h1>

        <span itemprop="articleBody">
          <p>Many projects I’ve worked on, especially the projects using micro-optimization, had memory leaks and surprising performance hits. Most coders who work on for example Al Zimmermann’s programming contests use C/C++ and maybe even CUDA to get the most out of their system.</p>

<p>I’m usually using Java, just because I’m most at home in this language. It allows me to quickly get some working code and test some algorithms. But when I reach the final phase of the project it is time to micro-optimize everything.</p>

<p>The first tool I’ve tried it <a href="http://download.oracle.com/javase/6/docs/technotes/guides/visualvm/index.html">Java Visual VM</a>. This tool is available in all the new Sun Oracle JVM’s. Just go to the bin-directory and type <em>jvisualvm</em>. This program will attach to your running code and tries to extract all the information. The good part of this tool is the price, it is free!</p>

<p>But if you really need to know what it going on inside your project, you should try YourKit. YourKit is kindly supporting open source projects with its full-featured Java Profiler. YourKit, LLC is the creator of innovative and intelligent tools for profiling Java and .NET applications. Take a look at YourKit’s leading software products: <a href="http://www.yourkit.com/java/profiler/index.jsp">YourKit Java Profiler</a> and <a href="http://www.yourkit.com/.net/profiler/index.jsp">YourKit .NET Profiler</a>.</p>

<p>If you readers are interested I’ll write a blog with some simple examples on how to fix performance issues in your program, and how to detect these issues using Visual VM and YourKit.</p>

<p>Or I can do a comparison between the leading profilers (YourKit/JProfiler/Visual VM/etc)..?</p>

<p>Let me know!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/12/finding-performance-problems/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/11/xor-doubly-linked-list/" title="XOR doubly linked list">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="XOR doubly linked list" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-11-24T10:50:02+01:00" class="date" />
          <span itemprop="datePublished" content="2010-11-24T10:50:02+01:00" class="date">
            Nov 24, 2010 10:50:02
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/11/xor-doubly-linked-list/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/11/xor-doubly-linked-list/">XOR doubly linked list</a></h1>

        <span itemprop="articleBody">
          <p>Since a couple of days I’ve been working hard on the new Al Zimmermann’s Programming Contest: <a href="http://azspcs.net/Contest/Cards">Cards</a> (also called Topswops).</p>

<h1 id="the-challenge">The challenge</h1>

<p>The idea is very easy, you take a series of numbers, from 1 to N. You shuffle the numbers around, for example:</p>

<ul>
  <li>5,3,1,2,4</li>
</ul>

<p>Now we reverse the amount of numbers as stated by the first entry in the list. So in this case we reverse 5, and we get:</p>

<ul>
  <li>4,2,1,3,5</li>
</ul>

<p>We keep doing this, now reversing 4:</p>

<ul>
  <li>3,1,2,4,5</li>
  <li>2,1,3,4,5</li>
  <li>1,2,3,4,5</li>
</ul>

<p>At this point, 1 is in front, we are done! No more reversals are possible.</p>

<h1 id="the-problems">The problems</h1>

<p>When implementing this the first thing I did was to create an array and reverse parts of the array by swapping the items around. The problem is that the amount of swaps is pretty big!</p>

<p>So I started thinking about other ways to save the numbers in this challenge.. how about a linked list? This won’t work because when updating the linked list you’ll have to reverse all the pointers in the part you are reversing.</p>

<p>So how about using a doubly linked list? This won’t work because we have to swap the next/previous pointers for all the nodes we reverse.</p>

<h1 id="xor-doubly-linked-list">XOR doubly linked list</h1>

<p>Then I learned about the XOR doubly linked list. Let me explain how it works. The idea is that you don’t have next and previous pointers, but you just have one pointer. This pointer is both the next AND the previous pointer! How is this possible you might ask?</p>

<p>Well, this is where the XOR comes into play. Lets do a tiny bit of math:<br />
A ^ B = C<br />
Now:<br />
C ^ A = B<br />
C ^ B = A</p>

<p>A property of the XOR is, if we have one value, we can calculate what the other value is!</p>

<p>When we create the list we XOR the next and previous together, and we save the pointer to the first element in a seperate pointer. Lets say A = previous, B = next, C = stored value:</p>

<ul>
  <li>previous ^ next = stored value</li>
  <li>stored value ^ previous = next</li>
  <li>stored value ^ next = previous</li>
</ul>

<p>If we traverse our XOR doubly linked list we know the current element and the one before that (previous), so we can always calculate the pointer to the next element!</p>

<h1 id="the-advantages">The advantages</h1>

<p>So why would we do this? It involves a bit more processing power and will obviously save you half of the pointer-memory compared to a normal doubly linked list. We now keep one XOR-ed value instead of two pointers.</p>

<p>But there is another great advantage which might be usefull in the competition I mentioned above, reversability! As stated above using a doubly linked list wasn’t helpfull because when we reverse a part all the previous and next pointers have to be swapped. But we don’t have these pointers anymore, they are XOR-ed into one value! That means that we don’t have to change anything!</p>

<p>Lets assume we have a list of 80 items, and we want to reverse the first 40, what do we need to do now?</p>

<ol>
  <li>Traverse to the 40th element</li>
  <li>Adjust the value of the 40th pointer, now the first element:<br />
TERMINATOR ^ (PTR TO 39)</li>
  <li>Adjust the value of the 1st pointer, it must have<br />
(PTR TO 2) ^ (PTR TO 41)</li>
  <li>Adjust the value of the 41th pointer, it must have<br />
(PTR TO 1) ^ (PTR TO 42)</li>
  <li>Pointer to the first element is now 40 (this has become our first element)</li>
</ol>

<p>Done! We have adjusted three pointers and nothing in the middle. B.t.w. TERMINATOR is a value which indicates the boundaries of the first and last elements, I’ve used -1 for this. When traversing we use this to check if we are done.</p>

<p>Lets traverse the above reversed list, first we go to the first element (40) and perform the following XOR:</p>

<ul>
  <li>stored_value (40) ^ TERMINATOR = next (39)</li>
</ul>

<p>This will result in 39, now we continue:</p>

<ul>
  <li>stored_value (39) ^ previous (40) = next (38)</li>
  <li>stored_value (38) ^ previous (39) = next (37)</li>
  <li>…</li>
  <li>stored_value (2) ^ previous (3) = next (1)</li>
  <li>stored_value (1) ^ previous (2) = next (41) !!</li>
  <li>stored_value (41) ^ previous (1) = next (42) !!</li>
  <li>stored_value (42) ^ previous (41) = next (43) etc etc</li>
</ul>

<p>It works!</p>

<h1 id="a-bit-of-dissapointment">A bit of dissapointment</h1>

<p>After implementing this it doesn’t seem to be faster then using swaps to reverse everything in the whole array. This is probably due to a couple of things:</p>

<ul>
  <li>The locality of a normal array is faster in memory</li>
  <li>You’ll have to traverse N-nodes to reach the target to reverse</li>
  <li>The competition has max 97 elements, this might be too small to see the advantage</li>
</ul>

<p>My algorithm until now only used a single pointer to keep track of the first element, but it might be usefull to also keep a pointer to the last element. For example if we need to reverse everything up to N-1, I need to traverse from 1 to N-1. But if you have a last-element pointer, using the doubly in the XOR doubly linked list, we can just go backwards from N.</p>

<p>Ah well, it might not have been usefull (yet?) but it is a beautiful algorithm!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/11/xor-doubly-linked-list/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/11/patent-infrigement-part-2/" title="Patent infringement (part 2)">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Patent infringement (part 2)" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-11-24T09:56:46+01:00" class="date" />
          <span itemprop="datePublished" content="2010-11-24T09:56:46+01:00" class="date">
            Nov 24, 2010 09:56:46
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/11/patent-infrigement-part-2/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/11/patent-infrigement-part-2/">Patent infringement (part 2)</a></h1>

        <span itemprop="articleBody">
          <p>After a lot of comments on my blog asking about the code I decided to try getting it released one more time. Thus I mailed Digital Landmark Services again, telling them this is just a hobby project, and will (in its current form) never be a replacement for Shazam. Also, I explained a lot of people hated Shazam and deleted the application after reading this blog… the only thing they got out of it is bad marketing.</p>

<p>So I asked them for a peaceful solution, I’ll release the code, tell everybody Landmark Digital Services is a good company after all, and that’s it, both will benefit.</p>

<p>This is the reply I got:</p>

<blockquote>
  <p>Dear Mr. Van Rijn,</p>

  <p>I am an attorney for Landmark Digital Services. Thank you for your response and attention to this important matter. As we have stated in detail in previous communications, we would like you to refrain from releasing the code and to remove the blogpost explaining the algorithm. While we appreciate your thoughtful comments and questions, we have already made our position clear and hope you will respect our interest in our IP.</p>

  <p>Sincerely,<br />
XXX<br />
Attorney<br />
Woodcock Washburn</p>
</blockquote>

<p>WHAT!? They tell me again to remove the blogpost, this is crazy! A blogpost describing an algorithm can never be infrigement of intellectual property. The whole idea of a patent is to preserve an idea, to write down what it does and how it works for future generations. A patent has to be publicly available for this sole reason. This isn’t protecting their intellectual property, this is plain censorship.</p>

<p>My reply to the email was short an concise:</p>

<blockquote>
  <p>I’m sorry, but I can’t comply.</p>

  <p>Good luck.</p>
</blockquote>

<p>This was a week ago, lets see what they come up with this time…</p>

        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/11/patent-infrigement-part-2/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/09/handling-frame-switching/" title="Handling 'Frame switching'">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Handling 'Frame switching'" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-09-23T12:37:02+02:00" class="date" />
          <span itemprop="datePublished" content="2010-09-23T12:37:02+02:00" class="date">
            Sep 23, 2010 12:37:02
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/handling-frame-switching/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/09/handling-frame-switching/">Handling 'Frame switching'</a></h1>

        <span itemprop="articleBody">
          <p>A couple of days ago I noticed this tweet:</p>

<p><strong><a href="http://twitter.com/berenguel/status/25061642637">berenguel</a>: What is your view on ‘frame switching’?How do you manage (forced) interruptions of your workflow?How do you get the interruptor to give up?</strong></p>

<p>This is something I’m currently not experiencing, but I have been fighting this in the past. And I’ve come up with a quite effective way to eliminate this.</p>

<p><img src="/images/post-it-300x199.jpg" alt="Post-it" class="alignright" /></p>

<h1 id="priority-todo-list">Priority todo-list</h1>

<p>I’m just a regular guy, and just like all men I can only focus on a single thing. Context swithing/frame of reference switching is hard. If I’m working on a programming problem and people interrupt me, ask other technical questions, I lose my train of thought.</p>

<p>So, how do you counter this? Well, first I made a list of things to do. This is always good to have, it directs your focus. My list is priorized. For example:</p>

<ul>
  <li>Implement “General overview” page</li>
  <li>Fix bug with disappearing “Solve” button</li>
  <li>Refactor OfflineAvailableController</li>
  <li>Fix table layout bug</li>
</ul>

<p>Yay!</p>

<h1 id="coffee-time">Coffee time!</h1>

<p>The top post-it is the one I’m working on, that one has my complete focus. When the project lead comes and asks me questions, I ask him to prioritize it. He can add post-its to the list and/or shuffle the list. But there is one catch: Every time he changes or I finish the top priority I need a coffee break. This is my frame-switching moment, to clear my head.</p>

<p>If you do this, and keep doing this (no exceptions!) the project lead will start putting his ‘requests’ (interruptions) beneath your current piece of work, without distracting you. Because else you go for a cup of coffee first…. This is what we want. When we finish what we are currently doing we get a little coffee break. When we’ve fully cleared our head we look at the next item in the todo-queue.</p>

<p>Don’t worry, it may sound a bit rude, they’ll understand it if you explain the problem with frame-switching…! This just makes it visible.</p>

<p>p.s. Berengual will probably write a blog post about his own experiences with frame-switching, I’ll post a link when he does!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/handling-frame-switching/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/09/bug-fix-day/" title="Bug Fix Day!">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="Bug Fix Day!" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-09-22T16:25:36+02:00" class="date" />
          <span itemprop="datePublished" content="2010-09-22T16:25:36+02:00" class="date">
            Sep 22, 2010 16:25:36
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/bug-fix-day/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/09/bug-fix-day/">Bug Fix Day!</a></h1>

        <span itemprop="articleBody">
          <p>After a couple of iterations our software started to show some wear and tear. With all fat-GUI clients you always have some behaviour that isn’t exacly what you want, there are always glitches. More and more (Scrum) iterations followed and more and more glitches started accumulating in the application. These glitches are sometimes hard to fix and/or hard to reproduce, and they never made their way to our backlog.<br />
<img src="/images/computer-bug-300x199.jpg" alt="computer-bug" class="alignright" /></p>

<p>How do you solve this?</p>

<h2 id="bug-fix-day-concept">“Bug Fix Day” concept</h2>

<p>To improve the quirkiness and general impression of our application, as well as the teamspirit, I decided to hold a competition! This is how we did it:</p>

<h3 id="the-teams">The teams</h3>

<ol>
  <li>Take everybody, testers, project managers and of course the developers. Mix and create small groups of three (maybe four) people with a mixed skillset.</li>
  <li>Create a jury, in our case the two product-owners and a GUI-expert.</li>
  <li>One day the teams compete against eachother.</li>
</ol>

<h3 id="the-boards">The boards:</h3>

<p>You’ll also need two board:</p>

<ol>
  <li>Create a <strong>BugBoard</strong> with (on Post-its) all known existing glitches and bugs which need fixing.</li>
  <li>Create a <strong>TeamsBoard</strong> with a list of all the teamnames (make them come up with cool names!)</li>
</ol>

<h3 id="jury">Jury:</h3>

<p>The jury (product owners) must assign points to all the known bugs on the BugBoard, ranging from 1 point to 10 points.</p>

<ul>
  <li>1 point: minor importance</li>
  <li>…</li>
  <li>…</li>
  <li>10 points: important! fix asap</li>
</ul>

<h2 id="scoring-points">Scoring points</h2>

<p>Now the teams can do two things:</p>

<h3 id="fix-a-bug">Fix a bug</h3>

<p>Take a Post-it from the BugBoard and paste it behind your teamname on the TeamsBoard. There is a maximum of <strong>1 (!!)</strong> Post-it. Your team can only claim and work on one bug at the time. While you are doing this, nobody can work on that same bug.</p>

<p>When you have implemented a fix for the bug, commit it, let the jury check the result. Once the jury has verified the fix, you’ll get the assigned points!</p>

<h3 id="find-a-bug">Find a bug</h3>

<p>If you want you can also scan the application for new glitches and bugs. If you have found a (<strong>repeatable</strong>) bug, document it on a Post-it and give it to the jury. If they can reproduce the glitch/bug, they’ll assign points to the bug. For finding the bug you’ll receive half the bug’s points.</p>

<h2 id="extra-rules">Extra rules</h2>

<p>There are a couple of extra rules:</p>
<ol>
  <li>
    <p>The teams can only work on <strong>one</strong> workstation. You’ll have to pair up and work together. This will enforce the teams to look at each others code and learn.</p>
  </li>
  <li>
    <p>If you break the (continuous) build, you’ll lose points. For every minute the build is not green, a point is deducted from your team’s score.</p>
  </li>
  <li>
    <p>At the end of the day all the teams have to present their fixes.<br />
This will show everybody a couple of things:</p>
  </li>
</ol>

<ul>
  <li>How was the bug fixed?</li>
  <li>What was wrong?</li>
  <li>How could it have been prevented?</li>
</ul>

<ol>
  <li>Bonus points! To make it even more exiting we’ve introduced bonus points. Try to come up with original ideas! This is our list:</li>
</ol>

<ul>
  <li>Most impressive presentation: 2 points</li>
  <li>Hardest bug to fix: 2 points</li>
  <li>Best team name: 1 point</li>
  <li>Most original found bug: 1 point</li>
</ul>

<h1 id="possible-problems">Possible problems</h1>

<p>Of course there are possible problems you want to avoid:<br />
- People saving up bug-fixes<br />
- People introducing bugs, solve on bug fix day.<br />
- People not telling about glitches, report them on bug fix day.</p>

<p>We haven’t seen this behaviour yet, but you’ll have to trust the developers. Our team has enough professionalism to not have this problem (yet?).</p>

<h1 id="results">Results</h1>

<p>When I suggested this idea to our product owners they were very enthusiastic. About a week later we had our first Bug Fix Day and the results are very impressive.</p>

<ol>
  <li>All of the 10-point (most important) bugs had been solved</li>
  <li>Most other bugs/glitches had been resolved</li>
  <li>Despite people actively abusing the system, not a lot of new glitches could be found (in contrary to our impression).</li>
  <li>Developers loved it, teamspirit was very high. It was fun to see the competitive instinct during that day.</li>
  <li>Our team won, and got a very good lunch as surprise first prize (yay!).</li>
</ol>

<p>Other idea’s this concept could work for:<br />
- Performance Fix Day (improve performance)<br />
- Funny Features Day (build new features into the application)<br />
- Other ideas…?</p>

<p>If you decide to hold a Bug Fix Day at your company, I’d love to hear about the results!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/bug-fix-day/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  
    <article itemscope itemtype="http://schema.org/Article">
    <div class="post">

      <div class="post-thumbnail">
      	<a itemprop="mainEntityOfPage" href="/blog/2010/09/annotated-field-injection-vs-constructor-injection/" title="(Annotated) Field injection vs Constructor injection">
      	
      		<img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="(Annotated) Field injection vs Constructor injection" width="100" height="100" />
      	
    	</a>
      </div>
  
      <div class="post-data">
        <p class="post-meta">
          Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> 
          (<span itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">royvanrijn.com</span></span>) on 
          <span itemprop="dateModified" content="2010-09-21T11:35:41+02:00" class="date" />
          <span itemprop="datePublished" content="2010-09-21T11:35:41+02:00" class="date">
            Sep 21, 2010 11:35:41
          </span>
          : <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/annotated-field-injection-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
        <h1 itemprop="headline" class="post-title"><a class="title-link" href="/blog/2010/09/annotated-field-injection-vs-constructor-injection/">(Annotated) Field injection vs Constructor injection</a></h1>

        <span itemprop="articleBody">
          <p>A couple of people replied to my last article about constructor vs setter injection that they prefer a third option, field injection. This is a slight variant of setter injection in which we magically let the setter dissapear.</p>

<p>So, another blogpost here!</p>

<p>Let me first show what field injection looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Apple</span> <span class="o">{</span>  
    <span class="nd">@Inject</span>  
    <span class="kd">private</span> <span class="n">Orange</span> <span class="n">orange</span><span class="o">;</span>  
<span class="o">}</span></code></pre></figure>

<p>This is an example from the PicoContainer website, but Spring and Google Guice can do this too. So, you ask, what is wrong with this?</p>

<h1 id="testability">Testability</h1>

<p>I want the classes I write to be testable. Every class needs a test, and every class needs to be tested without the help of any other dependency. For every dependency in my class I want to be able to use a stub/mock implementation.</p>

<p>With constructor injection this is easy, just do new SomeClass(…). But this just can’t be done with field injection..! How do you test these classes? You have no way to construct the objects without bytecode-magic. You cannot create an instance of the above Apple class with its dependencies without using the DI-framework. And the last thing I want is the DI-framework in my unit tests. It makes the test slow, and as we all know, tests need to run as fast as possible to be effective.</p>

<h1 id="final-is-still-tricky">Final is still tricky</h1>

<p>When using field injection your fields can be made private, but you can’t make them final (!!). This is a common mistake, but look at the Google Guice wiki: <a href="http://code.google.com/p/google-guice/wiki/Injections">http://code.google.com/p/google-guice/wiki/Injections</a>.</p>

<p>Note the <strong>warning</strong>: “Avoid using field injection with final fields, which has weak semantics.”</p>

<h1 id="code-smell-is-wanted">Code smell is wanted</h1>

<p>And the final thing I don’t like about field injection… it looks good. This is a bad thing! I tried to explain this in the previous blogpost, but failed I guess. When using constructor injection you’ll notice when it gets ugly, you’ll see that long ugly constructor… and you’ll refactor the class. When using field injection this warning is forgotten.</p>

<p>Large constructor equals bad design. Don’t fix this by changing to setter or field injection, fix the underlying problem and improve your class granularity. The fact that is looks bad with more then 2 or 3 arguments is actually a big <strong>plus</strong>!</p>

<h1 id="annotations">Annotations</h1>

<p>Yes, annotations bind you to the framework, and they are evil. But so is XML. I have to agree on one thing, annotations (javax.inject) are a good thing. But still use constructor injection with these annotations please!</p>


        </span>

        <p class="post-meta">
          <a class="post-comments" href="https://royvanrijn.com/blog/2010/09/annotated-field-injection-vs-constructor-injection/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
    </article>
  
    <hr/>
  

  <!-- Pagination -->
  
  <div class="pagination">
    <div class="pagination-center">
    
      <div class="pagination-item"><a href="/page/8">&laquo; Prev</a></div>
    

    
      
        <div class="pagination-item"><a href="/index.html">1</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/2">2</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/3">3</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/4">4</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/5">5</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/6">6</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/7">7</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/8">8</a></div>
      
    
      
        <div class="pagination-item"><strong>9</strong></div>
      
    
      
        <div class="pagination-item"><a href="/page/10">10</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/11">11</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/12">12</a></div>
      
    

    
      <div class="pagination-item"><a href="/page/10">Next &raquo;</a></div>
    
    </div>
  </div>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-wrapper">
      
      <div class="footer-wrapper-content">
      
        <a href="https://www.linkedin.com/profile/view?id=10356027">
          <span class="svg-icon linkedin">Connect on LinkedIn</span>
        </a>
      
        <a href="http://stackoverflow.com/users/442274/roy-van-rijn">
          <span class="svg-icon stackoverflow">Follow me on StackOverflow</span>
        </a>

        <a href="https://github.com/royvanrijn">
          <span class="svg-icon github">Follow me on GitHub</span>
        </a>

        <a href="https://twitter.com/royvanrijn">
          <ispan class="svg-icon twitter">Follow me on Twitter</span>
        </a>
          
        <a href="/feed/index.xml">
          <span class="svg-icon rss">Check out the RSS feed</span>
        </a>
	  </div>
    
    </div>

  </div>

</footer>


  </body>

</html>
