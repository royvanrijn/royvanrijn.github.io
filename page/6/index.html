<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>royvanrijn  | Java, algorithms, math, science and more!</title>
  <meta name="description" content="Java, algorithms, math, science and more!">
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://royvanrijn.com/page/6/">
  <link rel="alternate" type="application/rss+xml" title="royvanrijn" href="http://royvanrijn.com/feed/" />
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

	<a class="site-title" href="/">
	  <img src="/images/header_royvanrijn.jpg" alt="royvanrijn" />
    </a>

    <nav class="site-nav">

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

  <!-- This loops through the paginated posts -->
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/08/meet-me-at-devoxx-2011/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/08/meet-me-at-devoxx-2011/">Meet me at Devoxx 2011</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Aug 5, 2011 15:53:21
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/08/meet-me-at-devoxx-2011/#disqus_thread">0 comments</a>
        </p>

        <p>This year I’ll be presenting at <a href="http://www.devoxx.com">Devoxx</a> in Antwerp, Belgium. In my opinion it currently is the best Java conference in the world. It’ll be my first talk in English.</p>

<p><img src="/images/LogoDevoxx150dpi.jpg" alt="Devoxx" /></p>

<p>The titel of the talk is: <em>What Shazam doesn’t want you to know</em>.</p>

<p>During the talk I’ll be explaining how Shazam works and how you can recreate this in Java yourself. But that’s not all.. I’m also including the grand challenge of teaching everybody how the Fourier Transformation works, without going into math (I’m math-illiterate).</p>

<p>Wish me luck, I’m really looking forward to it!</p>

<p>Are you coming to Devoxx? Or do you have hints/tips for me, let me know!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/08/meet-me-at-devoxx-2011/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/bitcoin-mining/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/bitcoin-mining/">Bitcoin mining</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 30, 2011 20:07:09
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/bitcoin-mining/#disqus_thread">0 comments</a>
        </p>

        <p>A couple of months ago I’ve started using and mining bitcoins. If you don’t know what bitcoin is yet, please watch the following video:<br />
&lt;iframe id="ytplayer" type="text/html" width="640" height="390" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen src="http://www.youtube.com/embed/Um63OQz3bjo"&gt;&lt;/iframe&gt;</p>

<p>Mining for bitcoins has become harder and harder. But as a pro, the price of the bitcoin has also increased quite a lot. Since I’ve started mining I’ve mined about 40 bitcoins (in pools). This is now worth about 9 dollars per bitcoin: 360 dollars!</p>

<p>Mostly I’ve used my GPU for mining, this gives me the greatest speed. I found the Diablo Miner works best in my case, I even <a href="https://github.com/Diablo-D3/DiabloMiner/archives/master">pushed</a> some improvements into the codebase to let it work through proxies. But since a couple of days I’ve had a bitcoin miner in Java applet form running on this website! This is currently giving me about the same amount of bitcoins. Still, it is only about 0.01 bitcoin per day. Which comes down to 10 dollar cents a day. But still this is more then I earn for ads!</p>

<p>I’ve removed the bitcoin applet from my main page (it can scare visitors if the CPU runs to 100%). But you can still use it on this website:</p>

<p><strong>SCRIPT DISABELED</strong></p>

<p>So, don’t hesitate to hang around here for a while, with this page open :-) Lets see how much bitcoins my visitors can generate!</p>

<p>Oh, to see the current ‘exchange rate’ of the Bitcoin, you can always view it on <a href="https://mtgox.com/trade/megaChart">Mt Gox</a>.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/bitcoin-mining/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/android-application-1/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/android-application-1/">Android application #1</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 29, 2011 18:22:14
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/android-application-1/#disqus_thread">0 comments</a>
        </p>

        <p>This weekend I wrote my first Android application: <a href="https://market.android.com/details?id=com.royvanrijn.android.lovehate">Love or Hate</a>  </p>

<p>The idea behind the game is very simple. When you start it the application goes online and looks at the most recent tweets containing the following phrases:</p>

<ul>
  <li>“I love it when”</li>
  <li>“I hate it when”</li>
</ul>

<p>The application now displays some user information (username/profile picture) and shows parts of the tweet. The words “love” and “hate” are removed and the user has to guess which of the two words was in the original tweet.  </p>

<h1 id="backend">Backend</h1>

<p>The backend of this is only Twitter itself. And connecting to Twitter was really easy. I’ve used <a href="http://www.winterwell.com/software/jtwitter.php">JTwitter</a>, a small API that helps searching Twitter. The code itself to find the tweets was only about 20 lines.  </p>

<h1 id="frontend">Frontend</h1>

<p>So that leaves me with the Android/telephone part. The first problem is the lack of Android phone. I don’t have one… But luckely when you install the Android SDK and Eclipse with the Android plugin, everything is ready, including an emulator. The first important thing I learned was to leave the emulator running. You don’t have to close the emulator to deploy a new version. This will greatly improve development speed. But as I learned when teaming up with two colleagues Ron and Jan-Kees, having an Android device is much easier still.</p>

<p>The next discovery was: Android isn’t at all like Swing. It mostly evolves around XML layouts. So creating a GUI feels much more like creating an XHTML web application then working with a Java GUI. Creating the GUI was much harder then I thought it would be. And this application still has a very bad GUI. It must be a disaster creating applications that run correctly fullscreen on all different devices! This is probably an area where Apple has a huge advantage offering only two different screen sizes (iPhone/iPad). After fiddling a long time I got the application looking like I could get away with it. Not great, but everything was on it.  </p>

<p>One good thing about Android development is the use of externalized Strings. If you follow their advice and put all text in the string.xml file it becomes very easy to release the application in multiple languages. As a quick test I’ve released my application in English (default), Dutch and French.  </p>

<h1 id="releasing-to-the-market">Releasing to the Market</h1>

<p>Of course I could have stopped here, but I wanted to release something to the Android Market. Even though the application looks ugly, it is playable and my colleagues even enjoyed playing it for a short while. The first step is creating a signed zipaligned APK file. This was very easy using the Eclipse plugin. Just click on “Export as signed Android application” and you are done. It even performs the zipalign step, in which it optimizes the APK file for the release.  </p>

<p>To get you application in the market you need to have a Android Market account. Opening one costs 25 euro (only one time, not per application), and although I don’t think I’ll even see that return on investment, I’ve decided to do it anyway. The only thing left for me was to upload the application, including a lot of artwork (screenshots/icons/thumbnails/misc descriptions).  </p>

<h1 id="adding-ads-from-admoblogoheaderadmoblogoheader">Adding ads from <img src="/images/ad_mob_logo_header.gif" alt="ad_mob_logo_header" /></h1>

<p>Now that I’ve invested 25 euro’s, I decided I need some way to try and earn some money back. This actually proved to be the easiest thing in the whole project. With just 5 or 6 lines of code you can add <a href="http://www.admob.com/">AdMob</a> ads in your application. You can read about it <a href="http://code.google.com/intl/nl/mobile/ads/docs/android/fundamentals.html">here</a>.  </p>

<h1 id="results">Results</h1>

<p>After one day I’m pretty surprised: Already 350 people have downloaded the application and I’ve already earned &gt; 50 cents from AdMob (2% ROI).  </p>

<p>I’ve really enjoyed doing something new, and I might do more Android hobby-projects in the future. If you have any ideas, please tell me :-)</p>

<p>(p.s. No, I’m not going to port my <a href="/blog/2010/06/creating-shazam-in-java/">music matching algorithm</a> to Android and get <a href="/blog/2010/07/patent-infringement/">sued</a>)</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/android-application-1/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/wedding-video/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/wedding-video/">Wedding video</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 23, 2011 10:52:16
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/wedding-video/#disqus_thread">0 comments</a>
        </p>

        <p>This weekend I was invited to a friends wedding. She asked if I could film everything that happened. This was basically the first time I’ve filmed something. I decided to edit everything together with some music. Here is the result:</p>

<iframe src="http://player.vimeo.com/video/24091005?title=0&amp;byline=0&amp;portrait=0" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>

<p>It was a very nice day and I had a blast filming and editing everything. It is very rewarding! I really have to do this more often, but coming up with ideas to film is hard…</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/wedding-video/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/gods-dice/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/gods-dice/">God's Dice</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 9, 2011 09:07:36
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/gods-dice/#disqus_thread">0 comments</a>
        </p>

        <p>Yay! There is a new Virtual Source Programming Contest: <a href="http://www.v-sonline.com/index.pl?home">“God’s Dice”</a></p>

<p><a href="/images/godsdice.png"><img src="/images/godsdice.png" alt="godsdice" class="alignright" /></a></p>

<p>After a bit of a messy start of the contest, within hours three people had a 100% score (almost, 99.99% due to some rounding errors). This sparked James, the organizer, to change the rules a bit. Now the contest is running smoothly, the loophole is removed.</p>

<p>The goal of the contest is this:</p>

<ol>
  <li>Take a cube, with all sides length 1</li>
  <li>Place N (9 to 88) points anywhere on the surface of the cube</li>
  <li>Now calculate the surface area of all triangles between your points</li>
  <li>Your score is: totalSurfaceArea * (smallestTriangleSurfaceArea ^ 2)</li>
</ol>

<p>So basically you need to create triangles as large as possible, BUT, all triangles need to be large. One smaller triangle will exponentially screw up the score.</p>

<p>Up to now I’ve only written a scorer and a basic random searcher just to get myself on the leaderboard. Now it is time to do something a bit smarter, maybe just a better search algorithm, but I’ll probably need something a lot smarter, incorporating geometric knowledge. For example, moving one point changes all triangles involved. So we could test only these triangles to see if they improve (instead of re-testing the whole cube).</p>

<p>And I’ve got some other idea’s, which I won’t share obviously for the contest sake!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/gods-dice/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/website-theme/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/website-theme/">New website theme</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 7, 2011 01:52:14
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/website-theme/#disqus_thread">0 comments</a>
        </p>

        <p>When browsing through the posts on <a href="http://www.dzone.com">DZone</a> I noticed a couple of new Wordpress plugins. When I tried them (on my live website of course) everything failed and produced errors. And of course I didn’t do a proper backup before I started… sigh.</p>

<p>Anyway, I was able to login with FTP, find the broken file and fix it (PHP, blegh)! But then I started experimenting with other parts of the website and tried some different WordPress themes. I’ve had the previous theme for a couple of years now. Time for something new! What do you guys think about this new one?</p>

<h1 id="south-africa">South Africa</h1>

<p>The photo in the header, with the zebra’s, was taking during my holiday in South Africa last year.</p>

<p><strong>Edit:</strong> The zebra picture made it look like a website of the WNF, so I changed it!</p>

<p>Some more:</p>

<table style="width:auto;"> 
 <tbody>
  <tr> 
   <td><a href="https://picasaweb.google.com/lh/photo/P4ZCH4nc9ynPOshHpoZjXw?feat=embedwebsite" rel="nofollow"><img src="/images/IMG_2781.JPG" height="273" width="400" /></a></td> 
  </tr> 
 </tbody>
</table>

<table style="width:auto;"> 
 <tbody>
  <tr> 
   <td><a href="https://picasaweb.google.com/lh/photo/L-MmLLMsr_fPMz7DSSuROg?feat=embedwebsite" rel="nofollow"><img src="/images/IMG_2830.JPG" height="347" width="400" /></a></td> 
  </tr> 
 </tbody>
</table>

<table style="width:auto;"> 
 <tbody>
  <tr> 
   <td><a href="https://picasaweb.google.com/lh/photo/58OyZrL9E0I7RRizUfEA0g?feat=embedwebsite" rel="nofollow"><img src="/images/IMG_1702.JPG" height="267" width="400" /></a></td> 
  </tr> 
 </tbody>
</table>

<table style="width:auto;"> 
 <tbody>
  <tr> 
   <td><a href="https://picasaweb.google.com/lh/photo/sv8mcFnsZbDS1zlnR6uHwA?feat=embedwebsite" rel="nofollow"><img src="/images/IMG_1934.JPG" height="267" width="400" /></a></td> 
  </tr> 
 </tbody>
</table>

<table style="width:auto;"> 
 <tbody>
  <tr> 
   <td><a href="https://picasaweb.google.com/lh/photo/RXXK8n25F2S877QXLHzIXw?feat=embedwebsite" rel="nofollow"><img src="/images/IMG_2852.JPG" height="256" width="400" /></a></td> 
  </tr> 
 </tbody>
</table>

<p>The complete (online) collection can be found here: <a href="https://picasaweb.google.com/roy.van.rijn/ZuidAfrika">https://picasaweb.google.com/roy.van.rijn/ZuidAfrika</a></p>

<h1 id="avatar">Avatar</h1>

<p>For years and years I’ve also been using this avatar:<br />
<img src="/images/avatar.png" alt="this is me online" /><br />
A lot of people have asked me why I’m using that avatar instead of a normal photo. I’ve been using this image since my teen years, when I had acne all over the place. I’ve just kept using it, and now people actually recognize it.</p>

<p>I’ve drawn that cartoon image myself, no idea what it resambles, just something unidentified creature. It was actually drawn over a photo of our family pet dog Dana. Which my parents are probably going to have to put down pretty soon. She is now very old and sick, it is just a matter of days…</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/website-theme/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/05/crowdflow-needs-you/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/05/crowdflow-needs-you/">Crowdflow needs you!</a></h1>
      
        <p class="post-meta">
          <span class="date">
            May 1, 2011 18:03:55
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/crowdflow-needs-you/#disqus_thread">0 comments</a>
        </p>

        <p><a href="http://crowdflow.net/">Crowdflow</a> wants to have your iPhone data, to generate pretty heatmaps!</p>

<p>Why am I telling you this? Because they are using my backup-data-extractor code! See their most recent <a href="http://crowdflow.net/blog/2011/05/01/about-the-java-applet/">blog</a> entry.</p>

<p>The images they produce look very good, much better then the KML file in Google Earth!</p>

<p>Be sure to help them soon, because Apple is working on deleting most location-data with the next iPhone update. After that, probably the next update, they’ll encrypt the location data so it is much harder/impossible to read.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/05/crowdflow-needs-you/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/04/iphone-locations-on-google-maps-with-javascript/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/04/iphone-locations-on-google-maps-with-javascript/">iPhone locations on Google Maps with Javascript</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Apr 26, 2011 14:34:27
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/iphone-locations-on-google-maps-with-javascript/#disqus_thread">0 comments</a>
        </p>

        <p>Wow, great news!</p>

<p>After my <a href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/">previous</a> blogpost a lot of people mailed me about the usability of my ‘iPhone location data to Google Earth’ tool. It was a command-line tool, and you needed to have Java 6 installed. The main goal was to show how it is done in Java, for other developers.</p>

<p>When chatting to <a href="https://github.com/williame">Will</a> about this he suggested using Javascript instead. Soon he had the code working that could parse the iPhone backup files. He then contacted <a href="https://github.com/markolson">Mark Olson</a>, who helped him with the SQLLite format in Javascript. Together they finished it up so the resulting GPS data is shown in Google Maps.</p>

<p>The result of their effort: <a href="http://markolson.github.com/js-sqlite-map-thing/">http://markolson.github.com/js-sqlite-map-thing/</a></p>

<p>To use it, drag the backup files into the upper part of the website. It will parse the files, locate the data and display the track on Google Maps!<br />
The source code can be found here: <a href="https://github.com/markolson/js-sqlite-map-thing">https://github.com/markolson/js-sqlite-map-thing</a></p>

<p>Kudos to Will and Mark for this great application. Who knew Javascript could be this powerfull!?</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/iphone-locations-on-google-maps-with-javascript/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/">Reading iPhone GPS data from backup (with Java)</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Apr 21, 2011 01:06:24
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/#disqus_thread">0 comments</a>
        </p>

        <p>Today I noticed the following post on Slashdot: <a href="http://apple.slashdot.org/story/11/04/20/1357248/Apple-Logging-Locations-of-All-iPhone-Users">Apple Logging Locations of All iPhone Users</a></p>

<p>And the article they are referring to can be found <a href="http://petewarden.github.com/iPhoneTracker/">here</a></p>

<p>First I was amazed, how can Apple do this? But on second thought, they aren’t sending it yet to anybody, it is just something on the phone (and also on the phone’s backup). My next reaction was: I want to see my own map! But to my disappointment it only works on Apple Mac’s, not Windows/Linux.</p>

<h1 id="re-building-it-in-java">(Re-)building it in Java</h1>

<p>Because their code is open source and well explained on the website I decided to make my own version, in Java (cross platform!). Now, just a couple of hours since I read the article, I’ve got it working and it can be used as a base for extention. So I’d like to share the code!</p>

<h1 id="step-1-getting-the-correct-file">Step 1: Getting the correct file</h1>

<p>This step was the hardest part, technically. The backup Apple makes doesn’t just have all the files as they are on your iPhone. Instead they all have names like: “b4d1c79c2f5fc1da044c18d1066b80b39b575590”. They do however store the information in two files: Manifest.mbdb and Manifest.mbdx.</p>

<p>The MBDB file only contains information about the original files, and the MBDX file contains pointers into the MBDB file with the Hex-filenames used in the backup. So we need to parse both files to be able to connect the original filename to the Hex-filename.</p>

<p>Luckely somebody already did this in Python and posted it on <a href="http://stackoverflow.com/questions/3085153/how-to-parse-the-manifest-mbdb-file-in-an-ios-4-0-itunes-backup">stackoverflow</a>. I took their idea and translated it into Java code.</p>

<p>When this was fully translated it could resolve all the filenames. This meant I could map the target file “Library/Caches/locationd/consolidated.db” to the hex-filename “4096c9ec676f2847dc283405900e284a7c815836”.</p>

<h1 id="step-2-reading-the-sqllite-file">Step 2: Reading the SQLLite file</h1>

<p>The contents of “4096c9ec676f2847dc283405900e284a7c815836” is just a SQLLite file. For this I decided to use SQLJet, a framework that can read(/and write) SQLLite files. Using just a couple of lines of code I had all the data I need: timestamp, latitude, longitude (and more! speed, course, confidence, altitude etc).</p>

<h1 id="step-3-what-to-do-with-the-geo-data">Step 3: What to do with the geo data?</h1>

<p>The implementation created by <a href="http://petewarden.github.com/iPhoneTracker/">Pete Warden</a> has a nice map and timeline. But at this time I wanted to have results as fast as possible. That is why chose to just output a <a href="http://nl.wikipedia.org/wiki/Keyhole_Markup_Language">KML</a> file. KML is a file format used by Google Earth and other applications.</p>

<p>The results are far from nice (just plain ugly) but fun: <a href="https://sites.google.com/site/redcodenl/home/281096076.jpg">click here for a screenshot</a></p>

<h1 id="running-the-code">Running the code</h1>

<p>The above code is mainly created for developers, the resulting JAR can’t be executed. But I’m aware people will want to just have the KML file, and not go through the code. That is why I’ve uploaded an executable JAR. You can get it here: <a href="https://sites.google.com/site/redcodenl/runnableiPhoneJTrack.zip">runnableiPhoneJTrack.zip</a> (813 KB)</p>

<p>To run the program, extract the three JAR-files and type:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Usage:
java -jar iPhoneJTrack.jar &quot;&lt;location of backup directory&gt;&quot;

For example:
java -jar iPhoneTracker.jar &quot;C:\Users\roy\AppData\Roaming\Apple Computer\MobileSync\Backup\b4d1c79c2f5fc1da044c18d1066b80b39b575590&quot;</code></pre></figure>

<p>This outputs a file named iPhoneData.kml, which can be loaded for example in Google Earth.</p>

<h1 id="playing-with-the-code">Playing with the code</h1>

<p>I’ve pushed my code onto GitHub: <a href="https://github.com/royvanrijn/iPhoneJTrack">https://github.com/royvanrijn/iPhoneJTrack</a></p>

<p>Feel free to add features and send me pull requests!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/reading-iphone-gps-data-from-backup-with-java/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/04/static-state-evil-as-well/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/04/static-state-evil-as-well/">Static state: Evil as well</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Apr 19, 2011 19:23:26
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/static-state-evil-as-well/#disqus_thread">0 comments</a>
        </p>

        <p>Today in our project we suddenly had 10 failing unit-tests on our integration server (Hudson). Opening Hudson and looking at the first failed build I was in for a surprise. The only code changed that commit was mine!</p>

<h1 id="the-scare">The scare</h1>

<p>Quickly I looked around and went into overdrive mode:<br />
<em>I need to fix this bug before somebody sees it!<br />
I’m always yelling at people who break the build, and now it has happend to me…!</em>  </p>

<p>Looking at the SVN comment it only said: “cleaned up some code” (or something)<br />
That isn’t very helpfull of myself…</p>

<h1 id="the-second-scare">The second scare</h1>

<p>Then I noticed I changed only one file. The change should be contained and easy to fix. But then I had a moment of relief and scare at the same time:</p>

<ul>
  <li>Phew, it isn’t my fault… removing empty lines should not break builds…</li>
  <li>But… why the heck does removing an empty line break the build!?</li>
</ul>

<h1 id="the-culprit">The culprit</h1>

<p>After looking around in the code, and the failing tests a collegue and me found the culprit: statefull static.</p>

<p>In our application we’ve introduced a static class called GlobalContext. In this class we keep session information, things like the MapState (we have a map, which has dimensions, view extents, etc). And throughout the code we read this information and mutate it. To unit-test the code we added setters to inject mock MapState’s into the GlobalContext.</p>

<p>Running all the unit tests in Eclipse always runs them synchronously, and everything is fine. But this goes horribly wrong when running Maven and/or the Hudson build. Surefire takes all test classes and runs them parallel! So when one test is busy reading the state of our static class, another test is setting different information in the same static class! This causes NPE’s and other weird values. Until now we have been lucky the tests all ran correctly, but after my commit, the execution-order appearantly changed.</p>

<h1 id="the-fix">The fix</h1>

<p>The only way to fix this is removing the static-ness of the GlobalContext. Since we are also using Spring we can just put an instance of the MapState in Spring and inject that into the classes that use it. That way, when doing tests you can inject the mock-instance into the instances you are testing! This solves everything…</p>

<p>Even better, get rid of the GlobalContext at all. It contained a couple of instances that could easily be injected into the other objects. This makes it much clearer to see which objects depend on which other objects and makes the code a heck of a lot easier to test.</p>

<h1 id="lessons-learned">Lessons learned…</h1>

<p>This got me thinking, in which cases should you use static? Obviously “public static final”-fields are useful. And maybe static functions in Utility classes, which have no state and only mutate data. But are there cases when you really need static state? I’ve been thinking about this for a day now, but I can’t come up with any good usecase. Do you know any? Mail me, comment below!</p>

<p>So for now, my new rule: Don’t use static unless you have a very good reason, and never ever have static (mutable) state!</p>

<p>p.s. And people, stop using SimpleDateFormat as fields, they are not threadsafe and cause weird exceptions and weird dates! I was lucky to catch one in our code today before weird errors occured.</p>


        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/static-state-evil-as-well/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/04/checked-exceptions-evil/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/04/checked-exceptions-evil/">Checked Exceptions: Evil</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Apr 19, 2011 18:13:55
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/checked-exceptions-evil/#disqus_thread">0 comments</a>
        </p>

        <p>Today somebody posted a comment:</p>

<blockquote>
  <p>‘Could you write a post giving more details on why you think<br />
checked exceptions are “the embodiment of evil”?’</p>
</blockquote>

<p>So here it is.  </p>

<p>As you can see I haven’t written a post in a long time (sorry). This post is also not going to be very comprehensive. Of course I could explain everything, but I’d rather link to another site which sums it up very nicely:<br />
<a href="http://c2.com/cgi/wiki?TheProblemWithCheckedExceptions">http://c2.com/cgi/wiki?TheProblemWithCheckedExceptions</a></p>

<p>Basically, I don’t want to be forced to handle exceptions. Also, having to catch checked exceptions makes code unreadable, complex and harder to change/refactor.</p>

<p>Of course I’m also aware that with runtime exceptions you are likely to forget to catch some exceptions, which is also very bad. That is why our application(s) catch and log all runtime exceptions and mail them to the developers. Execptions are always something very bad and should not be functional, exceptions should be… exceptions. Once they happen, all hell should break out and it should be fixed.</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/04/checked-exceptions-evil/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/">De Bruijn sequence in constant amortized time</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Feb 24, 2011 22:29:29
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/#disqus_thread">0 comments</a>
        </p>

        <p>Follow up on the previous blogpost.</p>

<p>Yesterday I wrote an algorithm in Java to generate de Bruijn sequences. But I had a breakthrough after reading:</p>

<p><em>K. Cattell, F. Ruskey, J. Sawada, M. Serra, C.R. Miers, Fast algorithms to generate necklaces, unlabeled necklaces, and irreducible polynomials over GF(2)</em></p>

<p>It has an algorithm which generates Lyndon words in CAT. CAT stands for Constant Amortized Time. This means that is isn’t really constant time, but approaches it very much. Calculating the worst-case scenario isn’t worth it. For example using an ArrayList in Java. The time to do insertions is said to be O(1), and this is true…. until the array underneath needs to be resized. During this resize it’ll take some more time. So the algorithm isn’t really constant time, but constant amortized time.</p>

<p>This is the program I ended up with. It is very very small. One of my most beautiful pieces of code. And it even supports non-binary alphabets (use the k-parameter).</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="nf">generateDeBruijnSequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">StringBuilder</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">();</span>
	<span class="n">generateLyndonWords</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">],</span> <span class="n">sequence</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">sequence</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">generateLyndonWords</span><span class="o">(</span><span class="kt">int</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">a</span><span class="o">,</span> <span class="n">StringBuilder</span> <span class="n">sequence</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">)%</span><span class="n">p</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">sequence</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="o">];</span> 
		<span class="n">generateLyndonWords</span><span class="o">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">p</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">sequence</span><span class="o">);</span>
		<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="o">]+</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">a</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span> 
			<span class="n">generateLyndonWords</span><span class="o">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">t</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">sequence</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><strong>Update June 7th 2012:</strong><br />
I just stumbled across this interesting read: <a href="http://www.learner.org/courses/mathilluminated/units/2/textbook/07.php">http://www.learner.org/courses/mathilluminated/units/2/textbook/07.php</a></p>

<p>The keypad example from that link can be easily calculated with the code above:<br />
generateDeBruijnSequence(9, 5).length() = 59049 :-)</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/de-bruijn-sequence-in-constant-amortized-time/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/">Generating de Bruijn sequences and Lyndon words</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Feb 24, 2011 10:32:52
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/#disqus_thread">0 comments</a>
        </p>

        <p>Not so long ago I encountered something called the <a href="http://en.wikipedia.org/wiki/De_Bruijn_sequence">de Bruijn sequence</a>. For now I’ll only use this for an alphabet of (0,1), binary. But everything said here could also be applied to other alphabets. In this post I’ll describe what this sequence is, and how you can generate them, using <a href="http://en.wikipedia.org/wiki/Lyndon_word">Lyndon words</a>.</p>

<h1 id="what-is-a-de-bruijn-sequence">What is a de Bruijn sequence?</h1>

<p>Well, it is a sequence (again, in this case binary) which contains all combinations/permutations of a specific length. And it does this only once.<br />
For example: B(2,4)</p>

<ul>
  <li>000100110101111 (000)</li>
</ul>

<p>This sequence contains all possible permutations you can make in binary of length 4. The last part (000) is optional, and needed it you do not want the sequence looped. As you can see, the length of this sequence is 16. All sequences will have length 2^N.</p>

<h1 id="how-do-you-construct-these-sequences">How do you construct these sequences?</h1>

<p>The next thing I wanted to know is how to construct these sequences. The first hit I got was from the <a href="http://mathworld.wolfram.com/deBruijnSequence.html">MathWorld</a> website. It states:<br />
<em>Surprisingly, it turns out that the lexicographic sequence of Lyndon words of lengths divisible by N gives the lexicographically smallest de Bruijn sequence (Ruskey).</em></p>

<h1 id="lyndon-word">Lyndon word..?</h1>

<p>It seems that the next step is generating Lyndon words. Lyndon words are the lexographically smallest rotation of a word. I haven’t yet found a proper way to do this (I know there are) so here is what I do:</p>

<p>Pseudo:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">lastLyndon = -1
for all possible N&#39;s {
    currentSmallestLyndon = smallestLyndonRotation(N)
    if( currentSmallestLyndon &gt; lastLyndon ) {
        lastLyndon = currentSmallestLyndon
        print currentSmallestLyndon
    }
}</code></pre></figure>

<p>And here is what I used to generate the smallestLyndonRotation (Java):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BigInteger</span> <span class="nf">smallestLyndonRotation</span><span class="o">(</span><span class="n">BigInteger</span> <span class="n">input</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">BigInteger</span> <span class="n">lowestForm</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span>
	<span class="n">BigInteger</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BigInteger</span><span class="o">.</span><span class="na">ONE</span><span class="o">;</span>
	<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">BigInteger</span> <span class="n">possibleLowerForm</span> <span class="o">=</span> <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">mask</span><span class="o">).</span><span class="na">shiftLeft</span><span class="o">(</span><span class="n">size</span><span class="o">-</span><span class="n">i</span><span class="o">)).</span><span class="na">or</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">mask</span><span class="o">.</span><span class="na">negate</span><span class="o">()).</span><span class="na">shiftRight</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">mask</span><span class="o">.</span><span class="na">shiftLeft</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
		<span class="k">if</span><span class="o">(</span><span class="n">possibleLowerForm</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">lowestForm</span><span class="o">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">lowestForm</span> <span class="o">=</span> <span class="n">possibleLowerForm</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">lowestForm</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>How does it work? Well, for example the input is: 0010.<br />
It loops over all rotations (using some bit-masking):</p>

<ul>
  <li>0010</li>
  <li>0100</li>
  <li>1000</li>
  <li>0001</li>
</ul>

<p>And finds the smallest lexographically (0001) and returns this.</p>

<p>The above pseudo code will spit out the following numbers:</p>

<ul>
  <li>0000</li>
  <li>0001</li>
  <li>0011</li>
  <li>0101</li>
  <li>0111</li>
  <li>1111</li>
</ul>

<p>These are all the Lyndon words for N=4.</p>

<h1 id="splitting-reducing-the-lyndon-words">Splitting, reducing the Lyndon words</h1>

<p>Now if we put the Lyndon words together we get:</p>

<ul>
  <li>000000010011010101111111 (our sequence)</li>
  <li>0000100110101111 (de Bruijn sequence)</li>
</ul>

<p>We aren’t quite there yet… but there is some resemblance. There is one more step left, we have to reduce/split the Lyndon words into its smallest unique part.</p>

<p>Lets take the Lyndon words again:</p>

<ul>
  <li>0000 -&gt; 0 (4x)</li>
  <li>0001 -&gt; 0001</li>
  <li>0011 -&gt; 0011</li>
  <li>0101 -&gt; 01 (2x)</li>
  <li>0111 -&gt; 0111</li>
  <li>1111 -&gt; 1 (4x)</li>
</ul>

<p>Results in: 0000100110101111, the sequence!</p>

<p>And that is it! If we’ve created the smallest possible de Bruijn sequence for B(2,4).</p>

<p>Here are some more sequences:</p>

<ol>
  <li>01</li>
  <li>0011</li>
  <li>00010111</li>
  <li>0000100110101111</li>
  <li>00000100011001010011101011011111</li>
  <li>0000001000011000101000111001001011001101001111010101110110111111</li>
  <li>00000001000001100001010000111000100100010110001101000111100100110010101001011100110110011101001111101010110101111011011101111111</li>
  <li>00000000100000011000001010000011100001001000010110000110100001111000100010011000101010001011100011001000110110001110100011111001<br />
00101001001110010101100101101001011110011001101010011011100111011001111010011111101010101110101101101011111011011110111011111111</li>
  <li>00000000010000000110000001010000001110000010010000010110000011010000011110000100010000100110000101010000101110000110010000110110<br />
00011101000011111000100011000100101000100111000101001000101011000101101000101111000110011000110101000110111000111001000111011000111<br />
10100011111100100100101100100110100100111100101001100101010100101011100101101100101110100101111100110011100110101100110110100110111<br />
10011101010011101110011110110011111010011111110101010110101011110101101110101110110101111110110110111110111011110111111111</li>
</ol>

<p>You can download my complete (Java) source code: <a href="/images/BinaryDeBruijnSequenceGenerator.zip">BinaryDeBruijnSequenceGenerator.zip</a></p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/generating-de-bruijn-sequences-and-lyndon-words/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/02/unit-testing-a-chess-engine/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/02/unit-testing-a-chess-engine/">Testing a chess engine</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Feb 7, 2011 10:02:46
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/unit-testing-a-chess-engine/#disqus_thread">0 comments</a>
        </p>

        <p>About a week ago I decided to try and write a chess engine. I’ve encountered <a href="http://en.wikipedia.org/wiki/Bitboard">bitboards</a> before, and I really liked working with them. Most references I found had to do with chess engines, so I decided to have a go.</p>

<p>The single most important and time consuming aspect of building a chess engine is legal <a href="http://chessprogramming.wikispaces.com/Move+Generation">move generation</a>. In all situations, be able to generate all legal moves that can be made on the board. At first this seems pretty straight forward, all pieces can move and attack in certain ways. But when you get to specific rules like castling and en-passant things get really tricky.</p>

<p>But how do you know for sure your engine works and gets the right results? The many chess engine developers around the world found a great solution for this problem. Something I can only describe as universal integration-tests! They call it “perft” (from performance test). The first thing they do it create a particulair situation on the chess board. This can be described like in <a href="http://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">FEN notation</a>.<br />
For example:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1
    (initial chess starting position)</code></pre></figure>

<p>All chess engines use this small language and understand how to set up their internal board. The next step is to generate all possible moves. From the example FEN above all possible moves are just 20 moves. But why stop here? From these 20 moves calculate all legal moves the opponent can make (also 20) which results in 400 moves. Continue doing this and you’ll end up with a table like this:</p>

<table> 
 <tbody>
  <tr> 
   <td style="text-align: right;"><strong>Depth</strong><br /> </td> 
   <td style="text-align: right;"><strong>Nodes</strong><br /> </td> 
   <td style="text-align: right;"><strong>Captures</strong><br /> </td> 
   <td style="text-align: right;"><strong>E.p.</strong><br /> </td> 
   <td style="text-align: right;"><strong>Castles</strong><br /> </td> 
   <td style="text-align: right;"><strong>Promotions</strong><br /> </td> 
   <td style="text-align: right;"><strong>Checks</strong><br /> </td> 
   <td style="text-align: right;"><strong>Checkmates</strong><br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">1<br /> </td> 
   <td style="text-align: right;">20<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">2<br /> </td> 
   <td style="text-align: right;">400<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">3<br /> </td> 
   <td style="text-align: right;">8902<br /> </td> 
   <td style="text-align: right;">34<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">12<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">4<br /> </td> 
   <td style="text-align: right;">197281<br /> </td> 
   <td style="text-align: right;">1576<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">469<br /> </td> 
   <td style="text-align: right;">8<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">5<br /> </td> 
   <td style="text-align: right;">4865609<br /> </td> 
   <td style="text-align: right;">82719<br /> </td> 
   <td style="text-align: right;">258<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">27351<br /> </td> 
   <td style="text-align: right;">347<br /> </td> 
  </tr> 
  <tr> 
   <td style="text-align: right;">6<br /> </td> 
   <td style="text-align: right;">119060324<br /> </td> 
   <td style="text-align: right;">2812008<br /> </td> 
   <td style="text-align: right;">5248<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">0<br /> </td> 
   <td style="text-align: right;">809099<br /> </td> 
   <td style="text-align: right;">10828<br /> </td> 
  </tr> 
 </tbody>
</table>

<p>As you can see, the numbers in these tables quickly become huge. This will ensure that a lot of situations are tested. Using these tables you can check if your program outputs the same values, and thus complies to all the rules. There are a lot of these tables online, using a FEN for starting position, and a table with all nodes that can be generated.</p>

<p>The next problem is, when your numbers don’t add up, how do you find the move 6 levels deep that goes wrong? Well, some engines can help you with that. Personally I used <a href="http://www.rocechess.ch/rocee.html">ROCE</a> (Roman’s Own Chess Engine). His engine has a “divide” function. First you set the board in a certain position using the FEN, and then you call the divide function, for example “divide 6”. Now it shows a table like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">move : nodes
    e2e4 1249
    e2e3 2356
    f2f3 5356
    f2f4 6436
    (etc)</code></pre></figure>

<p>This lists each node at level 1, and after that each number of nodes it results in at depth 6. If you also have this function in your own chess engine you can compare the numbers. Now you can pinpoint which of the first nodes contains the error. Do this move and try divide 5. This will guide you all the way to the specific move that is (or isn’t) created! This was a huge help, and I love the way chess engine developers devised a way to have a kind of universal integration-tests which will point out the most commonly made bugs. You can take these tables, load them in a automatic test and keep running them every nights to see if things are still working like it should.</p>

<p>How did my engine end up? Well, it worked perfect in the sense that it could generate all the good legal moves. Then I added a simple evaluation function and it could play chess. After that I implemented a simple search algorithm (<a href="http://en.wikipedia.org/wiki/Alpha-beta_pruning">alpha-beta</a> using <a href="http://en.wikipedia.org/wiki/Negamax">negamax</a>) and it could beat two simple other chess engines and myself. And of course, after a week, I lost interest again and writing a blogpost about it is usually the nail to the coffin of most of my projects.</p>

<p>So, what should I tackle next? I’m looking forward to having a new <a href="http://azspcs.net/">AZsPCs</a> competition, but I think this might take a while…</p>

<p><strong>Update:</strong> A couple of readers have pointed out that these tests are obviously not <em>unit tests</em>, but rather integration or acceptance tests. You are completely right. I’ve called them Unit tests because I used JUnit and they run in the automatic build. But they do test integration..!</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/02/unit-testing-a-chess-engine/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  
    <div class="post">
      <div class="post-thumbnail">
      	<a href="/blog/2011/01/exception-mailing/">
      	
      		<img class="post-thumbnail-img" src="/thumbnails/default.jpg"/>
    	
    	</a>
      </div>
  
      <div class="post-data">
    	  <h1 class="pag-post-title"><a href="/blog/2011/01/exception-mailing/">Exception mailing</a></h1>
      
        <p class="post-meta">
          <span class="date">
            Jan 6, 2011 00:36:51
          </span>
          - <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>

        <p>A couple of weeks ago our Scrum team was thinking about exception handling. We don’t use checked exceptions, since they are the embodiment of evil. So everything is translated into runtime exceptions whenever possible. But this is where the problems start: What do you do with the uncatched runtime exceptions?</p>

<h1 id="taking-it-one-step-further">Taking it one step further</h1>

<p>Most projects will decide to just write the exceptions to the console, maybe to a log file. In some cases there is specialized software which will analyze log files, detect stacktraces and act on them. We decided to create a fast specialized solution. We want to have a mailbox where all the runtime exceptions end up, including stacktrace, system properties, program properties and even a screenshot.</p>

<h2 id="catching-the-uncaught-exception">Catching the uncaught exception</h2>

<p>In Java you can set a exception handlers on Threads. You can set a handler on a Thread, but it is also possible to set a default exception handler. It is very easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUncaughtExceptionHandler</span> <span class="kd">implements</span> <span class="n">UncaughtExceptionHandler</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CustomUncaughtExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uncaughtException</span><span class="o">(</span><span class="kd">final</span> <span class="n">Thread</span> <span class="n">t</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do something here!    </span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>If an exception occurs, the uncaughtException method will be called. Then you can do anything you want with the throwable. As said before, we decided it is best for us that the application phones home and sends us an email with as much information as we can get.</p>

<h1 id="what-to-send">What to send?</h1>

<p>Our application is launched by JNLP and will run on several clients. We don’t have complete contol over these clients, so we want to include as much information as possible to solve possible bugs in the application. The more information we have about the runtime, the easier it might be to find the problem. We grab all (relevant) system properties and program properties we can get. Including usernames, machine details.</p>

<h2 id="creating-a-screenshot">Creating a screenshot</h2>

<p>In Java there are actually two methods of creating a screenshot. The first method is the easiest, using the Java Robot:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Robot</span> <span class="n">robot</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Robot</span><span class="o">();</span>
 
<span class="n">BufferedImage</span> <span class="n">screenShot</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="na">createScreenCapture</span><span class="o">(</span><span class="k">new</span> <span class="nf">Rectangle</span><span class="o">(</span><span class="n">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">()));</span></code></pre></figure>

<p>Very easy, but this can contain a LOT of information about the moment the exception occurs. It may provide valuable information. But we encountered a major security problem with the above method. Java will create an actual screenshot, the size of your application. But it doesn’t know if your application is currently the active window..! When we did tests we saw screenshots with Skype messages in screen and browsers being active… We can’t invade the lives of our users and send this information over the mail!</p>

<p>So I decided to search for something less invasive. The main frame of our application has a paint method, and most of the time this method can still be called if we have an exception. It is possible to create our own Graphics object and let the main frame paint itself into memory. So eventually I settled on the code below:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BufferedImage</span> <span class="nf">createScreenshot</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Try to repaint the main frame of our application:</span>
        <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BufferedImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">screenshotComponent</span><span class="o">.</span><span class="na">paintAll</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getGraphics</span><span class="o">());</span>
        <span class="c1">// We can&#39;t use Robot, it might capture a bit too much information</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Screen can&#39;t be captured, don&#39;t throw exception, else we&#39;ll end up in a loop :-)</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="mailing-the-exception">Mailing the exception</h2>

<p>The next step in our solution is sending an email with all the information. This is done using Java Mail, an API to send emails. More about sending emails from Java <a href="http://www.javaworld.com/jw-06-1999/jw-06-javamail.html?page=4">here</a>. In our case we create a pretty HTML email with all relevant information and three attachements:</p>

<ul>
  <li>Text file with all system properties</li>
  <li>Text file with the complete exception</li>
  <li>The image/screenshot</li>
</ul>

<p>To create the email it is easy to create MimeBodyParts which contain the text, the only part a bit more complicated it to add the screenshot inside the email, this can be done using:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">MimeBodyPart</span> <span class="nf">createImagePart</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedImage</span> <span class="n">screenshot</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
    
	<span class="k">if</span> <span class="o">(</span><span class="n">screenshot</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">MimeBodyPart</span> <span class="n">imagePart</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MimeBodyPart</span><span class="o">();</span>
	<span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">screenshot</span><span class="o">,</span> <span class="s">&quot;jpg&quot;</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioException</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Impossible to get the screenshot, return null and continue without it</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
    
	<span class="n">DataSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ByteArrayDataSource</span><span class="o">(</span><span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="s">&quot;image/jpeg&quot;</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setDataHandler</span><span class="o">(</span><span class="k">new</span> <span class="nf">DataHandler</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="s">&quot;screenshot.jpg&quot;</span><span class="o">);</span>
	<span class="n">imagePart</span><span class="o">.</span><span class="na">setContentID</span><span class="o">(</span><span class="s">&quot;&lt;screenshot&gt;&quot;</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">imagePart</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>The only non-obvious line in the code above is setting the ContentID, this can be used to refer to the image-data in case of an HTML email. In the main email content I added the following line:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">Screenshot: <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;/images/cid:screenshot&quot;</span> <span class="na">alt=</span><span class="s">&quot;Screenshot of the moment the exception occured.&quot;</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>The <em>src=”cid:screenshot”</em> will cause the email to show the screenshot embedded inside the email. This makes the exception-email look very pretty.</p>

<h1 id="even-more-in-the-future">Even more in the future…?</h1>

<p>With our current implementation we’ll be able to detect exceptions instantly (on every new email). Also we’ll have more information then just a stacktrace, we have a screenshot and some parameters/system properties which can help us re-create the situation.</p>

<p>To improve this even more I’m planning on adding a simple bounded FIFO queue. This queue will contain a list of actions performed by the user. These user-actions can be added automatically by using aspect oriented programming. For example annotating all the service methods. Everytime a service method is called we can add it to the bounded queue, which has a maximum of N elements, for example 20. If an exception occurs we print our the current queue, we can read the last N actions leading up to the exception. This too can be very helpful in re-creating the situation.</p>

<p>What more information could be useful in an debug email like this? How do you guys solve exception handling?</p>



        <p class="post-meta">
          <a class="post-comments" href="http://royvanrijn.com/blog/2011/01/exception-mailing/#disqus_thread">0 comments</a>
        </p>
      </div>
    </div>
  
    <hr/>
  

  <!-- Pagination -->
  
  <div class="pagination">
    <div class="pagination-center">
    
      <div class="pagination-item"><a href="/page/5">&laquo; Prev</a></div>
    

    
      
        <div class="pagination-item"><a href="/index.html">1</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/2">2</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/3">3</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/4">4</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/5">5</a></div>
      
    
      
        <div class="pagination-item"><b>6</b></div>
      
    
      
        <div class="pagination-item"><a href="/page/7">7</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/8">8</a></div>
      
    
      
        <div class="pagination-item"><a href="/page/9">9</a></div>
      
    

    
      <div class="pagination-item"><a href="/page/7">Next &raquo;</a></div>
    
    </div>
  </div>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-wrapper">
      
      <div class="footer-wrapper-content">
      
        <a href="https://www.linkedin.com/profile/view?id=10356027">
          <i class="svg-icon linkedin"></i>
        </a>
      
        <a href="http://stackoverflow.com/users/442274/roy-van-rijn">
          <i class="svg-icon stackoverflow"></i>
        </a>

        <a href="https://github.com/royvanrijn">
          <i class="svg-icon github"></i>
        </a>

        <a href="https://twitter.com/royvanrijn">
          <i class="svg-icon twitter"></i>
        </a>
          
        <a href="/feed/index.xml">
          <i class="svg-icon rss"></i>
        </a>
	  </div>
    
    </div>

  </div>
  
  <script>
  
  <!-- Google Analytics -->
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3219266-2', 'auto');
  ga('send', 'pageview');

  <!-- Disqus Comment Count -->
  var disqus_shortname = 'royvanrijn';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());

  </script>

</footer>


  </body>

</html>
