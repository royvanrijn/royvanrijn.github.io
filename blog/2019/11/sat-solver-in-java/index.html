<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SAT solving: Creating a solver in Java (part 2)</title>
  <meta name="description" content="This is the second blogpost in a series about SAT solving. Today we’re going to build a simple solver in Java.Before continuing, if you don’t know what a SAT...">
  
  <meta name="keywords" content="royvanrijn,programming,java,SAT,solving,java,solver,algorithm,">
  
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://royvanrijn.com/blog/2019/11/sat-solver-in-java/">
  <link rel="alternate" type="application/rss+xml" title="royvanrijn" href="https://royvanrijn.com/feed/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@royvanrijn" />
  <meta name="twitter:title" content="SAT solving: Creating a solver in Java (part 2)" />
  <meta name="twitter:description" content="This is the second blogpost in a series about SAT solving. Today we’re going to build a simple solver in Java.Before continuing, if you d..." />
  
  <meta name="twitter:image" content="http://www.royvanrijn.com/thumbnails/default.jpg"/>
  

<script>
  <!-- Google Analytics -->
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3219266-1', 'auto');
  ga('send', 'pageview');

  <!-- Disqus Comment Count -->
  var disqus_shortname = 'royvanrijn';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

	<a class="site-title" href="/">
	  <img src="/images/header_royvanrijn.jpg" alt="royvanrijn" width="990" height="307"/>
    </a>

    <nav class="site-nav">

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    
    <div class="page-navigation"> 
      <div class="left"> 
         
          <a href="/blog/2019/05/sat-solving-part-one/" title="Previous: SAT solving: Introduction to SAT (part 1)">&laquo; SAT solving: Introduction to SAT (part 1)</a> 
         
      </div> 
      <div class="right"> 
         
      </div> 
      <div class="clear"></div> 
    </div> 
  </header>

  <article itemscope itemtype="http://schema.org/Article" class="post-content">
    <div class="post">
      <div class="post-thumbnail">
        <a itemprop="mainEntityOfPage" href="/blog/2019/11/sat-solver-in-java/" title="SAT solving: Creating a solver in Java (part 2)">
        
          <img itemprop="image" class="post-thumbnail-img" src="/thumbnails/default.jpg" alt="SAT solving: Creating a solver in Java (part 2)" width="100" height="100"/>
        
      </a>
      </div>
      <p class="post-meta">
        Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roy van Rijn</span></span> (<span itemprop="publisher" itemscope itemtype="http://schema.org/Person"><span itemprop="name">royvanrijn.com</span></span>) on 
        <span itemprop="dateModified" content="2019-11-11T21:42:12+01:00" class="date" />
        <span itemprop="datePublished" content="2019-11-11T21:42:12+01:00" class="date">
          Nov 11, 2019 21:42:12
        </span>
        : <a class="post-comments" href="https://royvanrijn.com/blog/2019/11/sat-solver-in-java/#disqus_thread">0 comments</a>
      </p>
      <h1 itemprop="headline" class="post-title">SAT solving: Creating a solver in Java (part 2)</h1>
    </div>

    <span itemprop="articleBody">
    <p>This is the second blogpost in a series about SAT solving. Today we’re going to build a simple solver in <code class="highlighter-rouge">Java</code>.
Before continuing, if you don’t know what a SAT solver is, read [part one][].</p>

<p>The algorithm we’re going to implement is called <a href="https://en.wikipedia.org/wiki/DPLL_algorithm">DPLL</a> (Davis Putnam Logemann Loveland).</p>

<h1 id="input-parsing">Input parsing</h1>

<p>The input we’ll accept is in <code class="highlighter-rouge">DIMACS</code> format. For now we can just skip the <code class="highlighter-rouge">p</code>-line with all the settings and just parse all the numbers.
Here is an example input:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">p</span> <span class="n">cnf</span> <span class="mi">3</span> <span class="mi">4</span>
 <span class="mi">1</span>  <span class="mi">2</span> <span class="o">-</span><span class="mi">3</span>  <span class="mi">0</span>
 <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">0</span>
<span class="o">-</span><span class="mi">2</span>  <span class="mi">0</span>
<span class="o">-</span><span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">0</span></code></pre></figure>

<p>In Java we can parse this entire file with almost a one liner (don’t do this in production code):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">        <span class="c1">// Read a DIMACS file and turn into a list of clauses:</span>
        <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">clauses</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inputFile</span><span class="o">))</span>
                <span class="c1">// Trim the lines:</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">,</span> <span class="s">" "</span><span class="o">).</span><span class="na">trim</span><span class="o">())</span>
                <span class="c1">// Only parse lines ending with a 0:</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">" 0"</span><span class="o">))</span>
                <span class="c1">// Turn each line into a list of integers:</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">line</span>
                        <span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">line</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Integer:</span><span class="o">:</span><span class="n">parseInt</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>
                <span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span></code></pre></figure>

<h1 id="unit-propagation">Unit propagation</h1>

<p>The next step in creating a (slow) SAT solver is to implement the following pseudo code:</p>

<h2 id="step-1a-find-all-the-unit-variables">Step 1a: Find all the unit variables</h2>

<p>Find all the unit variables <code class="highlighter-rouge">(-4 0)</code>. These are clauses that have just a single (active) variable. If a clause has just a single variable, it has to be true. So in this case we mark <code class="highlighter-rouge">4</code> as false.</p>

<h2 id="step-1b-process-all-unit-variables">Step 1b: Process all unit variables</h2>

<p>Now we go over all the other clauses that contain this variable <code class="highlighter-rouge">-4</code> or the inverse (<code class="highlighter-rouge">4</code>).</p>

<p>If the clause has <code class="highlighter-rouge">-4</code> (which we now know is <code class="highlighter-rouge">true</code>), we mark this entire clause as ‘satisfied’.</p>

<p>If the clause contains the inverse of the variable, in this case <code class="highlighter-rouge">4</code>, we know that particular variable will never become <code class="highlighter-rouge">true</code>, so we remove it from the list.</p>

<p>Lets try step 1 with the following example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"> <span class="mi">1</span>  <span class="mi">4</span>  <span class="mi">2</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span>
 <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">0</span>
<span class="o">-</span><span class="mi">2</span>  <span class="mi">0</span>
<span class="o">-</span><span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">5</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="mi">4</span> <span class="o">-</span><span class="mi">5</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span></code></pre></figure>

<p>We have a single unit variable, <code class="highlighter-rouge">-2</code>, so we mark this variable as <code class="highlighter-rouge">true</code>. Next we apply step 1b:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nl">Known:</span> <span class="o">-</span><span class="mi">2</span>

<span class="o">[</span><span class="mi">1</span>  <span class="mi">4</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span><span class="o">]</span> <span class="nl">becomes:</span> <span class="o">[</span><span class="mi">1</span> <span class="mi">4</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">0</span><span class="o">]</span> <span class="nl">becomes:</span> <span class="o">[</span><span class="mi">3</span> <span class="mi">0</span><span class="o">]</span>
<span class="o">[-</span><span class="mi">2</span>  <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="o">-</span><span class="mi">2</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">5</span> <span class="mi">0</span><span class="o">]</span> <span class="n">stays</span> <span class="n">the</span> <span class="nl">same:</span> <span class="o">[-</span><span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">5</span> <span class="mi">0</span><span class="o">]</span>
<span class="o">[-</span><span class="mi">2</span> <span class="o">-</span><span class="mi">4</span> <span class="o">-</span><span class="mi">5</span> <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="o">-</span><span class="mi">2</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span><span class="o">]</span> <span class="n">stays</span> <span class="n">the</span> <span class="nl">same:</span> <span class="o">[-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span><span class="o">]</span></code></pre></figure>

<p>Now we have a new unit variable, <code class="highlighter-rouge">3 0</code>. This again can be processed:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nl">Known:</span> <span class="o">-</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span>

<span class="o">[</span><span class="mi">1</span> <span class="mi">4</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span><span class="o">]</span> <span class="nl">becomes:</span> <span class="o">[</span><span class="mi">1</span> <span class="mi">4</span> <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">3</span>  <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="mi">3</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">2</span>  <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="o">-</span><span class="mi">2</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">5</span> <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="mi">3</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">2</span> <span class="o">-</span><span class="mi">4</span> <span class="o">-</span><span class="mi">5</span> <span class="mi">0</span><span class="o">]</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="o">-</span><span class="mi">2</span><span class="o">)</span>
<span class="o">[-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span><span class="o">]</span> <span class="n">stays</span> <span class="n">the</span> <span class="nl">same:</span> <span class="o">[-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span><span class="o">]</span></code></pre></figure>

<p>And now we are done with the <code class="highlighter-rouge">unit propagation</code>. We are now left with two clauses that both are not a unit clause.</p>

<h2 id="step-2-gamble-on-a-variable">Step 2: Gamble on a variable</h2>

<p>First we repeat step 1 until there are no unit clauses left. Now we need to take a gamble. In this case we have unresolved: -1, 1, 4 and -6, 6. We need to pick one of these and try it.</p>

<p>Let’s pick <code class="highlighter-rouge">6</code>.</p>

<p>Again, we process this, if a clause contains <code class="highlighter-rouge">6</code> we mark it as <code class="highlighter-rouge">true</code>. If a clause contains <code class="highlighter-rouge">-6</code> we remove that variable as alive variable.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nl">Known:</span> <span class="o">-</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span>

 <span class="mi">1</span>  <span class="mi">4</span>  <span class="o">-</span><span class="mi">6</span> <span class="mi">0</span> <span class="nl">becomes:</span> <span class="mi">1</span> <span class="mi">4</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">1</span>  <span class="mi">6</span>  <span class="mi">0</span> <span class="n">is</span> <span class="n">marked</span> <span class="nf">true</span> <span class="o">(</span><span class="n">contains</span> <span class="mi">6</span><span class="o">)</span></code></pre></figure>

<p>Now we go back to step 1 and repeat.</p>

<h2 id="conflict">Conflict</h2>

<p>There are two possible ways this loop will end.</p>

<p>1) There are no clauses left, everything it <code class="highlighter-rouge">true</code>. In this case we have reached <code class="highlighter-rouge">SAT</code>.
2) We run into a situation that we have a conflict (!)</p>

<p>A conflict happens when we have a situation that can’t happen. For example when we have the following situation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">-</span><span class="mi">1</span>  <span class="mi">0</span>
 <span class="mi">1</span> <span class="o">-</span><span class="mi">2</span>  <span class="mi">0</span>
 <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">0</span></code></pre></figure>

<p>In this case we have <code class="highlighter-rouge">-1</code> as a unit clause, we assign this variable. Now we process the following lines and what happens? We are left with:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"> <span class="o">-</span><span class="mi">2</span>  <span class="mi">0</span>
  <span class="mi">2</span>  <span class="mi">0</span></code></pre></figure>

<p>This is a <strong>conflict</strong>, we can’t have <code class="highlighter-rouge">-2</code> AND <code class="highlighter-rouge">2</code>. It can’t be true and false at the same time.</p>

<p>In the case of a conflict we backtrack back to the last decision point where we gambled. Reset everything and try a different variable.</p>

<h2 id="nothing-left-to-gamble-unsat">Nothing left to gamble? UNSAT</h2>

<p>If, at a certain point, you’ve run out of options to gamble on, we are also done. We’ve proven there is <strong>no</strong> way to assign the variables to satisfy all the clauses. In this case we can return <code class="highlighter-rouge">UNSAT</code>.</p>

<h1 id="put-this-into-code">Put this into code:</h1>

<p>If you put the above algorithm into Java code you might end up with something like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">royvanrijn</span><span class="o">.</span><span class="na">boolish</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DPLLSolver</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">DPLLSolver</span><span class="o">().</span><span class="na">solve</span><span class="o">(</span><span class="s">"dimacs/example.cnf"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">solve</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">inputFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">// Read a DIMACS file and turn into a list of clauses:</span>
        <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Clause</span><span class="o">&gt;</span> <span class="n">clauses</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inputFile</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">,</span> <span class="s">" "</span><span class="o">).</span><span class="na">trim</span><span class="o">())</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">" 0"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Clause:</span><span class="o">:</span><span class="k">new</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">literals</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="n">processDPLL</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">literals</span><span class="o">);</span>

        <span class="c1">// If we get here, we are unable to assign SAT, so we are UNSAT:</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Got to the end, UNSAT"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processDPLL</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Clause</span><span class="o">&gt;</span> <span class="n">clauses</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">literals</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// Check if we have no more clauses that are unsatisfied:</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">clauses</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">clause</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span><span class="o">).</span><span class="na">findAny</span><span class="o">().</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// We are done, SAT!</span>
            <span class="n">exitWithSAT</span><span class="o">(</span><span class="n">literals</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">newLiterals</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// Step 1a: Find unit clauses:</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unitPropagation</span> <span class="o">=</span> <span class="n">findUnitClauses</span><span class="o">(</span><span class="n">clauses</span><span class="o">);</span>

        <span class="c1">// Step 1b: Process the unit variables (new units can be created while processing):</span>
        <span class="k">while</span><span class="o">(</span><span class="n">unitPropagation</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>

            <span class="c1">// Remove this unit from all clauses:</span>
            <span class="k">for</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">unit</span> <span class="o">:</span> <span class="n">unitPropagation</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Detect conflicts: We can not have both unit and -unit in the set, if there is we've hit a conflict.</span>
                <span class="k">if</span><span class="o">(</span><span class="n">unitPropagation</span><span class="o">.</span><span class="na">contains</span><span class="o">(-</span><span class="n">unit</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Undo everything we've done and return.</span>
                    <span class="k">for</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">literal</span> <span class="o">:</span> <span class="n">newLiterals</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Undo unit: "</span> <span class="o">+</span> <span class="n">literal</span><span class="o">);</span>
                        <span class="n">undoStep</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">literal</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">newLiterals</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">unit</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Applying unit: "</span> <span class="o">+</span> <span class="n">unit</span><span class="o">);</span>
                <span class="n">applyStep</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">unit</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">unitPropagation</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">newLiterals</span><span class="o">);</span>

            <span class="c1">// Look if we've created new unit clauses:</span>
            <span class="n">unitPropagation</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">findUnitClauses</span><span class="o">(</span><span class="n">clauses</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// Get all the unassignedLiterals from the alive clauses:</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unassignedLiterals</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">clause</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span><span class="o">)</span>
                <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">clause</span> <span class="o">-&gt;</span> <span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">stream</span><span class="o">()).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>

        <span class="k">for</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">decisionLiteral</span> <span class="o">:</span> <span class="n">unassignedLiterals</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Gambling/deciding on: "</span> <span class="o">+</span> <span class="n">decisionLiteral</span><span class="o">);</span>
            <span class="n">applyStep</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">decisionLiteral</span><span class="o">);</span>

            <span class="c1">// Go deeper with a fresh list:</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">deeperAssignedLiterals</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
            <span class="n">deeperAssignedLiterals</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">literals</span><span class="o">);</span>
            <span class="n">deeperAssignedLiterals</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">newLiterals</span><span class="o">);</span>
            <span class="n">deeperAssignedLiterals</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">decisionLiteral</span><span class="o">);</span>

            <span class="n">processDPLL</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">deeperAssignedLiterals</span><span class="o">);</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Undo gambling: "</span> <span class="o">+</span> <span class="n">decisionLiteral</span><span class="o">);</span>
            <span class="n">undoStep</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">decisionLiteral</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Undo all we've done this step:</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">literal</span> <span class="o">:</span> <span class="n">newLiterals</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Undo units: "</span> <span class="o">+</span> <span class="n">literal</span><span class="o">);</span>
            <span class="n">undoStep</span><span class="o">(</span><span class="n">clauses</span><span class="o">,</span> <span class="n">literal</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * When applying a step, keep all the dead literals (variables) so we can undo.
     *
     * @param clauses
     * @param literal
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyStep</span><span class="o">(</span><span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Clause</span><span class="o">&gt;</span> <span class="n">clauses</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">literal</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Clause</span> <span class="n">clause</span> <span class="o">:</span> <span class="n">clauses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">literal</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">contains</span><span class="o">(-</span><span class="n">literal</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">remove</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="o">(-</span><span class="n">literal</span><span class="o">));</span>
                    <span class="n">clause</span><span class="o">.</span><span class="na">deadLiterals</span><span class="o">.</span><span class="na">add</span><span class="o">(-</span><span class="n">literal</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Because we are backtracking we need to be able to undo all the steps in a clause, so we keep all the information
     *
     * @param clauses
     * @param literal
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">undoStep</span><span class="o">(</span><span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Clause</span><span class="o">&gt;</span> <span class="n">clauses</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">literal</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Clause</span> <span class="n">clause</span> <span class="o">:</span> <span class="n">clauses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span> <span class="o">&amp;&amp;</span> <span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">literal</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">clause</span><span class="o">.</span><span class="na">clauseSatisfied</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">deadLiterals</span><span class="o">.</span><span class="na">contains</span><span class="o">(-</span><span class="n">literal</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">clause</span><span class="o">.</span><span class="na">deadLiterals</span><span class="o">.</span><span class="na">remove</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="o">(-</span><span class="n">literal</span><span class="o">));</span>
                <span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">add</span><span class="o">(-</span><span class="n">literal</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">findUnitClauses</span><span class="o">(</span><span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Clause</span><span class="o">&gt;</span> <span class="n">clauses</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unitPropagation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// Check if there are unit clauses:</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Clause</span> <span class="n">clause</span> <span class="o">:</span> <span class="n">clauses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">isUnitClause</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">unitPropagation</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clause</span><span class="o">.</span><span class="na">unassignedLiterals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">unitPropagation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">exitWithSAT</span><span class="o">(</span><span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">literals</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We are done:</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SAT"</span><span class="o">);</span>

        <span class="c1">// Sort the output as absolute values.</span>
        <span class="nc">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">literals</span><span class="o">,</span> <span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="nl">Math:</span><span class="o">:</span><span class="n">abs</span><span class="o">));</span>

        <span class="c1">// TODO: We might not list all the input variables here, some are not needed and can be + or -.</span>

        <span class="c1">// And print:</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">literals</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">n</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">" "</span><span class="o">))</span> <span class="o">+</span> <span class="s">" 0"</span><span class="o">);</span>

        <span class="c1">// Bye bye.</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Clause</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unassignedLiterals</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">deadLiterals</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">clauseSatisfied</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">Clause</span><span class="o">(</span><span class="nc">String</span> <span class="n">inputLine</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">unassignedLiterals</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span>
                    <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">inputLine</span>
                            <span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">inputLine</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Integer:</span><span class="o">:</span><span class="n">parseInt</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="nf">isUnitClause</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">!</span><span class="n">clauseSatisfied</span> <span class="o">&amp;&amp;</span> <span class="n">unassignedLiterals</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>This is all. This algorithm can solve <strong>any</strong> problem that can be turned into a SAT problem, which are a lot of mathematical problems.</p>

<p><code class="highlighter-rouge">DPPL</code> isn’t the fastest algorithm, a lot of improvements can be made (part 3?). For example we can learn new clauses during analysis, and instead of backtracking to the last decision moment, sometimes you can backtrack to a much earlier decision moment, making the resolution much faster.</p>

<p>But the basic algorithm to solve SAT, is very simple indeed.</p>

<p><a href="/blog/2019/05/sat-solving-part-one/">part one</a></p>

    </span>
    
  </article>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
      this.page.url = "https://royvanrijn.com/blog/2019/11/sat-solver-in-java/";
      this.page.identifier = "/blog/2019/11/sat-solver-in-java/";
    };

    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = 'https://royvanrijn.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-wrapper">
      
      <div class="footer-wrapper-content">
      
        <a href="https://www.linkedin.com/profile/view?id=10356027">
          <span class="svg-icon linkedin">Connect on LinkedIn</span>
        </a>
      
        <a href="http://stackoverflow.com/users/442274/roy-van-rijn">
          <span class="svg-icon stackoverflow">Follow me on StackOverflow</span>
        </a>

        <a href="https://github.com/royvanrijn">
          <span class="svg-icon github">Follow me on GitHub</span>
        </a>

        <a href="https://twitter.com/royvanrijn">
          <ispan class="svg-icon twitter">Follow me on Twitter</span>
        </a>
          
        <a href="/feed/index.xml">
          <span class="svg-icon rss">Check out the RSS feed</span>
        </a>
	  </div>
    
    </div>

  </div>

</footer>


  </body>

</html>
